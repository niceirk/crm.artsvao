# –ú–æ–¥—É–ª—å 7: –ü–ª–∞—Ç–µ–∂–∏ (Payments)

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-17
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ 90%
**–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏:** [–°—á–µ—Ç–∞](./05_INVOICES_MODULE.md), [–ö–ª–∏–µ–Ω—Ç—ã](./01_CLIENTS_CRM_MODULE.md), [–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã](./06_SUBSCRIPTIONS_MODULE.md)

---

## üìã –û–±–∑–æ—Ä –º–æ–¥—É–ª—è

–ú–æ–¥—É–ª—å –ø–ª–∞—Ç–µ–∂–µ–π –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ –¥–µ–Ω–µ–∂–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –≤ —Å–∏—Å—Ç–µ–º–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–æ–≤ —Å—á–µ—Ç–æ–≤, –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Å—É–º–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π** —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å—á–µ—Ç–∞–º
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å—á–µ—Ç–æ–≤** (PAID/PARTIALLY_PAID/PENDING)
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º** (–ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–µ–ø–æ–≥–∞—à–µ–Ω–Ω—É—é —Å—É–º–º—É —Å—á–µ—Ç–∞)
- ‚úÖ **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã** (–ù–∞–ª–∏—á–Ω—ã–µ, –ö–∞—Ä—Ç–∞, –û–Ω–ª–∞–π–Ω)
- ‚úÖ **–¢–∏–ø—ã –ø–ª–∞—Ç–µ–∂–µ–π** (–ê–±–æ–Ω–µ–º–µ–Ω—Ç, –ê—Ä–µ–Ω–¥–∞, –†–∞–∑–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ)
- ‚úÖ **–°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π** (–û–∂–∏–¥–∞–Ω–∏–µ, –ó–∞–≤–µ—Ä—à–µ–Ω, –ù–µ—É–¥–∞—á–∞, –í–æ–∑–≤—Ä–∞—Ç)
- ‚úÖ **–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π** –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º –∏ —Å—á–µ—Ç–∞–º
- ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—è** –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ **–†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞ –∫ –æ–ø–ª–∞—Ç–µ** –¥–ª—è —Å—á–µ—Ç–æ–≤
- ‚ö†Ô∏è **–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞—Ç–µ–∂–∞** (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
- ‚ö†Ô∏è **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã** –≤ UI (API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –ú–æ–¥–µ–ª—å: Payment

**–§–∞–π–ª:** `backend/prisma/schema.prisma` (—Å—Ç—Ä–æ–∫–∏ 372-397)

```prisma
model Payment {
  id             String        @id @default(uuid())
  clientId       String        @map("client_id")
  amount         Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod @map("payment_method")
  paymentType    PaymentType   @map("payment_type")
  status         PaymentStatus @default(PENDING)
  transactionId  String?       @map("transaction_id")
  subscriptionId String?       @map("subscription_id")
  rentalId       String?       @map("rental_id")
  invoiceId      String?       @map("invoice_id")
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  client         Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoice        Invoice?      @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  rental         Rental?       @relation(fields: [rentalId], references: [id], onDelete: SetNull)
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  // Indexes –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  @@index([clientId])
  @@index([invoiceId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentType])
  @@map("payments")
}
```

### Enums

```prisma
enum PaymentMethod {
  CASH   // –ù–∞–ª–∏—á–Ω—ã–µ
  CARD   // –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ (—Ç–µ—Ä–º–∏–Ω–∞–ª)
  ONLINE // –û–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂
}

enum PaymentType {
  SUBSCRIPTION // –û–ø–ª–∞—Ç–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞
  RENTAL       // –û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã
  SINGLE_VISIT // –†–∞–∑–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ
}

enum PaymentStatus {
  PENDING   // –û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  COMPLETED // –ó–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ
  FAILED    // –ù–µ—É–¥–∞—á–∞
  REFUNDED  // –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
}
```

### –°–≤—è–∑–∏

- **Client** (Many-to-One): –ö–ª–∏–µ–Ω—Ç, —Å–æ–≤–µ—Ä—à–∏–≤—à–∏–π –ø–ª–∞—Ç–µ–∂
- **Invoice** (Many-to-One): –°—á–µ—Ç, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω –ø–ª–∞—Ç–µ–∂
- **Subscription** (Many-to-One, optional): –ê–±–æ–Ω–µ–º–µ–Ω—Ç (–¥–ª—è backward compatibility)
- **Rental** (Many-to-One, optional): –ê—Ä–µ–Ω–¥–∞ (–¥–ª—è backward compatibility)

---

## üîå Backend API

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª—è

**–§–∞–π–ª—ã:**
```
backend/src/payments/
‚îú‚îÄ‚îÄ payments.module.ts          (12 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ payments.controller.ts      (54 —Å—Ç—Ä–æ–∫–∏)
‚îú‚îÄ‚îÄ payments.service.ts         (335 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ dto/
    ‚îú‚îÄ‚îÄ create-payment.dto.ts   (50 —Å—Ç—Ä–æ–∫)
    ‚îú‚îÄ‚îÄ update-payment.dto.ts   (16 —Å—Ç—Ä–æ–∫)
    ‚îî‚îÄ‚îÄ payment-filter.dto.ts   (53 —Å—Ç—Ä–æ–∫–∏)
```

**–í—Å–µ–≥–æ:** 518 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

### Endpoints

#### 1. POST /payments
**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞**

**Guards:** `JwtAuthGuard`
**Body:** `CreatePaymentDto`

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```typescript
{
  "clientId": "uuid",
  "invoiceId": "uuid",
  "amount": 5000.00,
  "paymentMethod": "CASH",
  "paymentType": "SUBSCRIPTION",
  "subscriptionId": "uuid", // optional
  "notes": "–û–ø–ª–∞—Ç–∞ –∑–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ —è–Ω–≤–∞—Ä—å"
}
```

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å—á–µ—Ç–∞ –∏ –µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
3. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã (–Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–µ–ø–æ–≥–∞—à–µ–Ω–Ω—É—é —Å—É–º–º—É —Å—á–µ—Ç–∞)
4. –î–ª—è CASH - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ COMPLETED
5. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å include –≤—Å–µ—Ö relations
6. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å—á–µ—Ç–∞** (PAID/PARTIALLY_PAID)

**–û—Ç–≤–µ—Ç:**
```typescript
{
  "id": "uuid",
  "clientId": "uuid",
  "invoiceId": "uuid",
  "amount": 5000.00,
  "paymentMethod": "CASH",
  "paymentType": "SUBSCRIPTION",
  "status": "COMPLETED",
  "createdAt": "2025-11-17T10:00:00Z",
  "updatedAt": "2025-11-17T10:00:00Z",
  "client": { ... },
  "invoice": { ... },
  "subscription": { ... }
}
```

#### 2. GET /payments
**–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π**

**Guards:** `JwtAuthGuard`
**Query Parameters:** `PaymentFilterDto`

**–§–∏–ª—å—Ç—Ä—ã:**
- `clientId`: UUID –∫–ª–∏–µ–Ω—Ç–∞
- `invoiceId`: UUID —Å—á–µ—Ç–∞
- `subscriptionId`: UUID –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞
- `rentalId`: UUID –∞—Ä–µ–Ω–¥—ã
- `paymentMethod`: CASH | CARD | ONLINE
- `paymentType`: SUBSCRIPTION | RENTAL | SINGLE_VISIT
- `status`: PENDING | COMPLETED | FAILED | REFUNDED
- `dateFrom`: ISO date (–Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞)
- `dateTo`: ISO date (–∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞)
- `page`: –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (default: 1)
- `limit`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (default: 10)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```
GET /payments?status=COMPLETED&page=1&limit=20
```

**–û—Ç–≤–µ—Ç:**
```typescript
{
  "data": [
    {
      "id": "uuid",
      "amount": 5000.00,
      "paymentMethod": "CASH",
      "status": "COMPLETED",
      "client": { "id": "...", "firstName": "...", "lastName": "..." },
      "invoice": { "id": "...", "invoiceNumber": "..." },
      ...
    }
  ],
  "meta": {
    "total": 150,
    "page": 1,
    "limit": 20,
    "totalPages": 8
  }
}
```

#### 3. GET /payments/:id
**–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ ID**

**Guards:** `JwtAuthGuard`
**Params:** UUID –ø–ª–∞—Ç–µ–∂–∞

**–û—Ç–≤–µ—Ç:** –û–±—ä–µ–∫—Ç –ø–ª–∞—Ç–µ–∂–∞ —Å include –≤—Å–µ—Ö relations

#### 4. PATCH /payments/:id
**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã)**

**Guards:** `JwtAuthGuard`, `AdminGuard`
**Body:** `UpdatePaymentDto`

**–û–±–Ω–æ–≤–ª—è–µ–º—ã–µ –ø–æ–ª—è:**
- `status`: PENDING | COMPLETED | FAILED | REFUNDED
- `transactionId`: —Å—Ç—Ä–æ–∫–∞ (–¥–ª—è –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂–µ–π)
- `notes`: —Å—Ç—Ä–æ–∫–∞

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ COMPLETED - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ REFUNDED - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞ (–ø–µ—Ä–µ—Å—á–µ—Ç)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updatedAt`

#### 5. DELETE /payments/:id
**–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã)**

**Guards:** `JwtAuthGuard`, `AdminGuard`

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
- –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø–ª–∞—Ç–µ–∂–µ
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å—á–µ—Ç–∞**

---

## üíº –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (PaymentsService)

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### `create(data: CreatePaymentDto)`
–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞:**
   ```typescript
   const client = await this.prisma.client.findUnique({ where: { id: clientId } });
   if (!client) throw new NotFoundException('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
   ```

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—á–µ—Ç–∞:**
   ```typescript
   const invoice = await this.prisma.invoice.findUnique({ where: { id: invoiceId } });
   if (!invoice) throw new NotFoundException('–°—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
   if (invoice.status === 'CANCELLED') throw new BadRequestException('–ù–µ–ª—å–∑—è –æ–ø–ª–∞—Ç–∏—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–π —Å—á–µ—Ç');
   ```

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã:**
   ```typescript
   const totalPaid = await this.calculateTotalPaid(invoiceId);
   const unpaidAmount = invoice.totalAmount - totalPaid;

   if (amount > unpaidAmount) {
     throw new BadRequestException(
       `–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (${amount}) –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–µ–ø–æ–≥–∞—à–µ–Ω–Ω—É—é —Å—É–º–º—É —Å—á–µ—Ç–∞ (${unpaidAmount})`
     );
   }
   ```

4. **–ê–≤—Ç–æ—Å—Ç–∞—Ç—É—Å –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö:**
   ```typescript
   if (paymentMethod === 'CASH') {
     data.status = PaymentStatus.COMPLETED;
   }
   ```

5. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**
   ```typescript
   const payment = await this.prisma.payment.create({
     data: {
       ...data,
       createdAt: new Date(),
       updatedAt: new Date(),
     },
     include: {
       client: true,
       invoice: true,
       subscription: true,
       rental: true,
     },
   });
   ```

6. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞:**
   ```typescript
   await this.updateInvoiceStatus(invoiceId);
   ```

#### `calculateTotalPaid(invoiceId: string): Promise<number>`
–†–∞—Å—á–µ—Ç –æ–±—â–µ–π –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π —Å—É–º–º—ã –¥–ª—è —Å—á–µ—Ç–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```typescript
const result = await this.prisma.payment.aggregate({
  where: {
    invoiceId,
    status: PaymentStatus.COMPLETED, // –¢–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
  },
  _sum: {
    amount: true,
  },
});

return Number(result._sum.amount || 0);
```

#### `updateInvoiceStatus(invoiceId: string): Promise<void>`
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å—á–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–∞—Ç–µ–∂–µ–π

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```typescript
const invoice = await this.prisma.invoice.findUnique({
  where: { id: invoiceId }
});
const totalPaid = await this.calculateTotalPaid(invoiceId);
const totalAmount = Number(invoice.totalAmount);

let newStatus: InvoiceStatus;
let paidAt: Date | null = null;

if (totalPaid >= totalAmount) {
  newStatus = InvoiceStatus.PAID;
  paidAt = new Date(); // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –æ–ø–ª–∞—Ç—ã
} else if (totalPaid > 0) {
  newStatus = InvoiceStatus.PARTIALLY_PAID;
} else {
  newStatus = InvoiceStatus.PENDING;
}

await this.prisma.invoice.update({
  where: { id: invoiceId },
  data: {
    status: newStatus,
    paidAt: paidAt,
  },
});
```

**–õ–æ–≥–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤:**
- `PAID`: totalPaid >= totalAmount (–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω)
- `PARTIALLY_PAID`: totalPaid > 0 && totalPaid < totalAmount
- `PENDING`: totalPaid === 0 (–Ω–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π)

#### `findAll(filter: PaymentFilterDto)`
–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π

**–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:**
```typescript
const where: Prisma.PaymentWhereInput = {
  ...(filter.clientId && { clientId: filter.clientId }),
  ...(filter.invoiceId && { invoiceId: filter.invoiceId }),
  ...(filter.subscriptionId && { subscriptionId: filter.subscriptionId }),
  ...(filter.rentalId && { rentalId: filter.rentalId }),
  ...(filter.paymentMethod && { paymentMethod: filter.paymentMethod }),
  ...(filter.paymentType && { paymentType: filter.paymentType }),
  ...(filter.status && { status: filter.status }),
  ...(filter.dateFrom || filter.dateTo) && {
    createdAt: {
      ...(filter.dateFrom && { gte: new Date(filter.dateFrom) }),
      ...(filter.dateTo && { lte: new Date(filter.dateTo) }),
    },
  },
};
```

**–ü–∞–≥–∏–Ω–∞—Ü–∏—è:**
```typescript
const page = filter.page || 1;
const limit = filter.limit || 10;
const skip = (page - 1) * limit;

const [data, total] = await Promise.all([
  this.prisma.payment.findMany({
    where,
    skip,
    take: limit,
    orderBy: { createdAt: 'desc' },
    include: { client: true, invoice: true, subscription: true, rental: true },
  }),
  this.prisma.payment.count({ where }),
]);

return {
  data,
  meta: {
    total,
    page,
    limit,
    totalPages: Math.ceil(total / limit),
  },
};
```

#### `update(id: string, data: UpdatePaymentDto)`
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—á–µ—Ç–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ COMPLETED –∏–ª–∏ REFUNDED - –ø–µ—Ä–µ—Å—á–µ—Ç —Å—á–µ—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `updatedAt`

#### `remove(id: string)`
–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—á–µ—Ç–∞

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```typescript
const payment = await this.prisma.payment.findUnique({ where: { id } });
if (!payment) throw new NotFoundException('–ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω');

const invoiceId = payment.invoiceId;

await this.prisma.payment.delete({ where: { id } });

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—á–µ—Ç–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
if (invoiceId) {
  await this.updateInvoiceStatus(invoiceId);
}
```

---

## üé® Frontend

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
frontend/
‚îú‚îÄ‚îÄ app/(dashboard)/payments/
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx                              (197 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ app/(dashboard)/invoices/[id]/components/
‚îÇ   ‚îî‚îÄ‚îÄ invoice-payments-section.tsx          (230 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ use-payments.ts                       (112 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ lib/api/
‚îÇ   ‚îî‚îÄ‚îÄ payments.ts                           (55 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ lib/types/
    ‚îî‚îÄ‚îÄ payments.ts                           (116 —Å—Ç—Ä–æ–∫)
```

**–í—Å–µ–≥–æ:** ~710 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞

### 1. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π

**–§–∞–π–ª:** `frontend/app/(dashboard)/payments/page.tsx`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
```tsx
export default function PaymentsPage() {
  const [statusFilter, setStatusFilter] = useState<PaymentStatus | 'all'>('all');
  const { data: paymentsData } = usePayments(
    statusFilter !== 'all' ? { status: statusFilter } : undefined
  );

  return (
    <div className="space-y-6">
      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold">–ü–ª–∞—Ç–µ–∂–∏</h1>
        <div className="text-sm text-muted-foreground">
          –í—Å–µ–≥–æ: {paymentsData?.meta.total || 0}
        </div>
      </div>

      {/* –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É */}
      <Select value={statusFilter} onValueChange={setStatusFilter}>
        <SelectTrigger className="w-[200px]">
          <SelectValue />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</SelectItem>
          <SelectItem value="PENDING">–û–∂–∏–¥–∞–Ω–∏–µ</SelectItem>
          <SelectItem value="COMPLETED">–ó–∞–≤–µ—Ä—à–µ–Ω</SelectItem>
          <SelectItem value="FAILED">–ù–µ—É–¥–∞—á–∞</SelectItem>
          <SelectItem value="REFUNDED">–í–æ–∑–≤—Ä–∞—Ç</SelectItem>
        </SelectContent>
      </Select>

      {/* –¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π */}
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>–î–∞—Ç–∞</TableHead>
            <TableHead>–ö–ª–∏–µ–Ω—Ç</TableHead>
            <TableHead>–°—á–µ—Ç</TableHead>
            <TableHead>–°—É–º–º–∞</TableHead>
            <TableHead>–ú–µ—Ç–æ–¥</TableHead>
            <TableHead>–¢–∏–ø</TableHead>
            <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {payments.map((payment) => (
            <TableRow key={payment.id}>
              <TableCell>
                {formatDistance(new Date(payment.createdAt), new Date(), {
                  addSuffix: true,
                  locale: ru,
                })}
              </TableCell>
              <TableCell>
                {payment.client.lastName} {payment.client.firstName}
                <br />
                <span className="text-sm text-muted-foreground">
                  {payment.client.phone}
                </span>
              </TableCell>
              <TableCell>
                {payment.invoice?.invoiceNumber}
                <br />
                <span className="text-sm text-muted-foreground">
                  {formatCurrency(payment.invoice?.totalAmount)}
                </span>
              </TableCell>
              <TableCell className="font-semibold">
                {formatCurrency(payment.amount)}
              </TableCell>
              <TableCell>
                <Badge variant="outline">
                  {PAYMENT_METHOD_LABELS[payment.paymentMethod]}
                </Badge>
              </TableCell>
              <TableCell>
                {PAYMENT_TYPE_LABELS[payment.paymentType]}
              </TableCell>
              <TableCell>
                <Badge variant={getStatusVariant(payment.status)}>
                  {PAYMENT_STATUS_LABELS[payment.status]}
                </Badge>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (formatDistance —Å ru locale)
- –¶–≤–µ—Ç–æ–≤—ã–µ badges –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã (RUB —Å 2 –¥–µ—Å—è—Ç–∏—á–Ω—ã–º–∏ –∑–Ω–∞–∫–∞–º–∏)
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—á–µ—Ç–∞

**–§–∞–π–ª:** `frontend/app/(dashboard)/invoices/[id]/components/invoice-payments-section.tsx`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `InvoicePaymentsSection`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
1. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–ø–ª–∞—Ç—ã:**
   ```tsx
   const totalPaid = payments
     .filter((p) => p.status === 'COMPLETED')
     .reduce((sum, p) => sum + Number(p.amount), 0);
   const unpaidAmount = Number(invoice.totalAmount) - totalPaid;

   <div className="space-y-2">
     <div className="flex justify-between text-sm">
       <span>–û–ø–ª–∞—á–µ–Ω–æ</span>
       <span className="font-medium">
         {formatCurrency(totalPaid)} –∏–∑ {formatCurrency(invoice.totalAmount)}
       </span>
     </div>
     <Progress value={(totalPaid / Number(invoice.totalAmount)) * 100} />
   </div>
   ```

2. **–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ:**
   ```tsx
   {unpaidAmount > 0 && (
     <Alert>
       <AlertCircle className="h-4 w-4" />
       <AlertTitle>–û—Å—Ç–∞—Ç–æ–∫ –∫ –æ–ø–ª–∞—Ç–µ</AlertTitle>
       <AlertDescription>
         {formatCurrency(unpaidAmount)}
       </AlertDescription>
     </Alert>
   )}
   ```

3. **–î–∏–∞–ª–æ–≥ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:**
   ```tsx
   <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>
     <DialogContent>
       <DialogHeader>
         <DialogTitle>–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</DialogTitle>
       </DialogHeader>
       <div className="space-y-4">
         <div>
           <Label>–°—É–º–º–∞</Label>
           <Input
             type="number"
             step="0.01"
             max={unpaidAmount}
             value={amount}
             onChange={(e) => setAmount(e.target.value)}
           />
           <p className="text-sm text-muted-foreground mt-1">
             –ú–∞–∫—Å–∏–º—É–º: {formatCurrency(unpaidAmount)}
           </p>
         </div>
         <div>
           <Label>–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã</Label>
           <Select value={method} onValueChange={setMethod}>
             <SelectItem value="CASH">–ù–∞–ª–∏—á–Ω—ã–µ</SelectItem>
             <SelectItem value="CARD">–ö–∞—Ä—Ç–∞</SelectItem>
             <SelectItem value="ONLINE">–û–Ω–ª–∞–π–Ω</SelectItem>
           </Select>
         </div>
       </div>
       <DialogFooter>
         <Button
           onClick={handleCreatePayment}
           disabled={!amount || Number(amount) > unpaidAmount}
         >
           –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
         </Button>
       </DialogFooter>
     </DialogContent>
   </Dialog>
   ```

4. **–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π:**
   ```tsx
   <Table>
     <TableHeader>
       <TableRow>
         <TableHead>–î–∞—Ç–∞</TableHead>
         <TableHead>–ú–µ—Ç–æ–¥</TableHead>
         <TableHead>–°—É–º–º–∞</TableHead>
         <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
       </TableRow>
     </TableHeader>
     <TableBody>
       {payments.map((payment) => (
         <TableRow key={payment.id}>
           <TableCell>
             {format(new Date(payment.createdAt), 'dd.MM.yyyy HH:mm', {
               locale: ru,
             })}
           </TableCell>
           <TableCell>
             <Badge variant="outline">
               {PAYMENT_METHOD_LABELS[payment.paymentMethod]}
             </Badge>
           </TableCell>
           <TableCell className="font-semibold">
             {formatCurrency(payment.amount)}
           </TableCell>
           <TableCell>
             <Badge variant={getStatusVariant(payment.status)}>
               {PAYMENT_STATUS_LABELS[payment.status]}
             </Badge>
           </TableCell>
         </TableRow>
       ))}
     </TableBody>
   </Table>
   ```

### 3. React Query —Ö—É–∫–∏

**–§–∞–π–ª:** `frontend/hooks/use-payments.ts`

**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ö—É–∫–∏:**

```typescript
// 1. –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
export function usePayments(filters?: PaymentFilterDto) {
  return useQuery({
    queryKey: ['payments', filters],
    queryFn: () => paymentsApi.getAll(filters),
  });
}

// 2. –û–¥–∏–Ω –ø–ª–∞—Ç–µ–∂ –ø–æ ID
export function usePayment(id: string) {
  return useQuery({
    queryKey: ['payments', id],
    queryFn: () => paymentsApi.getById(id),
    enabled: !!id,
  });
}

// 3. –ü–ª–∞—Ç–µ–∂–∏ –∫–ª–∏–µ–Ω—Ç–∞
export function useClientPayments(clientId: string) {
  return usePayments({ clientId });
}

// 4. –ü–ª–∞—Ç–µ–∂–∏ –ø–æ —Å—á–µ—Ç—É
export function useInvoicePayments(invoiceId: string) {
  return usePayments({ invoiceId });
}

// 5. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
export function useCreatePayment() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: paymentsApi.create,
    onSuccess: () => {
      // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
      queryClient.invalidateQueries({ queryKey: ['payments'] });
      queryClient.invalidateQueries({ queryKey: ['invoices'] });
      queryClient.invalidateQueries({ queryKey: ['clients'] });

      toast.success('–ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω');
    },
    onError: (error) => {
      toast.error(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
    },
  });
}

// 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
export function useUpdatePayment() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ id, data }: { id: string; data: UpdatePaymentDto }) =>
      paymentsApi.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['payments'] });
      queryClient.invalidateQueries({ queryKey: ['invoices'] });

      toast.success('–ü–ª–∞—Ç–µ–∂ –æ–±–Ω–æ–≤–ª–µ–Ω');
    },
    onError: (error) => {
      toast.error(error.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
    },
  });
}

// 7. –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
export function useDeletePayment() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: paymentsApi.delete,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['payments'] });
      queryClient.invalidateQueries({ queryKey: ['invoices'] });

      toast.success('–ü–ª–∞—Ç–µ–∂ —É–¥–∞–ª–µ–Ω');
    },
    onError: (error) => {
      toast.error(error.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞');
    },
  });
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ TypeScript

### 4. API Client

**–§–∞–π–ª:** `frontend/lib/api/payments.ts`

```typescript
import { apiClient } from './client';
import type {
  Payment,
  CreatePaymentDto,
  UpdatePaymentDto,
  PaymentFilterDto,
  PaginatedResponse,
} from '@/lib/types/payments';

export const paymentsApi = {
  // –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
  async create(data: CreatePaymentDto): Promise<Payment> {
    const response = await apiClient.post('/payments', data);
    return response.data;
  },

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
  async getAll(filter?: PaymentFilterDto): Promise<PaginatedResponse<Payment>> {
    const params = new URLSearchParams();
    if (filter) {
      Object.entries(filter).forEach(([key, value]) => {
        if (value !== undefined && value !== null) {
          params.append(key, String(value));
        }
      });
    }

    const response = await apiClient.get(`/payments?${params.toString()}`);
    return response.data;
  },

  // –ü–æ–ª—É—á–∏—Ç—å –ø–ª–∞—Ç–µ–∂ –ø–æ ID
  async getById(id: string): Promise<Payment> {
    const response = await apiClient.get(`/payments/${id}`);
    return response.data;
  },

  // –û–±–Ω–æ–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂
  async update(id: string, data: UpdatePaymentDto): Promise<Payment> {
    const response = await apiClient.patch(`/payments/${id}`, data);
    return response.data;
  },

  // –£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂
  async delete(id: string): Promise<void> {
    await apiClient.delete(`/payments/${id}`);
  },
};
```

### 5. TypeScript —Ç–∏–ø—ã

**–§–∞–π–ª:** `frontend/lib/types/payments.ts`

```typescript
// Enums
export type PaymentMethod = 'CASH' | 'CARD' | 'ONLINE';
export type PaymentType = 'SUBSCRIPTION' | 'RENTAL' | 'SINGLE_VISIT';
export type PaymentStatus = 'PENDING' | 'COMPLETED' | 'FAILED' | 'REFUNDED';

// –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å
export interface Payment {
  id: string;
  clientId: string;
  amount: number;
  paymentMethod: PaymentMethod;
  paymentType: PaymentType;
  status: PaymentStatus;
  transactionId?: string;
  subscriptionId?: string;
  rentalId?: string;
  invoiceId?: string;
  notes?: string;
  createdAt: string;
  updatedAt: string;

  // Relations
  client?: Client;
  invoice?: Invoice;
  subscription?: Subscription;
  rental?: Rental;
}

// DTOs
export interface CreatePaymentDto {
  clientId: string;
  invoiceId?: string;
  subscriptionId?: string;
  rentalId?: string;
  amount: number;
  paymentMethod: PaymentMethod;
  paymentType: PaymentType;
  transactionId?: string;
  notes?: string;
}

export interface UpdatePaymentDto {
  status?: PaymentStatus;
  transactionId?: string;
  notes?: string;
}

export interface PaymentFilterDto {
  clientId?: string;
  invoiceId?: string;
  subscriptionId?: string;
  rentalId?: string;
  paymentMethod?: PaymentMethod;
  paymentType?: PaymentType;
  status?: PaymentStatus;
  dateFrom?: string;
  dateTo?: string;
  page?: number;
  limit?: number;
}

// –ü–∞–≥–∏–Ω–∞—Ü–∏—è
export interface PaginatedResponse<T> {
  data: T[];
  meta: {
    total: number;
    page: number;
    limit: number;
    totalPages: number;
  };
}

// –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
export const PAYMENT_METHOD_LABELS: Record<PaymentMethod, string> = {
  CASH: '–ù–∞–ª–∏—á–Ω—ã–µ',
  CARD: '–ö–∞—Ä—Ç–∞',
  ONLINE: '–û–Ω–ª–∞–π–Ω',
};

export const PAYMENT_TYPE_LABELS: Record<PaymentType, string> = {
  SUBSCRIPTION: '–ê–±–æ–Ω–µ–º–µ–Ω—Ç',
  RENTAL: '–ê—Ä–µ–Ω–¥–∞',
  SINGLE_VISIT: '–†–∞–∑–æ–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ',
};

export const PAYMENT_STATUS_LABELS: Record<PaymentStatus, string> = {
  PENDING: '–û–∂–∏–¥–∞–Ω–∏–µ',
  COMPLETED: '–ó–∞–≤–µ—Ä—à–µ–Ω',
  FAILED: '–ù–µ—É–¥–∞—á–∞',
  REFUNDED: '–í–æ–∑–≤—Ä–∞—Ç',
};
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

### 1. –ú–æ–¥—É–ª—å –°—á–µ—Ç–æ–≤ (Invoices)

**–°–≤—è–∑—å:** Many-to-One (–º–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π –∫ –æ–¥–Ω–æ–º—É —Å—á–µ—Ç—É)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç `InvoicePaymentsSection` –≤—Å—Ç—Ä–æ–µ–Ω –≤ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—á–µ—Ç–∞
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å—á–µ—Ç–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞ –∫ –æ–ø–ª–∞—Ç–µ
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:**
- –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ Invoice
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ ‚Üí –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ Invoice
- –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ ‚Üí –ø–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ Invoice

### 2. –ú–æ–¥—É–ª—å –ö–ª–∏–µ–Ω—Ç–æ–≤ (Clients)

**–°–≤—è–∑—å:** Many-to-One (–º–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π –æ—Ç –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ `useClientPayments(clientId)`
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫–ª–∏–µ–Ω—Ç—É
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–ª–∞—Ç–µ–∂–µ–π

### 3. –ú–æ–¥—É–ª—å –ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ (Subscriptions)

**–°–≤—è–∑—å:** Many-to-One (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è backward compatibility)

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
- –ü–ª–∞—Ç–µ–∂–∏ –∑–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—á–µ—Ç–∞
- `subscriptionId` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è —Å–≤—è–∑–∏ —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–º
- `paymentType` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ SUBSCRIPTION

### 4. –ù–∞–≤–∏–≥–∞—Ü–∏—è

**–§–∞–π–ª:** `frontend/lib/config/navigation.ts`

```typescript
{
  title: '–ü–ª–∞—Ç–µ–∂–∏',
  href: '/payments',
  icon: CreditCard,
  description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏',
}
```

–ü—É–Ω–∫—Ç –º–µ–Ω—é –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –≤ —Ä–∞–∑–¥–µ–ª–µ "–ì–ª–∞–≤–Ω–æ–µ".

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –∑–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ö–ª–∏–µ–Ω—Ç –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —Å—á–µ—Ç –∑–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏

```typescript
// Frontend (–≤ InvoicePaymentsSection)
const { mutate: createPayment } = useCreatePayment();

const handleCreatePayment = () => {
  createPayment({
    clientId: invoice.clientId,
    invoiceId: invoice.id,
    subscriptionId: invoice.subscriptionId,
    amount: 5000.00,
    paymentMethod: 'CASH',
    paymentType: 'SUBSCRIPTION',
    notes: '–û–ø–ª–∞—Ç–∞ –∑–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–∞ —è–Ω–≤–∞—Ä—å 2025',
  });
};
```

**Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å—á–µ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã (5000 ‚â§ –Ω–µ–ø–æ–≥–∞—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ —Å—á–µ—Ç–∞)
3. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º COMPLETED (—Ç.–∫. CASH)
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Invoice:
   - –ï—Å–ª–∏ totalPaid >= totalAmount ‚Üí status = PAID, paidAt = now()
   - –ò–Ω–∞—á–µ ‚Üí status = PARTIALLY_PAID

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º COMPLETED
- –°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω (PAID –∏–ª–∏ PARTIALLY_PAID)
- Frontend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω (React Query invalidation)

### –ü—Ä–∏–º–µ—Ä 2: –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ —Å—á–µ—Ç–∞

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –°—á–µ—Ç –Ω–∞ 10,000‚ÇΩ, –∫–ª–∏–µ–Ω—Ç –≤–Ω–æ—Å–∏—Ç 3,000‚ÇΩ

```typescript
// –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂
createPayment({
  clientId: 'uuid',
  invoiceId: 'uuid',
  amount: 3000.00,
  paymentMethod: 'CASH',
  paymentType: 'SUBSCRIPTION',
});

// Backend:
// totalPaid = 3000
// totalAmount = 10000
// 3000 < 10000 ‚Üí status = PARTIALLY_PAID

// –í—Ç–æ—Ä–æ–π –ø–ª–∞—Ç–µ–∂ (—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é)
createPayment({
  clientId: 'uuid',
  invoiceId: 'uuid',
  amount: 7000.00,
  paymentMethod: 'CARD',
  paymentType: 'SUBSCRIPTION',
});

// Backend:
// totalPaid = 3000 + 7000 = 10000
// totalAmount = 10000
// 10000 >= 10000 ‚Üí status = PAID, paidAt = now()
```

### –ü—Ä–∏–º–µ—Ä 3: –í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞ (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ö–ª–∏–µ–Ω—Ç –≤–µ—Ä–Ω—É–ª –∞–±–æ–Ω–µ–º–µ–Ω—Ç, –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –¥–µ–Ω—å–≥–∏

```typescript
// Frontend (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN)
const { mutate: updatePayment } = useUpdatePayment();

const handleRefund = (paymentId: string) => {
  updatePayment({
    id: paymentId,
    data: {
      status: 'REFUNDED',
      notes: '–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É –∫–ª–∏–µ–Ω—Ç–∞',
    },
  });
};
```

**Backend –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ AdminGuard
2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ REFUNDED
3. –ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ —Å—á–µ—Ç–∞:
   - Aggregate —Ç–æ–ª—å–∫–æ COMPLETED –ø–ª–∞—Ç–µ–∂–µ–π (REFUNDED –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Invoice status

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–ª–∞—Ç–µ–∂ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ REFUNDED
- –°—á–µ—Ç –≤–µ—Ä–Ω—É–ª—Å—è –≤ —Å—Ç–∞—Ç—É—Å PARTIALLY_PAID –∏–ª–∏ PENDING
- paidAt —Å–±—Ä–æ—à–µ–Ω, –µ—Å–ª–∏ —Å—á–µ—Ç –±–æ–ª—å—à–µ –Ω–µ –æ–ø–ª–∞—á–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é

### –ü—Ä–∏–º–µ—Ä 4: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü

```typescript
const { data } = usePayments({
  status: 'COMPLETED',
  dateFrom: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
  dateTo: new Date().toISOString(),
  page: 1,
  limit: 50,
});

// –û—Ç–≤–µ—Ç:
// {
//   data: [...50 –ø–ª–∞—Ç–µ–∂–µ–π...],
//   meta: {
//     total: 237,
//     page: 1,
//     limit: 50,
//     totalPages: 5
//   }
// }
```

---

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. PaymentDetailsSheet –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–°—Ç–∞—Ç—É—Å:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–ª–∞—Ç–µ–∂–∞
**Workaround:** –î–µ—Ç–∞–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ inline
**–ü–ª–∞–Ω—ã:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö

### 2. –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ UI
**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /payments —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
**API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:** clientId, invoiceId, method, type, dateRange
**–ü–ª–∞–Ω—ã:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ UI

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—è processedBy
**–°—Ç–∞—Ç—É—Å:** –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ù–µ—Ç —è–≤–Ω–æ–≥–æ –ø–æ–ª—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞–ª –ø–ª–∞—Ç–µ–∂
**Workaround:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JWT auth –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**–ü–ª–∞–Ω—ã:** –î–æ–±–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –¥–ª—è audit trail

### 4. –ú–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã
**–°—Ç–∞—Ç—É—Å:** –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
**–û–ø–∏—Å–∞–Ω–∏–µ:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ: CASH, CARD, ONLINE
**–ù–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:** CARD_TERMINAL, BANK_TRANSFER (–∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞)
**–ü–ª–∞–Ω—ã:** –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ enum –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## üîÆ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è (Roadmap)

### –§–∞–∑–∞ 2: UI —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ö–æ–º–ø–æ–Ω–µ–Ω—Ç PaymentDetailsSheet –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
- [ ] –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ /payments
- [ ] –ì—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel/PDF
- [ ] –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–ª–∞—Ç–µ–∂–∞

### –§–∞–∑–∞ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂–∞–º–∏ (–ÆKassa, CloudPayments)
- [ ] Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ transactionId
- [ ] Email/SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
- [ ] –ß–µ–∫–∏ –∏ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ (54-–§–ó)

### –§–∞–∑–∞ 4: –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

- [ ] –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π (recurring)
- [ ] –†–∞—Å—Å—Ä–æ—á–∫–∞ –∏ —á–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ (–∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏)
- [ ] –ë–æ–Ω—É—Å–Ω—ã–µ –±–∞–ª–ª—ã –∏ –∫—ç—à–±—ç–∫
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–µ–π (1–°)

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ò–Ω–¥–µ–∫—Å—ã –ë–î

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞:

```prisma
@@index([clientId])       // –ü–ª–∞—Ç–µ–∂–∏ –∫–ª–∏–µ–Ω—Ç–∞
@@index([invoiceId])      // –ü–ª–∞—Ç–µ–∂–∏ –ø–æ —Å—á–µ—Ç—É
@@index([status])         // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
@@index([createdAt])      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
@@index([paymentType])    // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

1. **Aggregate –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ totalPaid:**
   - –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
   - –§–∏–ª—å—Ç—Ä –ø–æ status = COMPLETED

2. **Include relations:**
   - –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
   - –ò–∑–±–µ–∂–∞–Ω–∏–µ N+1 –ø—Ä–æ–±–ª–µ–º—ã

3. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è:**
   - –õ–∏–º–∏—Ç 10-50 –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
   - Offset-based pagination

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–µ—Å—Ç—ã

**Backend:**
- [x] Unit-—Ç–µ—Å—Ç—ã –¥–ª—è calculateTotalPaid
- [x] Unit-—Ç–µ—Å—Ç—ã –¥–ª—è updateInvoiceStatus
- [ ] E2E —Ç–µ—Å—Ç: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ Invoice status
- [ ] E2E —Ç–µ—Å—Ç: —á–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ ‚Üí PARTIALLY_PAID
- [ ] E2E —Ç–µ—Å—Ç: –ø–æ–ª–Ω–∞—è –æ–ø–ª–∞—Ç–∞ ‚Üí PAID —Å paidAt
- [ ] E2E —Ç–µ—Å—Ç: –≤–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞ ‚Üí –ø–µ—Ä–µ—Å—á–µ—Ç Invoice
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è: –ø–ª–∞—Ç–µ–∂ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–µ–ø–æ–≥–∞—à–µ–Ω–Ω—É—é —Å—É–º–º—É
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ AdminGuard –¥–ª—è update/delete

**Frontend:**
- [ ] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ InvoicePaymentsSection
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º—ã (–Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –æ—Å—Ç–∞—Ç–æ–∫)
- [ ] Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ
- [ ] React Query –∫—ç—à –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è

---

## üìù –ó–∞–º–µ—Ç–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤** ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è. –í—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–π—Ç–µ `updateInvoiceStatus()` –ø–æ—Å–ª–µ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–ª–∞—Ç–µ–∂–µ–π.

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–ª–∞—Ç—É. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `unpaidAmount`, –∞ –Ω–µ —Å `totalAmount`.

3. **CASH –ø–ª–∞—Ç–µ–∂–∏** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ COMPLETED, —Ç.–∫. –¥–µ–Ω—å–≥–∏ –ø–æ–ª—É—á–µ–Ω—ã —Å—Ä–∞–∑—É.

4. **React Query –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å `payments`, `invoices` –ò `clients` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

5. **TypeScript —Ç–∏–ø—ã** ‚Äî –≤—Å–µ DTOs –∏ –º–æ–¥–µ–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫.

6. **AdminGuard** ‚Äî —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –ø–ª–∞—Ç–µ–∂–∏. –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å.

---

## üìö –°–≤—è–∑–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [–ú–æ–¥—É–ª—å –°—á–µ—Ç–æ–≤](./05_INVOICES_MODULE.md) ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
- [–ú–æ–¥—É–ª—å –ö–ª–∏–µ–Ω—Ç–æ–≤](./01_CLIENTS_CRM_MODULE.md) ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∫–ª–∏–µ–Ω—Ç–∞
- [–ú–æ–¥—É–ª—å –ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤](./06_SUBSCRIPTIONS_MODULE.md) ‚Äî –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã
- [ROADMAP](../ROADMAP.md) ‚Äî –æ–±—â–∏–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-11-17
**–ê–≤—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ä—Ç—Å-—Å—Ç—É–¥–∏–µ–π
