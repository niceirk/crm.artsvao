# Модуль 5: Расчет заработной платы

**Версия:** 1.0
**Дата:** 2025-11-13
**Статус:** В разработке

---

## Содержание

1. [Общее описание](#1-общее-описание)
2. [Структуры данных](#2-структуры-данных)
3. [Бизнес-процессы](#3-бизнес-процессы)
4. [Валидация данных](#4-валидация-данных)
5. [UI/UX спецификация](#5-uiux-спецификация)
6. [API эндпоинты](#6-api-эндпоинты)
7. [Интеграции](#7-интеграции)
8. [Права доступа](#8-права-доступа)

---

## 1. Общее описание

### 1.1. Назначение модуля

Модуль **Расчет заработной платы** обеспечивает автоматизированный расчет заработной платы сотрудников:
- Автоматический расчет ЗП преподавателей (процент от выручки групп)
- Автоматический расчет ЗП менеджеров (процент от аренды)
- Ручные корректировки (премии, удержания)
- Двухэтапное утверждение (черновик → утверждение)
- Детализированные отчеты

### 1.2. Основные возможности

**Для администраторов:**
- Создание расчетных периодов (произвольные даты)
- Автоматический расчет ЗП всех сотрудников
- Ручные корректировки (премии, удержания)
- Утверждение расчетов
- Просмотр детализации и отчетов
- Сравнение по периодам

**Для менеджеров:**
- Ограниченный доступ (только свои расчеты, если разрешено)

**Для преподавателей:**
- Нет доступа (только администратор видит ЗП)

### 1.3. Ключевые концепции

#### Типы сотрудников
- **Преподаватели (Teachers)** — получают % от выручки своих групп
- **Менеджеры (Managers)** — получают % от аренды (6% для действующих клиентов, 10% для новых)

#### Расчетный период
- Произвольный период (от даты до даты)
- Например: 01.11.2024 - 25.11.2024
- Следующий период: 26.11.2024 - 30.11.2024
- Обычно: месяц (01.11.2024 - 30.11.2024)

#### Жизненный цикл расчета
```
DRAFT → APPROVED → PAID
```

#### Формулы расчета

**Преподаватели:**
```typescript
// Выручка от всех групп преподавателя за период
const groupsRevenue = sumOf(
  payments
    .where(subscription.group.teacherId === teacherId)
    .where(paidAt >= periodStart && paidAt <= periodEnd)
    .where(status === 'COMPLETED')
);

// ЗП = выручка × процент
const salary = groupsRevenue * (studioTeacher.salaryPercentage / 100);
```

**Менеджеры:**
```typescript
// Выручка от аренды менеджера за период
const rentalsRevenue = sumOf(
  rentalPayments
    .where(rental.managerId === managerId)
    .where(paidAt >= periodStart && paidAt <= periodEnd)
    .where(status === 'PAID')
);

// Разделить на новых и действующих клиентов
const newClientsRevenue = sumOf(
  rentalPayments
    .where(client.createdAt >= periodStart && client.createdAt <= periodEnd)
);
const existingClientsRevenue = rentalsRevenue - newClientsRevenue;

// ЗП = (действующие × 6%) + (новые × 10%)
const salary = (existingClientsRevenue * 0.06) + (newClientsRevenue * 0.10);
```

---

## 2. Структуры данных

### 2.1. SalaryPeriod (Расчетный период)

Период, за который рассчитывается заработная плата.

```prisma
model SalaryPeriod {
  id          String              @id @default(uuid())
  name        String              @db.VarChar(100)  // Например: "Ноябрь 2024 (1-25)"
  startDate   DateTime            @map("start_date") @db.Date
  endDate     DateTime            @map("end_date") @db.Date
  status      SalaryPeriodStatus  @default(DRAFT)

  // Связи
  calculations SalaryCalculation[]

  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  @@map("salary_periods")
  @@index([startDate, endDate])
}

enum SalaryPeriodStatus {
  DRAFT       // Черновик (расчет в процессе)
  APPROVED    // Утвержден (расчет завершен)
  PAID        // Выплачен
}
```

**Поля:**
- `id` — UUID, первичный ключ
- `name` — Название периода (для удобства)
- `startDate` — Дата начала периода
- `endDate` — Дата окончания периода
- `status` — Статус расчетного периода (DRAFT / APPROVED / PAID)

---

### 2.2. SalaryCalculation (Расчет ЗП сотрудника)

Расчет заработной платы конкретного сотрудника за период.

```prisma
model SalaryCalculation {
  id              String              @id @default(uuid())
  periodId        String              @map("period_id")
  employeeId      String              @map("employee_id")
  employeeType    EmployeeType        @map("employee_type")

  // Базовые суммы (автоматический расчет)
  baseAmount      Decimal             @default(0) @map("base_amount") @db.Decimal(10, 2)

  // Детализация для преподавателей
  teacherRevenue  Decimal?            @map("teacher_revenue") @db.Decimal(10, 2)  // Выручка групп
  teacherPercent  Decimal?            @map("teacher_percent") @db.Decimal(5, 2)   // Процент

  // Детализация для менеджеров
  managerExistingRevenue Decimal?     @map("manager_existing_revenue") @db.Decimal(10, 2)  // Выручка от действующих
  managerNewRevenue      Decimal?     @map("manager_new_revenue") @db.Decimal(10, 2)       // Выручка от новых
  managerExistingPercent Decimal?     @map("manager_existing_percent") @db.Decimal(5, 2)   // 6%
  managerNewPercent      Decimal?     @map("manager_new_percent") @db.Decimal(5, 2)        // 10%

  // Корректировки
  totalAdjustments Decimal            @default(0) @map("total_adjustments") @db.Decimal(10, 2)

  // Итоговая сумма
  totalAmount     Decimal             @map("total_amount") @db.Decimal(10, 2)

  // Связи
  period          SalaryPeriod        @relation(fields: [periodId], references: [id], onDelete: Cascade)
  adjustments     SalaryAdjustment[]

  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  @@map("salary_calculations")
  @@unique([periodId, employeeId])
  @@index([periodId])
  @@index([employeeId])
}

enum EmployeeType {
  TEACHER     // Преподаватель
  MANAGER     // Менеджер
}
```

**Поля:**
- `id` — UUID, первичный ключ
- `periodId` — ID расчетного периода
- `employeeId` — ID сотрудника (Teacher или User с ролью Manager)
- `employeeType` — Тип сотрудника (TEACHER / MANAGER)
- `baseAmount` — Базовая сумма (автоматический расчет по формуле)
- `teacherRevenue` — Выручка групп преподавателя (только для TEACHER)
- `teacherPercent` — Процент преподавателя (только для TEACHER)
- `managerExistingRevenue` — Выручка от действующих клиентов (только для MANAGER)
- `managerNewRevenue` — Выручка от новых клиентов (только для MANAGER)
- `managerExistingPercent` — Процент для действующих (6%)
- `managerNewPercent` — Процент для новых (10%)
- `totalAdjustments` — Сумма всех корректировок (премии - удержания)
- `totalAmount` — Итоговая сумма к выплате (baseAmount + totalAdjustments)

---

### 2.3. SalaryAdjustment (Корректировка ЗП)

Ручные корректировки заработной платы (премии, удержания).

```prisma
model SalaryAdjustment {
  id              String              @id @default(uuid())
  calculationId   String              @map("calculation_id")
  type            AdjustmentType
  amount          Decimal             @db.Decimal(10, 2)
  reason          String              @db.Text
  createdBy       String              @map("created_by")  // ID администратора

  // Связи
  calculation     SalaryCalculation   @relation(fields: [calculationId], references: [id], onDelete: Cascade)
  creator         User                @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  createdAt       DateTime            @default(now()) @map("created_at")

  @@map("salary_adjustments")
  @@index([calculationId])
}

enum AdjustmentType {
  BONUS       // Премия (положительная корректировка)
  DEDUCTION   // Удержание (отрицательная корректировка)
}
```

**Поля:**
- `id` — UUID, первичный ключ
- `calculationId` — ID расчета ЗП
- `type` — Тип корректировки (BONUS / DEDUCTION)
- `amount` — Сумма корректировки (всегда положительная, тип определяет знак)
- `reason` — Причина корректировки (обязательно)
- `createdBy` — ID администратора, создавшего корректировку

---

## 3. Бизнес-процессы

### 3.1. Создание расчетного периода

**Участники:** Администратор

**Процесс:**
1. Администратор открывает раздел "Зарплата"
2. Нажимает "Создать расчетный период"
3. Заполняет данные:
   - Название периода (например: "Ноябрь 2024 (1-25)")
   - Дата начала (01.11.2024)
   - Дата окончания (25.11.2024)
4. Система валидирует:
   - endDate > startDate
   - Нет пересечений с существующими периодами (предупреждение)
5. Система создает SalaryPeriod со статусом DRAFT:
   ```typescript
   const period = await createSalaryPeriod({
     name: 'Ноябрь 2024 (1-25)',
     startDate: new Date('2024-11-01'),
     endDate: new Date('2024-11-25'),
     status: 'DRAFT',
   });
   ```

**Результат:** Расчетный период создан, готов к расчету

---

### 3.2. Автоматический расчет ЗП всех сотрудников

**Участники:** Администратор

**Процесс:**
1. Администратор открывает созданный период (status = DRAFT)
2. Нажимает "Рассчитать зарплату"
3. Система выполняет расчет для всех сотрудников:

**Шаг 1: Расчет ЗП преподавателей**

```typescript
// Найти всех преподавателей
const teachers = await prisma.teacher.findMany({
  include: {
    studioTeachers: {
      include: {
        studio: { include: { groups: true } },
      },
    },
  },
});

for (const teacher of teachers) {
  // Найти все группы преподавателя
  const groupIds = teacher.studioTeachers.flatMap(st =>
    st.studio.groups.map(g => g.id)
  );

  // Найти все оплаченные платежи за период
  const payments = await prisma.payment.findMany({
    where: {
      invoice: {
        subscription: {
          groupId: { in: groupIds },
        },
      },
      status: 'COMPLETED',
      paidAt: {
        gte: period.startDate,
        lte: period.endDate,
      },
    },
    include: {
      invoice: {
        include: {
          subscription: { include: { group: true } },
        },
      },
    },
  });

  // Рассчитать выручку по каждой студии
  const revenueByStudio = {};
  for (const payment of payments) {
    const studioId = payment.invoice.subscription.group.studioId;
    if (!revenueByStudio[studioId]) {
      revenueByStudio[studioId] = 0;
    }
    revenueByStudio[studioId] += Number(payment.amount);
  }

  // Рассчитать ЗП по каждой студии и суммировать
  let totalSalary = 0;
  let totalRevenue = 0;

  for (const st of teacher.studioTeachers) {
    const revenue = revenueByStudio[st.studioId] || 0;
    const salary = revenue * (Number(st.salaryPercentage) / 100);
    totalSalary += salary;
    totalRevenue += revenue;
  }

  // Средний процент для отображения
  const avgPercent = totalRevenue > 0 ? (totalSalary / totalRevenue) * 100 : 0;

  // Создать расчет
  await prisma.salaryCalculation.create({
    data: {
      periodId: period.id,
      employeeId: teacher.id,
      employeeType: 'TEACHER',
      baseAmount: totalSalary,
      teacherRevenue: totalRevenue,
      teacherPercent: avgPercent,
      totalAmount: totalSalary, // Пока без корректировок
    },
  });
}
```

**Шаг 2: Расчет ЗП менеджеров**

```typescript
// Найти всех менеджеров
const managers = await prisma.user.findMany({
  where: { role: 'MANAGER' },
});

for (const manager of managers) {
  // Найти все аренды менеджера за период
  const rentals = await prisma.rental.findMany({
    where: {
      managerId: manager.id,
      status: 'PAID',
      rentalPayments: {
        some: {
          paidAt: {
            gte: period.startDate,
            lte: period.endDate,
          },
        },
      },
    },
    include: {
      rentalPayments: {
        where: {
          paidAt: {
            gte: period.startDate,
            lte: period.endDate,
          },
        },
      },
      client: true,
    },
  });

  // Разделить на новых и действующих клиентов
  let existingRevenue = 0;
  let newRevenue = 0;

  for (const rental of rentals) {
    const revenue = rental.rentalPayments.reduce(
      (sum, p) => sum + Number(p.amount),
      0
    );

    // Новый клиент = зарегистрирован в текущем расчетном периоде
    const isNewClient =
      rental.client.createdAt >= period.startDate &&
      rental.client.createdAt <= period.endDate;

    if (isNewClient) {
      newRevenue += revenue;
    } else {
      existingRevenue += revenue;
    }
  }

  // Рассчитать ЗП
  const existingSalary = existingRevenue * 0.06; // 6%
  const newSalary = newRevenue * 0.10; // 10%
  const totalSalary = existingSalary + newSalary;

  // Создать расчет
  await prisma.salaryCalculation.create({
    data: {
      periodId: period.id,
      employeeId: manager.id,
      employeeType: 'MANAGER',
      baseAmount: totalSalary,
      managerExistingRevenue: existingRevenue,
      managerNewRevenue: newRevenue,
      managerExistingPercent: 6,
      managerNewPercent: 10,
      totalAmount: totalSalary,
    },
  });
}
```

4. Система показывает результаты расчета
5. Администратор проверяет расчеты

**Результат:** ЗП всех сотрудников рассчитана автоматически

---

### 3.3. Добавление ручных корректировок

**Участники:** Администратор

**Процесс:**
1. Администратор открывает расчет конкретного сотрудника
2. Нажимает "Добавить корректировку"
3. Выбирает тип корректировки:
   - Премия (BONUS)
   - Удержание (DEDUCTION)
4. Вводит сумму и причину:
   ```
   Тип: Премия
   Сумма: 5000 руб.
   Причина: Отличные результаты работы в ноябре
   ```
5. Система создает SalaryAdjustment:
   ```typescript
   const adjustment = await createSalaryAdjustment({
     calculationId: calculation.id,
     type: 'BONUS',
     amount: 5000,
     reason: 'Отличные результаты работы в ноябре',
     createdBy: admin.id,
   });
   ```
6. Система пересчитывает итоговую сумму:
   ```typescript
   const bonuses = await sumAdjustments(calculationId, 'BONUS');
   const deductions = await sumAdjustments(calculationId, 'DEDUCTION');
   const totalAdjustments = bonuses - deductions;

   await updateCalculation(calculationId, {
     totalAdjustments,
     totalAmount: calculation.baseAmount + totalAdjustments,
   });
   ```

**Результат:** Корректировка добавлена, итоговая сумма пересчитана

---

### 3.4. Утверждение расчета

**Участники:** Администратор

**Процесс:**
1. Администратор проверяет все расчеты в периоде
2. При необходимости вносит корректировки (см. п. 3.3)
3. Нажимает "Утвердить расчет"
4. Система запрашивает подтверждение
5. Администратор подтверждает
6. Система обновляет статус периода:
   ```typescript
   await updateSalaryPeriod(periodId, { status: 'APPROVED' });
   ```
7. Система блокирует редактирование расчетов (можно разблокировать)

**Результат:** Расчет утвержден, готов к выплате

---

### 3.5. Выплата заработной платы

**Участники:** Администратор

**Процесс:**
1. Администратор формирует ведомость на выплату
2. Выплачивает зарплату сотрудникам (вне системы)
3. Отмечает период как "Выплачен":
   ```typescript
   await updateSalaryPeriod(periodId, { status: 'PAID' });
   ```

**Результат:** Период отмечен как выплаченный

---

### 3.6. Пересчет (после утверждения)

**Участники:** Администратор

**Процесс:**
1. Если обнаружена ошибка после утверждения
2. Администратор может "Отменить утверждение"
3. Система возвращает статус в DRAFT:
   ```typescript
   await updateSalaryPeriod(periodId, { status: 'DRAFT' });
   ```
4. Администратор вносит изменения (корректировки или пересчет)
5. Снова утверждает

**Результат:** Расчет исправлен и повторно утвержден

---

## 4. Валидация данных

### 4.1. SalaryPeriod (Расчетный период)

| Поле | Правило | Сообщение об ошибке |
|------|---------|---------------------|
| `name` | Обязательное, 1-100 символов | "Название периода обязательно" |
| `startDate` | Корректная дата | "Неверная дата начала" |
| `endDate` | Позже startDate | "Дата окончания должна быть позже даты начала" |
| `status` | Только DRAFT, APPROVED, PAID | "Неверный статус периода" |

**Бизнес-правила:**
- Предупреждение, если период пересекается с существующими (но не блокировать)
- Нельзя удалить период со статусом APPROVED или PAID
- Нельзя изменить даты после утверждения (status = APPROVED)

---

### 4.2. SalaryCalculation (Расчет ЗП)

| Поле | Правило | Сообщение об ошибке |
|------|---------|---------------------|
| `periodId` | Существующий период | "Расчетный период не найден" |
| `employeeId` | Существующий сотрудник | "Сотрудник не найден" |
| `employeeType` | Только TEACHER, MANAGER | "Неверный тип сотрудника" |
| `baseAmount` | >= 0 | "Базовая сумма не может быть отрицательной" |
| `totalAmount` | Любое число | "Некорректная итоговая сумма" |

**Бизнес-правила:**
- Только один расчет для одного сотрудника в одном периоде (уникальность по periodId + employeeId)
- totalAmount = baseAmount + totalAdjustments

---

### 4.3. SalaryAdjustment (Корректировка)

| Поле | Правило | Сообщение об ошибке |
|------|---------|---------------------|
| `calculationId` | Существующий расчет | "Расчет не найден" |
| `type` | Только BONUS, DEDUCTION | "Неверный тип корректировки" |
| `amount` | > 0 | "Сумма корректировки должна быть положительной" |
| `reason` | Обязательное, не пустое | "Причина корректировки обязательна" |

**Бизнес-правила:**
- amount всегда положительное, тип определяет знак при расчете

---

## 5. UI/UX спецификация

### 5.1. Страница "Расчетные периоды"

**Макет:**
```
┌─────────────────────────────────────────────────────────────┐
│ Расчет заработной платы                [+ Создать период]   │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Ноябрь 2024 (1-25)                          [...]       │ │
│ │ 01.11.2024 - 25.11.2024                                 │ │
│ │ Статус: ✅ Утвержден                                    │ │
│ │ Сотрудников: 25                                         │ │
│ │ Итого к выплате: 450 000 руб.                           │ │
│ │ [Детали] [Отчеты]                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Октябрь 2024                                [...]       │ │
│ │ 01.10.2024 - 31.10.2024                                 │ │
│ │ Статус: 💰 Выплачен                                     │ │
│ │ Сотрудников: 24                                         │ │
│ │ Итого к выплате: 420 000 руб.                           │ │
│ │ [Детали] [Отчеты]                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Ноябрь 2024 (26-30)                         [...]       │ │
│ │ 26.11.2024 - 30.11.2024                                 │ │
│ │ Статус: 📝 Черновик                                     │ │
│ │ Сотрудников: 0 (не рассчитано)                          │ │
│ │ [Рассчитать зарплату] [Удалить]                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**Функционал:**
- Список всех расчетных периодов
- Индикация статуса: 📝 Черновик, ✅ Утвержден, 💰 Выплачен
- Кнопки действий в зависимости от статуса
- Контекстное меню [...] для дополнительных действий

---

### 5.2. Страница расчета периода (детали)

**Макет:**
```
┌─────────────────────────────────────────────────────────────┐
│ Ноябрь 2024 (1-25)                                           │
│ 01.11.2024 - 25.11.2024        Статус: 📝 Черновик         │
│ [Утвердить расчет] [Пересчитать] [Экспорт]                  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ Вкладки: [Преподаватели (15)] [Менеджеры (3)]               │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Иванова Анна Сергеевна                      [...]       │ │
│ │ Студии: Танцы, Йога                                     │ │
│ │ Выручка групп: 120 000 руб.                             │ │
│ │ Процент: 50%                                            │ │
│ │ Базовая ЗП: 60 000 руб.                                 │ │
│ │ Корректировки: +5 000 руб. (премия)                     │ │
│ │ ───────────────────────────────────                      │ │
│ │ Итого: 65 000 руб.                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ Петрова Мария Викторовна                    [...]       │ │
│ │ Студии: Вокал                                           │ │
│ │ Выручка групп: 80 000 руб.                              │ │
│ │ Процент: 50%                                            │ │
│ │ Базовая ЗП: 40 000 руб.                                 │ │
│ │ Корректировки: нет                                      │ │
│ │ ───────────────────────────────────                      │ │
│ │ Итого: 40 000 руб.                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                               │
│ ...                                                          │
│                                                               │
│ ═══════════════════════════════════════════════════════════ │
│ Итого к выплате: 450 000 руб.                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**Функционал:**
- Список всех сотрудников с расчетами
- Две вкладки: Преподаватели, Менеджеры
- Сводная информация по каждому сотруднику
- Контекстное меню [...] для каждого сотрудника:
  - Детализация
  - Добавить корректировку
  - Посмотреть историю
- Общая сумма к выплате внизу

---

### 5.3. Детализация расчета сотрудника

**Макет (Преподаватель):**
```
┌─────────────────────────────────────────────────────────────┐
│ Расчет ЗП: Иванова Анна Сергеевна                           │
│ Период: Ноябрь 2024 (1-25)                                  │
│                                       [Добавить корректировку]│
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ ═══ ВЫРУЧКА ГРУПП ════════════════════════════════════════  │
│                                                               │
│ Студия: Танцы                                                │
│   Группа: Начинающие 5-7 лет                                │
│     Оплачено абонементов: 12                                │
│     Выручка: 54 000 руб.                                    │
│   Группа: Продвинутые 8-12 лет                              │
│     Оплачено абонементов: 15                                │
│     Выручка: 67 500 руб.                                    │
│   ─────────────────────────────────                          │
│   Итого по студии: 121 500 руб.                             │
│   Процент: 50%                                               │
│   ЗП по студии: 60 750 руб.                                 │
│                                                               │
│ Студия: Йога                                                 │
│   Группа: Взрослые                                          │
│     Оплачено абонементов: 8                                 │
│     Выручка: 40 000 руб.                                    │
│   ─────────────────────────────────                          │
│   Итого по студии: 40 000 руб.                              │
│   Процент: 45%                                               │
│   ЗП по студии: 18 000 руб.                                 │
│                                                               │
│ ═══ КОРРЕКТИРОВКИ ════════════════════════════════════════  │
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ + Премия: 5 000 руб.                            [×]     │ │
│ │   Причина: Отличные результаты работы в ноябре          │ │
│ │   Добавил: Администратор (13.11.2024 10:00)             │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                               │
│ ═══════════════════════════════════════════════════════════ │
│                                                               │
│ Базовая ЗП:          78 750 руб.                             │
│ Корректировки:       +5 000 руб.                             │
│ ───────────────────────────────────                          │
│ Итого к выплате:     83 750 руб.                             │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**Макет (Менеджер):**
```
┌─────────────────────────────────────────────────────────────┐
│ Расчет ЗП: Сидорова Елена Петровна                          │
│ Период: Ноябрь 2024 (1-25)                                  │
│                                       [Добавить корректировку]│
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ ═══ ВЫРУЧКА ОТ АРЕНДЫ ════════════════════════════════════  │
│                                                               │
│ Действующие клиенты:                                         │
│   Количество сделок: 12                                     │
│   Выручка: 150 000 руб.                                     │
│   Процент: 6%                                                │
│   ЗП: 9 000 руб.                                            │
│                                                               │
│ Новые клиенты (зарегистрированы в ноябре):                  │
│   Количество сделок: 3                                      │
│   Выручка: 45 000 руб.                                      │
│   Процент: 10%                                               │
│   ЗП: 4 500 руб.                                            │
│                                                               │
│ ═══ КОРРЕКТИРОВКИ ════════════════════════════════════════  │
│                                                               │
│ (нет корректировок)                                          │
│                                                               │
│ ═══════════════════════════════════════════════════════════ │
│                                                               │
│ Базовая ЗП:          13 500 руб.                             │
│ Корректировки:       0 руб.                                  │
│ ───────────────────────────────────                          │
│ Итого к выплате:     13 500 руб.                             │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**Функционал:**
- Подробная детализация расчета
- Для преподавателей: разбивка по студиям и группам
- Для менеджеров: разбивка по типам клиентов (новые/действующие)
- Список всех корректировок
- Возможность удалить корректировку [×]
- Кнопка добавления корректировки

---

### 5.4. Форма добавления корректировки

**Макет:**
```
┌─────────────────────────────────────────────────────────────┐
│ Добавление корректировки                                     │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ Сотрудник: Иванова Анна Сергеевна                           │
│ Период: Ноябрь 2024 (1-25)                                  │
│                                                               │
│ Тип корректировки:                                           │
│   ○ Премия (увеличение ЗП)                                  │
│   ○ Удержание (уменьшение ЗП)                               │
│                                                               │
│ Сумма:                                                       │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ 5000                                         руб.     │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ Причина:                                                     │
│ ┌───────────────────────────────────────────────────────┐   │
│ │ Отличные результаты работы в ноябре                   │   │
│ └───────────────────────────────────────────────────────┘   │
│                                                               │
│ [Отмена]                                    [Добавить]       │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**Функционал:**
- Выбор типа корректировки (радио-кнопки)
- Ввод суммы (только положительное число)
- Обязательная причина
- Кнопки сохранения и отмены

---

### 5.5. Отчет "Сравнение по периодам"

**Макет:**
```
┌─────────────────────────────────────────────────────────────┐
│ Сравнение ЗП: Иванова Анна Сергеевна                        │
│                                                   [Экспорт]  │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                           │ │
│ │  ЗП (руб)                                                │ │
│ │   90К ┤                                              ●   │ │
│ │       │                                         ●        │ │
│ │   80К ┤                                    ●             │ │
│ │       │                              ●                   │ │
│ │   70К ┤                         ●                        │ │
│ │       │                    ●                             │ │
│ │   60К ┤               ●                                  │ │
│ │       └────┬─────┬─────┬─────┬─────┬─────┬─────┬────    │ │
│ │           Июнь  Июль  Авг  Сен  Окт  Ноя  Дек           │ │
│ │                                                           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                               │
│ Таблица:                                                     │
│ ┌─────────────┬───────────┬──────────┬──────────────────┐  │
│ │ Период      │ Выручка   │ Процент  │ ЗП               │  │
│ ├─────────────┼───────────┼──────────┼──────────────────┤  │
│ │ Ноя 2024    │ 161 500   │ 50%      │ 83 750 (+5000)   │  │
│ │ Окт 2024    │ 150 000   │ 50%      │ 75 000           │  │
│ │ Сен 2024    │ 140 000   │ 50%      │ 70 000           │  │
│ │ Авг 2024    │ 130 000   │ 50%      │ 65 000           │  │
│ │ Июл 2024    │ 120 000   │ 50%      │ 60 000           │  │
│ │ Июн 2024    │ 110 000   │ 50%      │ 55 000           │  │
│ └─────────────┴───────────┴──────────┴──────────────────┘  │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

**Функционал:**
- График динамики ЗП по месяцам
- Таблица с детальными данными
- Возможность экспорта в Excel/PDF

---

## 6. API эндпоинты

### 6.1. Расчетные периоды (SalaryPeriods)

#### `GET /api/salary-periods`

Получить список расчетных периодов.

**Query параметры:**
- `status` (optional): `DRAFT` | `APPROVED` | `PAID`

**Response 200:**
```json
{
  "periods": [
    {
      "id": "uuid",
      "name": "Ноябрь 2024 (1-25)",
      "startDate": "2024-11-01",
      "endDate": "2024-11-25",
      "status": "APPROVED",
      "totalEmployees": 25,
      "totalAmount": 450000.00,
      "createdAt": "2024-11-01T10:00:00Z",
      "updatedAt": "2024-11-26T10:00:00Z"
    }
  ]
}
```

---

#### `POST /api/salary-periods`

Создать новый расчетный период.

**Request Body:**
```json
{
  "name": "Ноябрь 2024 (1-25)",
  "startDate": "2024-11-01",
  "endDate": "2024-11-25"
}
```

**Response 201:** Созданный период

---

#### `PATCH /api/salary-periods/:id`

Обновить расчетный период (статус).

**Request Body:**
```json
{
  "status": "APPROVED"
}
```

**Response 200:** Обновленный период

---

#### `POST /api/salary-periods/:id/calculate`

Запустить автоматический расчет ЗП для всех сотрудников.

**Response 200:**
```json
{
  "message": "Расчет выполнен успешно",
  "calculationsCreated": 25,
  "totalAmount": 450000.00
}
```

---

### 6.2. Расчеты ЗП (SalaryCalculations)

#### `GET /api/salary-periods/:periodId/calculations`

Получить все расчеты для периода.

**Query параметры:**
- `employeeType` (optional): `TEACHER` | `MANAGER`

**Response 200:**
```json
{
  "calculations": [
    {
      "id": "uuid",
      "periodId": "uuid",
      "employeeId": "uuid",
      "employeeType": "TEACHER",
      "baseAmount": 78750.00,
      "teacherRevenue": 161500.00,
      "teacherPercent": 50.00,
      "totalAdjustments": 5000.00,
      "totalAmount": 83750.00,
      "employee": {
        "id": "uuid",
        "firstName": "Анна",
        "lastName": "Иванова",
        "middleName": "Сергеевна"
      },
      "adjustmentsCount": 1,
      "createdAt": "2024-11-25T10:00:00Z",
      "updatedAt": "2024-11-25T15:00:00Z"
    }
  ]
}
```

---

#### `GET /api/salary-calculations/:id`

Получить детальный расчет конкретного сотрудника.

**Response 200:**
```json
{
  "id": "uuid",
  "periodId": "uuid",
  "employeeId": "uuid",
  "employeeType": "TEACHER",
  "baseAmount": 78750.00,
  "teacherRevenue": 161500.00,
  "teacherPercent": 50.00,
  "totalAdjustments": 5000.00,
  "totalAmount": 83750.00,
  "employee": {
    "id": "uuid",
    "firstName": "Анна",
    "lastName": "Иванова",
    "middleName": "Сергеевна"
  },
  "adjustments": [
    {
      "id": "uuid",
      "type": "BONUS",
      "amount": 5000.00,
      "reason": "Отличные результаты работы в ноябре",
      "createdBy": "admin-uuid",
      "creator": {
        "firstName": "Администратор",
        "lastName": "Системный"
      },
      "createdAt": "2024-11-25T15:00:00Z"
    }
  ],
  "details": {
    "studios": [
      {
        "studioId": "uuid",
        "studioName": "Танцы",
        "groups": [
          {
            "groupId": "uuid",
            "groupName": "Начинающие 5-7 лет",
            "subscriptionsPaid": 12,
            "revenue": 54000.00
          },
          {
            "groupId": "uuid",
            "groupName": "Продвинутые 8-12 лет",
            "subscriptionsPaid": 15,
            "revenue": 67500.00
          }
        ],
        "totalRevenue": 121500.00,
        "percent": 50.00,
        "salary": 60750.00
      }
    ]
  }
}
```

---

### 6.3. Корректировки (SalaryAdjustments)

#### `POST /api/salary-calculations/:id/adjustments`

Добавить корректировку к расчету.

**Request Body:**
```json
{
  "type": "BONUS",
  "amount": 5000.00,
  "reason": "Отличные результаты работы в ноябре"
}
```

**Response 201:**
```json
{
  "id": "uuid",
  "calculationId": "uuid",
  "type": "BONUS",
  "amount": 5000.00,
  "reason": "Отличные результаты работы в ноябре",
  "createdBy": "admin-uuid",
  "createdAt": "2024-11-25T15:00:00Z"
}
```

**После создания:**
- Система автоматически пересчитывает totalAdjustments и totalAmount в SalaryCalculation

---

#### `DELETE /api/salary-adjustments/:id`

Удалить корректировку.

**Response 204:** Успешно удалено

**После удаления:**
- Система автоматически пересчитывает totalAdjustments и totalAmount в SalaryCalculation

---

### 6.4. Отчеты (Reports)

#### `GET /api/reports/salary/comparison`

Сравнение ЗП сотрудника по периодам.

**Query параметры:**
- `employeeId` (required): ID сотрудника
- `periodsCount` (optional): Количество периодов (по умолчанию 6)

**Response 200:**
```json
{
  "employee": {
    "id": "uuid",
    "firstName": "Анна",
    "lastName": "Иванова",
    "middleName": "Сергеевна",
    "employeeType": "TEACHER"
  },
  "periods": [
    {
      "periodId": "uuid",
      "periodName": "Ноябрь 2024",
      "startDate": "2024-11-01",
      "endDate": "2024-11-30",
      "revenue": 161500.00,
      "percent": 50.00,
      "baseAmount": 78750.00,
      "adjustments": 5000.00,
      "totalAmount": 83750.00
    },
    {
      "periodId": "uuid",
      "periodName": "Октябрь 2024",
      "startDate": "2024-10-01",
      "endDate": "2024-10-31",
      "revenue": 150000.00,
      "percent": 50.00,
      "baseAmount": 75000.00,
      "adjustments": 0,
      "totalAmount": 75000.00
    }
  ]
}
```

---

## 7. Интеграции

### 7.1. Интеграция с модулем Студий

**Использование:**
- Получение данных о преподавателях (Teacher)
- Получение процента преподавателя от выручки (StudioTeacher.salaryPercentage)
- Получение данных о группах преподавателя

**Связи:**
- `SalaryCalculation.employeeId` → `Teacher.id` (для TEACHER)
- Расчет выручки через `Teacher → StudioTeacher → Studio → Group → Subscription → Payment`

---

### 7.2. Интеграция с модулем Абонементов

**Использование:**
- Получение оплаченных платежей за период для расчета выручки групп
- Фильтрация по датам оплаты (paidAt)

**Процесс:**
```typescript
// Найти все оплаченные платежи за период
const payments = await prisma.payment.findMany({
  where: {
    status: 'COMPLETED',
    paidAt: {
      gte: period.startDate,
      lte: period.endDate,
    },
    invoice: {
      subscription: {
        groupId: { in: groupIds },
      },
    },
  },
});

const revenue = payments.reduce((sum, p) => sum + Number(p.amount), 0);
```

---

### 7.3. Интеграция с модулем Расписания (Аренда)

**Использование:**
- Получение данных об аренде для расчета ЗП менеджеров
- Получение данных о менеджерах (User с ролью MANAGER)
- Получение информации о клиентах (дата регистрации для определения новых клиентов)

**Связи:**
- `SalaryCalculation.employeeId` → `User.id` (для MANAGER)
- Расчет выручки через `User → Rental → RentalPayment`

**Процесс:**
```typescript
// Найти все аренды менеджера за период
const rentals = await prisma.rental.findMany({
  where: {
    managerId: manager.id,
    status: 'PAID',
    rentalPayments: {
      some: {
        paidAt: {
          gte: period.startDate,
          lte: period.endDate,
        },
      },
    },
  },
  include: {
    rentalPayments: true,
    client: true,
  },
});

// Разделить на новых и действующих
for (const rental of rentals) {
  const isNewClient =
    rental.client.createdAt >= period.startDate &&
    rental.client.createdAt <= period.endDate;

  // ...
}
```

---

### 7.4. Интеграция с модулем CRM

**Использование:**
- Получение даты регистрации клиента для определения новых клиентов (для расчета ЗП менеджеров)

**Связи:**
- `Client.createdAt` используется для определения новых клиентов

---

## 8. Права доступа

### 8.1. Администратор

**Полный доступ:**
- Создание расчетных периодов
- Автоматический расчет ЗП всех сотрудников
- Добавление/удаление корректировок
- Утверждение расчетов
- Просмотр всех отчетов
- Экспорт данных

---

### 8.2. Менеджер/Регистратор

**Ограниченный доступ:**
- Нет доступа к модулю ЗП (только администратор)

---

### 8.3. Преподаватель

**Ограниченный доступ:**
- Нет доступа к модулю ЗП (только администратор)

---

## 9. Дополнительные функции

### 9.1. Экспорт данных

**Доступные форматы:**
- Excel (.xlsx)
- CSV (.csv)
- PDF (расчетные листки)

**Экспортируемые данные:**
- Ведомость на выплату (список всех сотрудников с суммами)
- Детализация по сотруднику
- Сравнение по периодам

---

### 9.2. Автоматическое создание периодов

Возможность настроить автоматическое создание периодов (например, каждое 1-е число месяца).

**Настройка:**
- Включить автосоздание
- Период: с 1-го по последнее число месяца
- Автоматический расчет при создании (опционально)

---

### 9.3. Уведомления

**Администратору:**
- Напоминание о необходимости расчета ЗП (за 3 дня до конца периода)

---

## 10. Технические детали

### 10.1. Индексы базы данных

```sql
-- Для быстрого поиска расчетов по периоду
CREATE INDEX idx_salary_calculations_period_id ON salary_calculations(period_id);

-- Для быстрого поиска расчетов по сотруднику
CREATE INDEX idx_salary_calculations_employee_id ON salary_calculations(employee_id);

-- Для быстрого поиска корректировок
CREATE INDEX idx_salary_adjustments_calculation_id ON salary_adjustments(calculation_id);

-- Для фильтрации периодов по датам
CREATE INDEX idx_salary_periods_dates ON salary_periods(start_date, end_date);
```

---

### 10.2. Кэширование

**Кэшируемые данные:**
- Список преподавателей с процентами (TTL = 1 час)
- Список менеджеров (TTL = 1 час)

**Инвалидация кэша:**
- При изменении StudioTeacher.salaryPercentage
- При изменении ролей пользователей

---

### 10.3. Оптимизация расчетов

**Проблема:** Расчет ЗП может быть медленным для большого количества сотрудников и платежей.

**Решение:**
1. Использовать агрегации на уровне БД:
   ```typescript
   const revenue = await prisma.payment.aggregate({
     where: {
       status: 'COMPLETED',
       paidAt: { gte: period.startDate, lte: period.endDate },
       invoice: { subscription: { groupId: { in: groupIds } } },
     },
     _sum: { amount: true },
   });
   ```

2. Выполнять расчет в фоновой задаче (background job) для больших периодов

3. Показывать прогресс расчета пользователю

---

## 11. Примеры использования

### 11.1. Создание и расчет периода

```typescript
// 1. Создать период
const period = await prisma.salaryPeriod.create({
  data: {
    name: 'Ноябрь 2024 (1-25)',
    startDate: new Date('2024-11-01'),
    endDate: new Date('2024-11-25'),
    status: 'DRAFT',
  },
});

// 2. Запустить расчет
await calculateSalariesForPeriod(period.id);

// 3. Проверить результаты
const calculations = await prisma.salaryCalculation.findMany({
  where: { periodId: period.id },
  include: {
    employee: true,
    adjustments: true,
  },
});

console.log(`Рассчитано ЗП для ${calculations.length} сотрудников`);
console.log(`Итого к выплате: ${calculations.reduce((sum, c) => sum + Number(c.totalAmount), 0)} руб.`);
```

---

### 11.2. Добавление премии

```typescript
// 1. Найти расчет сотрудника
const calculation = await prisma.salaryCalculation.findFirst({
  where: {
    periodId: period.id,
    employeeId: teacher.id,
  },
});

// 2. Добавить премию
const adjustment = await prisma.salaryAdjustment.create({
  data: {
    calculationId: calculation.id,
    type: 'BONUS',
    amount: 5000,
    reason: 'Отличные результаты работы в ноябре',
    createdBy: admin.id,
  },
});

// 3. Пересчитать итоговую сумму
const bonuses = await prisma.salaryAdjustment.aggregate({
  where: { calculationId: calculation.id, type: 'BONUS' },
  _sum: { amount: true },
});

const deductions = await prisma.salaryAdjustment.aggregate({
  where: { calculationId: calculation.id, type: 'DEDUCTION' },
  _sum: { amount: true },
});

const totalAdjustments = (bonuses._sum.amount || 0) - (deductions._sum.amount || 0);

await prisma.salaryCalculation.update({
  where: { id: calculation.id },
  data: {
    totalAdjustments,
    totalAmount: Number(calculation.baseAmount) + totalAdjustments,
  },
});
```

---

## Заключение

Модуль **Расчет заработной платы** обеспечивает:

- ✅ Автоматический расчет ЗП преподавателей (% от выручки групп)
- ✅ Автоматический расчет ЗП менеджеров (6% / 10% от аренды)
- ✅ Произвольные расчетные периоды
- ✅ Ручные корректировки (премии, удержания)
- ✅ Двухэтапное утверждение (черновик → утверждение)
- ✅ Детализированные отчеты
- ✅ Сравнение по периодам

Этот модуль тесно интегрирован с модулями Студий, Абонементов, Расписания и CRM для автоматического расчета заработной платы на основе фактических данных о выручке.

---

**Следующий модуль:** [06_REPORTS_MODULE.md](./06_REPORTS_MODULE.md) — Модуль Отчетности и аналитики
