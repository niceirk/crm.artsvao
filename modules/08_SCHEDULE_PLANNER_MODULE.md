# Модуль 8: Планировщик расписания

**Версия:** 1.0
**Дата:** 2025-11-15
**Статус:** Детальная спецификация

---

## Содержание

1. [Общее описание](#1-общее-описание)
2. [Назначение модуля](#2-назначение-модуля)
3. [Бизнес-процессы](#3-бизнес-процессы)
4. [Структура данных](#4-структура-данных)
5. [Функциональные требования](#5-функциональные-требования)
6. [UI/UX спецификация](#6-uiux-спецификация)
7. [API эндпоинты](#7-api-эндпоинты)
8. [Интеграции](#8-интеграции)
9. [Валидация и бизнес-правила](#9-валидация-и-бизнес-правила)
10. [Права доступа](#10-права-доступа)

---

## 1. Общее описание

### 1.1. Назначение

Модуль **Планировщик расписания** обеспечивает централизованное управление расписанием занятий групп на период. Это расширение базового модуля расписания, которое добавляет возможности массового планирования и управления повторяющимися занятиями.

### 1.2. Бизнес-цели

- Автоматизация создания регулярных занятий на месяц/семестр
- Упрощение массового изменения параметров расписания
- Предотвращение ошибок планирования через визуальный предпросмотр
- Сокращение времени на составление расписания с нескольких часов до минут
- Автоматическая запись клиентов группы на создаваемые занятия

### 1.3. Ключевые возможности

**Для администраторов и менеджеров:**
- Создание повторяющихся занятий на период (месяц/семестр)
- Массовое изменение параметров расписания группы
- Копирование расписания между группами или периодами
- Массовая отмена/перенос занятий
- Визуальный предпросмотр создаваемых занятий
- Автоматическое разрешение конфликтов (пропуск конфликтующих дат)
- Автоматическая запись клиентов группы с активными абонементами

### 1.4. Связь с другими модулями

- **Модуль расписания** (02_SCHEDULE_MODULE.md) — базовый модуль для разовых занятий
- **Модуль студий** (03_STUDIOS_MODULE.md) — данные о группах и преподавателях
- **Модуль абонементов** (04_SUBSCRIPTIONS_MODULE.md) — проверка активных абонементов при автозаписи
- **Модуль CRM** (01_CRM_MODULE.md) — данные клиентов для автозаписи

---

## 2. Назначение модуля

### 2.1. Проблема

**Текущая ситуация (без планировщика):**
- Менеджер создает каждое занятие вручную через диалог
- Для группы с 12 занятиями в месяц = 12 отдельных операций
- Высокий риск ошибок (пропуск дат, неверное время)
- Сложно изменить расписание на весь месяц (нужно редактировать каждое занятие)
- Нет визуального предпросмотра создаваемых занятий

**Пример:**
```
Группа "Йога для начинающих"
Расписание: Понедельник, Среда, Пятница 18:00-19:30
Декабрь 2024: 13 занятий

Без планировщика:
1. Создать занятие 02.12.2024 (Пн) 18:00-19:30
2. Создать занятие 04.12.2024 (Ср) 18:00-19:30
3. Создать занятие 06.12.2024 (Пт) 18:00-19:30
...
13. Создать занятие 30.12.2024 (Пн) 18:00-19:30

ИТОГО: 13 операций, ~30 минут работы
```

### 2.2. Решение

**С планировщиком:**
- Одна операция для создания всех занятий месяца
- Визуальный предпросмотр с календарем
- Автоматическая проверка конфликтов
- Массовое изменение параметров
- Автоматическая запись клиентов

**Тот же пример:**
```
С планировщиком:
1. Выбрать группу "Йога для начинающих"
2. Указать период: 01.12.2024 - 31.12.2024
3. Выбрать дни: Пн, Ср, Пт
4. Время: 18:00-19:30
5. Преподаватель: Иванова М.П. (автоподстановка из группы)
6. Помещение: Зал №1 (автоподстановка из группы)
7. Предпросмотр: 13 занятий, конфликтов нет
8. Нажать "Создать расписание"
9. Автоматически записать всех клиентов с активными абонементами

ИТОГО: 1 операция, ~2 минуты работы
```

---

## 3. Бизнес-процессы

### 3.1. Создание повторяющихся занятий

**Участники:** Администратор, Менеджер

**Процесс:**

```
1. Пользователь открывает Планировщик расписания
   └─ Навигация: Расписание → Планировщик
   └─ URL: /schedule/planner

2. Выбирает группу из списка
   ├─ Фильтр по студии (опционально)
   ├─ Поиск по названию группы
   └─ Выбор группы → автозагрузка данных:
       ├─ Преподаватель по умолчанию (из настроек группы)
       ├─ Помещение по умолчанию (из настроек группы)
       └─ Расписание группы (если уже есть)

3. Настраивает параметры планирования
   ├─ Период планирования:
   │   ├─ Дата начала (например: 01.12.2024)
   │   └─ Дата окончания (например: 31.12.2024)
   │
   ├─ Дни недели (множественный выбор):
   │   └─ Пн, Вт, Ср, Чт, Пт, Сб, Вс
   │
   ├─ Время занятий:
   │   ├─ Начало (например: 18:00)
   │   └─ Окончание (например: 19:30)
   │
   ├─ Преподаватель:
   │   └─ Выбор из списка (по умолчанию = преподаватель группы)
   │
   └─ Помещение:
       └─ Выбор из списка (по умолчанию = помещение группы)

4. Система генерирует предпросмотр
   ├─ Рассчитывает все даты по правилу:
   │   └─ Для каждого дня недели в периоде
   │
   ├─ Проверяет конфликты для каждой даты:
   │   ├─ Конфликты по помещению (Schedule, Rental, Event, Reservation)
   │   └─ Конфликты по преподавателю (только Schedule)
   │
   └─ Отображает результат:
       ├─ Список создаваемых занятий (календарь)
       ├─ Количество занятий (например: "Будет создано 13 занятий")
       ├─ Список конфликтов (если есть)
       └─ Опции разрешения конфликтов

5. Обработка конфликтов

   ВАРИАНТ A: Конфликтов нет
   └─ Переход к шагу 6

   ВАРИАНТ B: Есть конфликты
   ├─ Система показывает список конфликтующих дат:
   │   ┌──────────────────────────────────────────┐
   │   │ ⚠️ Обнаружены конфликты (3 даты)        │
   │   ├──────────────────────────────────────────┤
   │   │ 04.12.2024 (Ср) 18:00-19:30              │
   │   │ Зал №1 занят: Аренда (День рождения)    │
   │   │                                          │
   │   │ 11.12.2024 (Ср) 18:00-19:30              │
   │   │ Зал №1 занят: Мероприятие (Концерт)     │
   │   │                                          │
   │   │ 18.12.2024 (Ср) 18:00-19:30              │
   │   │ Преподаватель занят: Индивид. занятие   │
   │   └──────────────────────────────────────────┘
   │
   └─ Автоматическое разрешение:
       ├─ Система автоматически ИСКЛЮЧАЕТ конфликтующие даты
       ├─ Показывает уведомление: "3 даты будут пропущены из-за конфликтов"
       └─ Обновляет предпросмотр: "Будет создано 10 занятий (3 пропущено)"

6. Настройка автозаписи клиентов
   ┌────────────────────────────────────────────────┐
   │ Запись клиентов на занятия                     │
   ├────────────────────────────────────────────────┤
   │ ☑ Автоматически записать клиентов группы       │
   │   на создаваемые занятия                       │
   │                                                │
   │ Критерии записи:                               │
   │ • Клиент записан в группу (status = ACTIVE)    │
   │ • У клиента есть активный абонемент на группу  │
   │ • Абонемент действует на период занятий        │
   │   (validMonth совпадает с месяцем занятия)     │
   │                                                │
   │ Будет записано: 12 клиентов                    │
   └────────────────────────────────────────────────┘

7. Подтверждение и создание
   ├─ Пользователь нажимает "Создать расписание"
   │
   ├─ Система создает родительскую запись Schedule:
   │   ├─ isRecurring = true
   │   ├─ parentScheduleId = NULL
   │   ├─ recurrenceRule = JSON правила повторения
   │   └─ recurrenceEndDate = дата окончания периода
   │
   ├─ Система создает дочерние записи для каждой даты:
   │   ├─ isRecurring = false
   │   ├─ parentScheduleId = ID родительской записи
   │   ├─ date = конкретная дата
   │   ├─ startTime, endTime, teacherId, roomId, groupId
   │   └─ status = PLANNED
   │
   ├─ Для каждого созданного занятия:
   │   ├─ Если включена автозапись:
   │   │   ├─ Получить список клиентов группы (status = ACTIVE)
   │   │   ├─ Для каждого клиента:
   │   │   │   ├─ Проверить наличие активного абонемента
   │   │   │   ├─ Проверить validMonth абонемента = месяц занятия
   │   │   │   ├─ Создать запись Attendance:
   │   │   │   │   ├─ scheduleId = ID занятия
   │   │   │   │   ├─ clientId = ID клиента
   │   │   │   │   ├─ status = PRESENT (по умолчанию)
   │   │   │   │   └─ subscriptionDeducted = false
   │   │   │   └─ НЕ списывать посещение (только при отметке)
   │   │   └─ Подсчитать количество записанных
   │   └─ Иначе: пропустить автозапись
   │
   └─ Система возвращает результат:
       ├─ Количество созданных занятий
       ├─ Количество пропущенных (конфликты)
       ├─ Количество записанных клиентов (если автозапись)
       └─ ID родительской записи (для последующих операций)

8. Результат
   ┌────────────────────────────────────────────────┐
   │ ✅ Расписание успешно создано                  │
   ├────────────────────────────────────────────────┤
   │ Создано: 10 занятий                            │
   │ Пропущено: 3 даты (конфликты)                  │
   │ Записано клиентов: 12 человек на каждое занятие│
   │                                                │
   │ Расписание добавлено в календарь.              │
   │                                                │
   │ [Перейти в календарь]  [Создать ещё]           │
   └────────────────────────────────────────────────┘
```

**Результат:** Создано 10 занятий на месяц, 3 даты пропущены из-за конфликтов, 12 клиентов автоматически записаны на все занятия

---

### 3.2. Массовое изменение расписания

**Участники:** Администратор, Менеджер

**Сценарий:** Нужно изменить время всех занятий группы в декабре с 18:00 на 19:00

**Процесс:**

```
1. Пользователь открывает Планировщик → вкладка "Массовое изменение"

2. Выбирает параметры фильтрации
   ├─ Группа: "Йога для начинающих"
   ├─ Период: 01.12.2024 - 31.12.2024
   └─ Статус: PLANNED (не изменять завершенные/отмененные)

3. Система показывает список найденных занятий
   ┌────────────────────────────────────────────────┐
   │ Найдено 10 занятий                             │
   ├────────────────────────────────────────────────┤
   │ ☑ 02.12.2024 (Пн) 18:00-19:30  Зал №1         │
   │ ☑ 06.12.2024 (Пт) 18:00-19:30  Зал №1         │
   │ ☑ 09.12.2024 (Пн) 18:00-19:30  Зал №1         │
   │ ...                                            │
   │                                                │
   │ [Выбрать все] [Снять все]                      │
   └────────────────────────────────────────────────┘

4. Пользователь выбирает, что изменить
   ┌────────────────────────────────────────────────┐
   │ Параметры для изменения                        │
   ├────────────────────────────────────────────────┤
   │ ☑ Время начала:     [19:00]                    │
   │ ☑ Время окончания:  [20:30]                    │
   │ ☐ Помещение:        [Не изменять ▼]            │
   │ ☐ Преподаватель:    [Не изменять ▼]            │
   │                                                │
   │ ☑ Уведомить клиентов об изменении              │
   └────────────────────────────────────────────────┘

5. Система проверяет конфликты для новых параметров
   ├─ Для каждого выбранного занятия:
   │   ├─ Проверить конфликты по помещению (если изменилось)
   │   ├─ Проверить конфликты по преподавателю (если изменился)
   │   └─ Проверить конфликты по времени (если изменилось)
   │
   └─ Показать результат проверки:
       ├─ Можно изменить: 8 занятий
       ├─ Конфликты: 2 занятия (автоматически будут пропущены)
       └─ Список конфликтов

6. Подтверждение
   ├─ Пользователь нажимает "Применить изменения"
   │
   ├─ Система обновляет записи Schedule:
   │   ├─ Обновить startTime, endTime для 8 занятий
   │   └─ Добавить примечание: "Время изменено массово"
   │
   ├─ Если выбрано "Уведомить клиентов":
   │   ├─ Получить всех клиентов с Attendance для этих занятий
   │   └─ Отправить email уведомление:
   │       "Внимание! Изменилось время занятий группы Йога
   │        Новое время: 19:00-20:30"
   │
   └─ Показать результат:
       ├─ Изменено: 8 занятий
       ├─ Пропущено: 2 занятия (конфликты)
       └─ Уведомлено: 12 клиентов

7. Результат
   ✅ Расписание успешно обновлено
   Изменено: 8 занятий
   Пропущено: 2 занятия
   Уведомлено: 12 клиентов
```

**Результат:** Время изменено для 8 занятий, 2 пропущено, 12 клиентов уведомлены

---

### 3.3. Копирование расписания

**Участники:** Администратор, Менеджер

**Сценарий A:** Скопировать расписание одной группы в другую

**Процесс:**

```
1. Пользователь открывает Планировщик → "Копировать расписание"

2. Выбирает источник
   ├─ Группа-источник: "Йога для начинающих"
   └─ Период: 01.12.2024 - 31.12.2024

3. Система показывает расписание источника
   ┌────────────────────────────────────────────────┐
   │ Расписание группы "Йога для начинающих"        │
   │ Декабрь 2024: 10 занятий                       │
   ├────────────────────────────────────────────────┤
   │ Понедельник    18:00-19:30  Зал №1             │
   │ Среда          18:00-19:30  Зал №1             │
   │ Пятница        18:00-19:30  Зал №1             │
   └────────────────────────────────────────────────┘

4. Выбирает назначение
   ├─ Группа-назначение: "Йога для продолжающих"
   ├─ Период: 01.12.2024 - 31.12.2024 (тот же или другой)
   ├─ Преподаватель: [Автоматически из группы ▼]
   └─ Помещение: [Зал №2 ▼] (можно изменить)

5. Предпросмотр
   ├─ Система генерирует расписание для новой группы
   ├─ Проверяет конфликты
   └─ Показывает результат:
       "Будет создано 10 занятий
        Конфликтов нет"

6. Создание
   └─ Создать новые записи Schedule для группы-назначения

7. Автозапись клиентов (опционально)
   └─ Записать клиентов новой группы с активными абонементами
```

**Сценарий B:** Скопировать расписание группы на следующий месяц

```
1. Источник:
   ├─ Группа: "Йога для начинающих"
   └─ Период: 01.12.2024 - 31.12.2024

2. Назначение:
   ├─ Та же группа: "Йога для начинающих"
   ├─ Период: 01.01.2025 - 31.01.2025
   └─ Преподаватель, помещение: без изменений

3. Система создает расписание на январь
   └─ Автоматически сдвигает даты на месяц вперед
```

**Результат:** Расписание скопировано, клиенты записаны

---

### 3.4. Массовая отмена/перенос

**Участники:** Администратор, Менеджер

**Сценарий:** Отменить все занятия группы на неделю 25-31 декабря (каникулы)

**Процесс:**

```
1. Пользователь открывает Планировщик → "Массовая отмена"

2. Выбирает параметры
   ├─ Группа: "Йога для начинающих"
   └─ Период: 25.12.2024 - 31.12.2024

3. Система показывает список занятий
   ┌────────────────────────────────────────────────┐
   │ Найдено 2 занятия                              │
   ├────────────────────────────────────────────────┤
   │ ☑ 25.12.2024 (Ср) 18:00-19:30                  │
   │    Записано: 12 человек                        │
   │                                                │
   │ ☑ 27.12.2024 (Пт) 18:00-19:30                  │
   │    Записано: 12 человек                        │
   └────────────────────────────────────────────────┘

4. Указывает причину отмены
   ┌────────────────────────────────────────────────┐
   │ Причина отмены:                                │
   │ [Новогодние каникулы]                          │
   │                                                │
   │ ☑ Уведомить клиентов об отмене                 │
   └────────────────────────────────────────────────┘

5. Подтверждение
   ├─ Обновить статус занятий: PLANNED → CANCELLED
   ├─ Добавить cancellationReason для каждого
   ├─ Если "Уведомить клиентов":
   │   └─ Отправить email всем записанным клиентам
   └─ Показать результат

6. Результат
   ✅ Отменено: 2 занятия
   Уведомлено: 12 клиентов
```

---

## 4. Структура данных

### 4.1. Расширение модели Schedule

Модель Schedule уже определена в базовой схеме (02_SCHEDULE_MODULE.md), но требуются дополнительные поля:

```prisma
model Schedule {
  // ... существующие поля ...

  // Новые поля для планировщика
  parentScheduleId    String?         @map("parent_schedule_id")
  recurrenceEndDate   DateTime?       @map("recurrence_end_date") @db.Date
  cancellationReason  String?         @map("cancellation_reason") @db.Text
  createdBy           String?         @map("created_by")

  // Связи
  parentSchedule      Schedule?       @relation("ScheduleRecurrence", fields: [parentScheduleId], references: [id], onDelete: SetNull)
  childSchedules      Schedule[]      @relation("ScheduleRecurrence")
  creator             User?           @relation("CreatedSchedules", fields: [createdBy], references: [id])

  // Индексы
  @@index([parentScheduleId])
  @@index([groupId, date])
}
```

**Описание новых полей:**

- `parentScheduleId` — ID родительского занятия (для повторяющихся серий)
- `recurrenceEndDate` — дата окончания повторений (только для родительской записи)
- `cancellationReason` — причина отмены (если status = CANCELLED)
- `createdBy` — кто создал занятие (для аудита)

### 4.2. Структура recurrenceRule

Поле `recurrenceRule` хранится в формате JSON:

```typescript
interface RecurrenceRule {
  daysOfWeek: number[];      // 0=Воскресенье, 1=Понедельник, ..., 6=Суббота
  startDate: string;         // ISO date "2024-12-01"
  endDate: string;           // ISO date "2024-12-31"
  time: {
    start: string;           // "18:00"
    end: string;             // "19:30"
  };
  teacherId: string;
  roomId: string;
  groupId: string;
}
```

**Пример:**

```json
{
  "daysOfWeek": [1, 3, 5],
  "startDate": "2024-12-01",
  "endDate": "2024-12-31",
  "time": {
    "start": "18:00",
    "end": "19:30"
  },
  "teacherId": "teacher-uuid",
  "roomId": "room-uuid",
  "groupId": "group-uuid"
}
```

---

## 5. Функциональные требования

### 5.1. Создание повторяющихся занятий

**FR-1.1:** Система ДОЛЖНА позволять выбрать группу из списка с поиском и фильтрацией по студии

**FR-1.2:** Система ДОЛЖНА автоматически подставлять преподавателя и помещение из настроек группы

**FR-1.3:** Система ДОЛЖНА генерировать список дат по правилу повторения:
- Учитывать выбранные дни недели
- Учитывать период (startDate - endDate)
- Исключать даты вне периода

**FR-1.4:** Система ДОЛЖНА проверять конфликты для каждой даты:
- Конфликты по помещению (Schedule, Rental, Event, Reservation)
- Конфликты по преподавателю (только Schedule)
- Статус CANCELLED не блокирует

**FR-1.5:** Система ДОЛЖНА автоматически пропускать конфликтующие даты

**FR-1.6:** Система ДОЛЖНА показывать предпросмотр:
- Календарь с создаваемыми занятиями
- Количество занятий (всего и пропущено)
- Список конфликтов

**FR-1.7:** Система ДОЛЖНА создавать:
- Родительскую запись (isRecurring = true, parentScheduleId = NULL)
- Дочерние записи для каждой даты (parentScheduleId = parent.id)

**FR-1.8:** Система ДОЛЖНА автоматически записывать клиентов группы, если включена опция:
- Только клиентов со status = ACTIVE в группе
- Только с активными абонементами (status = ACTIVE)
- Только если validMonth абонемента совпадает с месяцем занятия
- Создавать Attendance с status = PRESENT

---

### 5.2. Массовое изменение

**FR-2.1:** Система ДОЛЖНА позволять фильтровать занятия по:
- Группе
- Периоду
- Статусу

**FR-2.2:** Система ДОЛЖНА показывать список найденных занятий с возможностью выбора

**FR-2.3:** Система ДОЛЖНА позволять изменять:
- Время начала
- Время окончания
- Помещение
- Преподавателя

**FR-2.4:** Система ДОЛЖНА проверять конфликты после изменения параметров

**FR-2.5:** Система ДОЛЖНА автоматически пропускать занятия с конфликтами

**FR-2.6:** Система ДОЛЖНА отправлять уведомления клиентам при изменении

---

### 5.3. Копирование расписания

**FR-3.1:** Система ДОЛЖНА позволять копировать расписание:
- Из одной группы в другую
- Из одного периода в другой (той же группы)

**FR-3.2:** Система ДОЛЖНА автоматически адаптировать параметры:
- Преподаватель (из настроек новой группы)
- Помещение (опционально изменяемо)
- Даты (сдвиг на новый период с сохранением дней недели)

**FR-3.3:** Система ДОЛЖНА проверять конфликты для нового расписания

**FR-3.4:** Система ДОЛЖНА автоматически записывать клиентов новой группы

---

### 5.4. Массовая отмена/перенос

**FR-4.1:** Система ДОЛЖНА позволять выбрать несколько занятий для отмены

**FR-4.2:** Система ДОЛЖНА требовать указания причины отмены

**FR-4.3:** Система ДОЛЖНА обновлять:
- status → CANCELLED
- cancellationReason → причина
- Сохранять записи Attendance (не удалять)

**FR-4.4:** Система ДОЛЖНА отправлять уведомления клиентам об отмене

---

### 5.5. Автозапись клиентов

**FR-5.1:** Система ДОЛЖНА проверять критерии для автозаписи:
```typescript
async function canEnrollClient(
  clientId: string,
  groupId: string,
  scheduleDate: Date
): Promise<boolean> {
  // 1. Клиент записан в группу
  const groupMember = await getGroupMember(clientId, groupId);
  if (!groupMember || groupMember.status !== 'ACTIVE') {
    return false;
  }

  // 2. У клиента есть активный абонемент на группу
  const subscription = await getActiveSubscription(clientId, groupId);
  if (!subscription || subscription.status !== 'ACTIVE') {
    return false;
  }

  // 3. Абонемент действует на месяц занятия
  const scheduleMonth = format(scheduleDate, 'yyyy-MM');
  if (subscription.validMonth !== scheduleMonth) {
    return false;
  }

  return true;
}
```

**FR-5.2:** Система ДОЛЖНА создавать Attendance для каждого подходящего клиента:
- status = PRESENT (по умолчанию)
- subscriptionDeducted = false (списание только при отметке)

**FR-5.3:** Система ДОЛЖНА подсчитывать количество записанных клиентов

---

## 6. UI/UX спецификация

### 6.1. Страница "Планировщик расписания"

**URL:** `/schedule/planner`

**Макет:**

```
┌──────────────────────────────────────────────────────────────────────┐
│ Планировщик расписания                           [← Назад в календарь]│
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│ Вкладки: [Создать расписание] [Массовое изменение] [Копировать]      │
│          [Массовая отмена]                                            │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ 1. Выбор группы                                                │   │
│ │                                                                │   │
│ │ Студия:  [Все студии ▼]                                        │   │
│ │ Поиск:   [Введите название группы...]                          │   │
│ │                                                                │   │
│ │ Группы:                                                        │   │
│ │  ○ Танцы › Начинающие 5-7 лет                                  │   │
│ │  ◉ Йога › Йога для начинающих                                  │   │
│ │  ○ Вокал › Детский хор                                         │   │
│ │  ...                                                           │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ 2. Параметры планирования                                      │   │
│ │                                                                │   │
│ │ Период планирования:                                           │   │
│ │   С: [01.12.2024 📅]  По: [31.12.2024 📅]                      │   │
│ │                                                                │   │
│ │ Дни недели:                                                    │   │
│ │   ☑ Пн  ☐ Вт  ☑ Ср  ☐ Чт  ☑ Пт  ☐ Сб  ☐ Вс                   │   │
│ │                                                                │   │
│ │ Время занятий:                                                 │   │
│ │   Начало: [18:00]  Окончание: [19:30]                         │   │
│ │                                                                │   │
│ │ Преподаватель:                                                 │   │
│ │   [Иванова Мария Петровна ▼]                                   │   │
│ │   ℹ️ Автоматически из настроек группы                          │   │
│ │                                                                │   │
│ │ Помещение:                                                     │   │
│ │   [Зал №1 ▼]                                                   │   │
│ │   ℹ️ Автоматически из настроек группы                          │   │
│ │                                                                │   │
│ │ ☑ Автоматически записать клиентов группы                       │   │
│ │   на создаваемые занятия                                       │   │
│ │                                                                │   │
│ │                            [Сгенерировать предпросмотр]        │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ 3. Предпросмотр                                                │   │
│ │                                                                │   │
│ │ ✅ Будет создано: 10 занятий                                   │   │
│ │ ⚠️  Пропущено: 3 даты (конфликты)                              │   │
│ │ 👥 Будет записано: 12 клиентов на каждое занятие               │   │
│ │                                                                │   │
│ │ Календарь:                                                     │   │
│ │ ┌─────────────────────────────────────────────────────────┐    │   │
│ │ │     Декабрь 2024                                        │    │   │
│ │ │  Пн  Вт  Ср  Чт  Пт  Сб  Вс                             │    │   │
│ │ │                       1                                 │    │   │
│ │ │  2✅  3   4❌  5   6✅  7   8                             │    │   │
│ │ │  9✅ 10  11❌ 12  13✅ 14  15                             │    │   │
│ │ │ 16✅ 17  18❌ 19  20✅ 21  22                             │    │   │
│ │ │ 23✅ 24  25   26  27✅ 28  29                             │    │   │
│ │ │ 30✅ 31                                                  │    │   │
│ │ └─────────────────────────────────────────────────────────┘    │   │
│ │                                                                │   │
│ │ Легенда: ✅ Будет создано  ❌ Конфликт (пропущено)             │   │
│ │                                                                │   │
│ │ ⚠️ Конфликты (3 даты):                                         │   │
│ │ ┌──────────────────────────────────────────────────────────┐   │   │
│ │ │ 04.12.2024 (Ср) 18:00-19:30                              │   │   │
│ │ │ Зал №1 занят: Аренда помещения (День рождения)          │   │   │
│ │ │                                                          │   │   │
│ │ │ 11.12.2024 (Ср) 18:00-19:30                              │   │   │
│ │ │ Зал №1 занят: Мероприятие (Новогодний концерт)          │   │   │
│ │ │                                                          │   │   │
│ │ │ 18.12.2024 (Ср) 18:00-19:30                              │   │   │
│ │ │ Преподаватель занят: Индивидуальное занятие             │   │   │
│ │ └──────────────────────────────────────────────────────────┘   │   │
│ │                                                                │   │
│ │                [Отмена]               [Создать расписание]     │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

### 6.2. Вкладка "Массовое изменение"

**Макет:**

```
┌──────────────────────────────────────────────────────────────────────┐
│ Массовое изменение расписания                                         │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ 1. Фильтр занятий                                              │   │
│ │                                                                │   │
│ │ Группа:  [Йога для начинающих ▼]                               │   │
│ │ Период:  С [01.12.2024 📅] По [31.12.2024 📅]                   │   │
│ │ Статус:  ☑ Запланировано  ☐ Завершено  ☐ Отменено             │   │
│ │                                                                │   │
│ │                                      [Найти занятия]           │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ 2. Список найденных занятий (10)          [Выбрать все]        │   │
│ │                                                                │   │
│ │ ☑ 02.12.2024 (Пн) 18:00-19:30  Зал №1  Иванова М.П.           │   │
│ │   Записано: 12 человек                                         │   │
│ │                                                                │   │
│ │ ☑ 06.12.2024 (Пт) 18:00-19:30  Зал №1  Иванова М.П.           │   │
│ │   Записано: 12 человек                                         │   │
│ │                                                                │   │
│ │ ☑ 09.12.2024 (Пн) 18:00-19:30  Зал №1  Иванова М.П.           │   │
│ │   Записано: 12 человек                                         │   │
│ │                                                                │   │
│ │ ...                                                            │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ 3. Параметры для изменения                                     │   │
│ │                                                                │   │
│ │ ☑ Время начала:      [19:00]                                   │   │
│ │ ☑ Время окончания:   [20:30]                                   │   │
│ │ ☐ Помещение:         [Не изменять ▼]                           │   │
│ │ ☐ Преподаватель:     [Не изменять ▼]                           │   │
│ │                                                                │   │
│ │ ☑ Уведомить клиентов об изменении расписания                   │   │
│ │                                                                │   │
│ │                       [Проверить конфликты]                    │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ 4. Результат проверки                                          │   │
│ │                                                                │   │
│ │ ✅ Можно изменить: 8 занятий                                   │   │
│ │ ⚠️  Конфликты: 2 занятия (будут пропущены)                     │   │
│ │ 📧 Будет уведомлено: 12 клиентов                               │   │
│ │                                                                │   │
│ │ Конфликты:                                                     │   │
│ │ • 06.12.2024 (Пт) 19:00-20:30: Зал №1 занят (Аренда)          │   │
│ │ • 13.12.2024 (Пт) 19:00-20:30: Преподаватель занят             │   │
│ │                                                                │   │
│ │              [Отмена]             [Применить изменения]        │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

### 6.3. Вкладка "Копировать расписание"

**Макет:**

```
┌──────────────────────────────────────────────────────────────────────┐
│ Копирование расписания                                                │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ Источник                                                       │   │
│ │                                                                │   │
│ │ Группа:   [Йога для начинающих ▼]                              │   │
│ │ Период:   С [01.12.2024 📅] По [31.12.2024 📅]                  │   │
│ │                                                                │   │
│ │ Расписание источника:                                          │   │
│ │ • Понедельник    18:00-19:30  Зал №1  Иванова М.П.            │   │
│ │ • Среда          18:00-19:30  Зал №1  Иванова М.П.            │   │
│ │ • Пятница        18:00-19:30  Зал №1  Иванова М.П.            │   │
│ │ Всего: 10 занятий                                              │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
│                           ↓ Копировать ↓                              │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ Назначение                                                     │   │
│ │                                                                │   │
│ │ Группа:        [Йога для продолжающих ▼]                       │   │
│ │ Период:        С [01.01.2025 📅] По [31.01.2025 📅]             │   │
│ │                                                                │   │
│ │ Параметры:                                                     │   │
│ │ Преподаватель: [Автоматически из группы ▼]                     │   │
│ │ Помещение:     [Зал №2 ▼]                                      │   │
│ │                                                                │   │
│ │ ☑ Автоматически записать клиентов новой группы                 │   │
│ │                                                                │   │
│ │                                [Сгенерировать предпросмотр]    │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
│ ┌────────────────────────────────────────────────────────────────┐   │
│ │ Предпросмотр                                                   │   │
│ │                                                                │   │
│ │ ✅ Будет создано: 10 занятий                                   │   │
│ │ ⚠️  Конфликтов: 0                                               │   │
│ │ 👥 Будет записано: 15 клиентов                                 │   │
│ │                                                                │   │
│ │              [Отмена]             [Скопировать расписание]     │   │
│ └────────────────────────────────────────────────────────────────┘   │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

### 6.4. Результат операции

**Макет (успешное создание):**

```
┌──────────────────────────────────────────────────┐
│ ✅ Расписание успешно создано                    │
├──────────────────────────────────────────────────┤
│                                                  │
│ Группа: Йога для начинающих                      │
│ Период: 01.12.2024 - 31.12.2024                  │
│                                                  │
│ Создано:    10 занятий                           │
│ Пропущено:  3 даты (конфликты)                   │
│ Записано:   12 клиентов на каждое занятие        │
│                                                  │
│ Расписание добавлено в календарь.                │
│                                                  │
│ Пропущенные даты:                                │
│ • 04.12.2024 (Ср) - Зал занят (Аренда)          │
│ • 11.12.2024 (Ср) - Зал занят (Мероприятие)     │
│ • 18.12.2024 (Ср) - Преподаватель занят         │
│                                                  │
│ [Перейти в календарь]  [Создать ещё расписание]  │
│                                                  │
└──────────────────────────────────────────────────┘
```

---

## 7. API эндпоинты

### 7.1. Создание повторяющихся занятий

#### POST /api/schedules/recurring

Создать серию повторяющихся занятий

**Request Body:**

```json
{
  "groupId": "uuid",
  "teacherId": "uuid",
  "roomId": "uuid",
  "recurrenceRule": {
    "daysOfWeek": [1, 3, 5],
    "startDate": "2024-12-01",
    "endDate": "2024-12-31",
    "time": {
      "start": "18:00",
      "end": "19:30"
    }
  },
  "autoEnrollClients": true
}
```

**Response 201:**

```json
{
  "parentScheduleId": "uuid",
  "created": {
    "count": 10,
    "schedules": [
      {
        "id": "uuid",
        "date": "2024-12-02",
        "startTime": "18:00:00",
        "endTime": "19:30:00",
        "enrolledClients": 12
      },
      ...
    ]
  },
  "skipped": {
    "count": 3,
    "conflicts": [
      {
        "date": "2024-12-04",
        "reason": "Зал №1 занят: Аренда помещения",
        "conflictType": "room",
        "conflictingEvent": {
          "type": "rental",
          "id": "uuid",
          "title": "День рождения"
        }
      },
      ...
    ]
  }
}
```

**Бизнес-логика:**

```typescript
async function createRecurringSchedule(dto: CreateRecurringScheduleDto) {
  // 1. Валидация
  await validateGroup(dto.groupId);
  await validateTeacher(dto.teacherId);
  await validateRoom(dto.roomId);

  // 2. Создать родительскую запись
  const parentSchedule = await prisma.schedule.create({
    data: {
      groupId: dto.groupId,
      teacherId: dto.teacherId,
      roomId: dto.roomId,
      date: new Date(dto.recurrenceRule.startDate),
      startTime: parseTime(dto.recurrenceRule.time.start),
      endTime: parseTime(dto.recurrenceRule.time.end),
      type: 'GROUP_CLASS',
      isRecurring: true,
      parentScheduleId: null,
      recurrenceRule: JSON.stringify(dto.recurrenceRule),
      recurrenceEndDate: new Date(dto.recurrenceRule.endDate),
      status: 'PLANNED',
      createdBy: currentUser.id,
    },
  });

  // 3. Генерировать даты
  const dates = generateDates(dto.recurrenceRule);

  // 4. Проверить конфликты и создать дочерние записи
  const created = [];
  const skipped = [];

  for (const date of dates) {
    const conflicts = await checkConflicts({
      roomId: dto.roomId,
      teacherId: dto.teacherId,
      date,
      startTime: dto.recurrenceRule.time.start,
      endTime: dto.recurrenceRule.time.end,
    });

    if (conflicts.length > 0) {
      skipped.push({
        date,
        reason: formatConflictReason(conflicts[0]),
        conflictType: conflicts[0].type,
        conflictingEvent: conflicts[0].event,
      });
      continue;
    }

    // Создать занятие
    const schedule = await prisma.schedule.create({
      data: {
        groupId: dto.groupId,
        teacherId: dto.teacherId,
        roomId: dto.roomId,
        date,
        startTime: parseTime(dto.recurrenceRule.time.start),
        endTime: parseTime(dto.recurrenceRule.time.end),
        type: 'GROUP_CLASS',
        isRecurring: false,
        parentScheduleId: parentSchedule.id,
        status: 'PLANNED',
        createdBy: currentUser.id,
      },
    });

    // Автозапись клиентов
    let enrolledClients = 0;
    if (dto.autoEnrollClients) {
      enrolledClients = await enrollClientsToSchedule(schedule.id, dto.groupId, date);
    }

    created.push({
      ...schedule,
      enrolledClients,
    });
  }

  return {
    parentScheduleId: parentSchedule.id,
    created: {
      count: created.length,
      schedules: created,
    },
    skipped: {
      count: skipped.length,
      conflicts: skipped,
    },
  };
}
```

---

### 7.2. Массовое изменение

#### PATCH /api/schedules/bulk

Массово изменить параметры расписания

**Request Body:**

```json
{
  "scheduleIds": ["uuid1", "uuid2", "uuid3"],
  "updates": {
    "startTime": "19:00",
    "endTime": "20:30",
    "roomId": "uuid",
    "teacherId": "uuid"
  },
  "notifyClients": true
}
```

**Response 200:**

```json
{
  "updated": {
    "count": 8,
    "scheduleIds": ["uuid1", "uuid2", ...]
  },
  "skipped": {
    "count": 2,
    "conflicts": [
      {
        "scheduleId": "uuid3",
        "date": "2024-12-06",
        "reason": "Зал занят: Аренда помещения"
      },
      ...
    ]
  },
  "notified": {
    "count": 12,
    "clientIds": ["client1", "client2", ...]
  }
}
```

---

### 7.3. Копирование расписания

#### POST /api/schedules/copy

Скопировать расписание группы

**Request Body:**

```json
{
  "sourceGroupId": "uuid",
  "sourcePeriod": {
    "startDate": "2024-12-01",
    "endDate": "2024-12-31"
  },
  "targetGroupId": "uuid",
  "targetPeriod": {
    "startDate": "2025-01-01",
    "endDate": "2025-01-31"
  },
  "overrides": {
    "teacherId": "uuid",
    "roomId": "uuid"
  },
  "autoEnrollClients": true
}
```

**Response 201:**

```json
{
  "created": {
    "count": 10,
    "schedules": [...]
  },
  "skipped": {
    "count": 0,
    "conflicts": []
  }
}
```

---

### 7.4. Массовая отмена

#### POST /api/schedules/bulk-cancel

Массово отменить занятия

**Request Body:**

```json
{
  "scheduleIds": ["uuid1", "uuid2"],
  "cancellationReason": "Новогодние каникулы",
  "notifyClients": true
}
```

**Response 200:**

```json
{
  "cancelled": {
    "count": 2,
    "scheduleIds": ["uuid1", "uuid2"]
  },
  "notified": {
    "count": 12,
    "clientIds": [...]
  }
}
```

---

### 7.5. Вспомогательные эндпоинты

#### POST /api/schedules/preview

Предпросмотр расписания (без создания)

**Request Body:**

```json
{
  "groupId": "uuid",
  "recurrenceRule": {
    "daysOfWeek": [1, 3, 5],
    "startDate": "2024-12-01",
    "endDate": "2024-12-31",
    "time": {
      "start": "18:00",
      "end": "19:30"
    }
  },
  "teacherId": "uuid",
  "roomId": "uuid"
}
```

**Response 200:**

```json
{
  "dates": [
    {
      "date": "2024-12-02",
      "dayOfWeek": 1,
      "hasConflict": false
    },
    {
      "date": "2024-12-04",
      "dayOfWeek": 3,
      "hasConflict": true,
      "conflicts": [
        {
          "type": "room",
          "reason": "Зал занят: Аренда помещения"
        }
      ]
    },
    ...
  ],
  "summary": {
    "total": 13,
    "canCreate": 10,
    "conflicts": 3
  },
  "eligibleClients": {
    "count": 12,
    "clients": [
      {
        "id": "uuid",
        "fullName": "Иванов Иван Иванович",
        "hasActiveSubscription": true
      },
      ...
    ]
  }
}
```

---

## 8. Интеграции

### 8.1. Интеграция с модулем Расписания

**Использование:**
- Создание записей Schedule
- Проверка конфликтов (ConflictCheckerService)
- Обновление существующих занятий

**Функции:**

```typescript
// Проверка конфликтов
async function checkConflicts(params: {
  roomId: string;
  teacherId: string;
  date: Date;
  startTime: string;
  endTime: string;
  excludeId?: string;
}): Promise<Conflict[]>;

// Создание занятия
async function createSchedule(data: CreateScheduleDto): Promise<Schedule>;

// Обновление занятия
async function updateSchedule(id: string, data: UpdateScheduleDto): Promise<Schedule>;
```

---

### 8.2. Интеграция с модулем Студий

**Использование:**
- Получение данных группы (преподаватель, помещение)
- Получение списка клиентов группы
- Проверка статуса членства (GroupMember.status)

**Функции:**

```typescript
// Получить настройки группы
async function getGroup(id: string): Promise<Group>;

// Получить активных клиентов группы
async function getActiveGroupMembers(groupId: string): Promise<GroupMember[]>;
```

---

### 8.3. Интеграция с модулем Абонементов

**Использование:**
- Проверка активных абонементов при автозаписи
- Валидация validMonth для даты занятия
- Проверка remainingVisits (для SINGLE_VISIT)

**Функции:**

```typescript
// Получить активный абонемент клиента на группу
async function getActiveSubscription(
  clientId: string,
  groupId: string
): Promise<Subscription | null>;

// Проверить валидность абонемента для даты
async function isSubscriptionValidForDate(
  subscription: Subscription,
  date: Date
): Promise<boolean> {
  const scheduleMonth = format(date, 'yyyy-MM');
  return subscription.validMonth === scheduleMonth;
}
```

**Автозапись клиентов:**

```typescript
async function enrollClientsToSchedule(
  scheduleId: string,
  groupId: string,
  scheduleDate: Date
): Promise<number> {
  // 1. Получить активных членов группы
  const groupMembers = await prisma.groupMember.findMany({
    where: {
      groupId,
      status: 'ACTIVE',
    },
    include: {
      client: true,
    },
  });

  let enrolledCount = 0;

  for (const member of groupMembers) {
    // 2. Проверить наличие активного абонемента
    const subscription = await prisma.subscription.findFirst({
      where: {
        clientId: member.clientId,
        groupId,
        status: 'ACTIVE',
      },
    });

    if (!subscription) {
      continue;
    }

    // 3. Проверить validMonth
    const scheduleMonth = format(scheduleDate, 'yyyy-MM');
    if (subscription.validMonth !== scheduleMonth) {
      continue;
    }

    // 4. Для SINGLE_VISIT проверить остаток
    if (subscription.type === 'SINGLE_VISIT' && subscription.remainingVisits === 0) {
      continue;
    }

    // 5. Создать запись Attendance
    await prisma.attendance.create({
      data: {
        scheduleId,
        clientId: member.clientId,
        status: 'PRESENT',
        subscriptionDeducted: false, // Списание только при отметке преподавателем
      },
    });

    enrolledCount++;
  }

  return enrolledCount;
}
```

---

### 8.4. Интеграция с модулем Уведомлений

**Использование:**
- Уведомления об изменении расписания
- Уведомления об отмене занятий

**События:**
- `SCHEDULE_CHANGED` — изменилось время/место занятия
- `SCHEDULE_CANCELLED` — занятие отменено
- `SCHEDULE_TEACHER_CHANGED` — заменен преподаватель

**Шаблоны:**

```typescript
// Уведомление об изменении времени
const changeTemplate = {
  subject: 'Изменение расписания занятий',
  body: `
    Здравствуйте, {{firstName}}!

    Изменилось время занятий группы "{{groupName}}".

    Новое расписание:
    {{#each changes}}
    • {{date}}: {{newTime}} (было {{oldTime}})
    {{/each}}

    С уважением,
    Культурный центр "АртсВАО"
  `,
};

// Уведомление об отмене
const cancellationTemplate = {
  subject: 'Отмена занятий',
  body: `
    Здравствуйте, {{firstName}}!

    Следующие занятия группы "{{groupName}}" отменены:
    {{#each cancelledDates}}
    • {{date}} - {{reason}}
    {{/each}}

    Приносим извинения за неудобства.

    С уважением,
    Культурный центр "АртсВАО"
  `,
};
```

---

## 9. Валидация и бизнес-правила

### 9.1. Правила создания повторяющихся занятий

**BR-1.1:** Период планирования НЕ МОЖЕТ быть больше 1 года

**BR-1.2:** Должен быть выбран хотя бы 1 день недели

**BR-1.3:** Время окончания ДОЛЖНО быть больше времени начала

**BR-1.4:** Преподаватель и помещение ДОЛЖНЫ существовать

**BR-1.5:** Группа ДОЛЖНА быть активной (status = ACTIVE)

**BR-1.6:** Конфликтующие даты автоматически пропускаются (НЕ блокируют создание)

**BR-1.7:** Если ВСЕ даты конфликтуют → ошибка "Невозможно создать ни одного занятия"

---

### 9.2. Правила массового изменения

**BR-2.1:** Нельзя изменять занятия со статусом COMPLETED или CANCELLED

**BR-2.2:** Если изменилось время → обязательно проверить конфликты

**BR-2.3:** Если изменился преподаватель → проверить конфликты преподавателя

**BR-2.4:** Если изменилось помещение → проверить конфликты помещения

**BR-2.5:** Конфликтующие занятия пропускаются (не обновляются)

---

### 9.3. Правила копирования

**BR-3.1:** Исходный период ДОЛЖЕН содержать хотя бы 1 занятие

**BR-3.2:** Целевая группа ДОЛЖНА существовать и быть активной

**BR-3.3:** Если группы разные → использовать преподавателя и помещение целевой группы (или из overrides)

**BR-3.4:** Если период сдвинут → автоматически сдвинуть даты с сохранением дней недели

---

### 9.4. Правила автозаписи клиентов

**BR-4.1:** Записывать ТОЛЬКО клиентов со статусом ACTIVE в группе

**BR-4.2:** Записывать ТОЛЬКО клиентов с активным абонементом (status = ACTIVE)

**BR-4.3:** Проверять соответствие validMonth абонемента и месяца занятия

**BR-4.4:** Для абонементов SINGLE_VISIT проверять remainingVisits > 0

**BR-4.5:** НЕ списывать посещение при автозаписи (списание только при отметке преподавателем)

**BR-4.6:** Создавать Attendance со status = PRESENT по умолчанию

---

## 10. Права доступа

### 10.1. Администратор

**Полный доступ:**
- ✓ Создание повторяющихся занятий
- ✓ Массовое изменение расписания
- ✓ Копирование расписания
- ✓ Массовая отмена/перенос
- ✓ Просмотр всех групп

---

### 10.2. Менеджер

**Доступ:**
- ✓ Создание повторяющихся занятий для своих групп
- ✓ Массовое изменение расписания своих групп
- ✓ Копирование расписания своих групп
- ✓ Массовая отмена/перенос своих групп

**Ограничения:**
- ✗ Не может изменять расписание чужих студий (если настроена привязка менеджера к студии)

---

### 10.3. Преподаватель

**Доступ:**
- ✓ Просмотр своего расписания
- ✓ Просмотр предпросмотра планирования (read-only)

**Ограничения:**
- ✗ Не может создавать/изменять расписание
- ✗ Не может выполнять массовые операции

---

## Заключение

Модуль **Планировщик расписания** обеспечивает:

- ✅ Быстрое создание расписания на месяц/семестр (с 30 минут до 2 минут)
- ✅ Автоматическую проверку и разрешение конфликтов
- ✅ Массовые операции изменения параметров
- ✅ Визуальный предпросмотр с календарем
- ✅ Автоматическую запись клиентов с активными абонементами
- ✅ Интеграцию с модулями Расписания, Студий, Абонементов
- ✅ Уведомления клиентов об изменениях

Этот модуль является критическим для эффективного управления расписанием культурного центра и значительно упрощает работу администраторов и менеджеров.

---

**Дата последнего обновления:** 2025-11-15
**Статус:** Готов к реализации
