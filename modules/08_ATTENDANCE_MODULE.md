# –ú–æ–¥—É–ª—å 8: –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å (Attendance)

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-17
**–°—Ç–∞—Ç—É—Å:** üü¢ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω (Backend ‚úÖ, Frontend ‚úÖ)
**–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏:** [–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã](./06_SUBSCRIPTIONS_MODULE.md), [–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ](./02_SCHEDULE_MODULE.md), [–°—á–µ—Ç–∞](./06_INVOICES_MODULE.md), [–ö–ª–∏–µ–Ω—Ç—ã](./01_CRM_MODULE.md)

---

## üìã –û–±–∑–æ—Ä –º–æ–¥—É–ª—è

–ú–æ–¥—É–ª—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—á–µ—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–ø–∏—Å–∞–Ω–∏–µ–º –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–ø–∏—Å–∞–Ω–∏—è —É—Å–ª—É–≥ –∏ –≤–µ–¥–µ–Ω–∏–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **–û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏** (PRESENT, ABSENT, EXCUSED)
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏–π** –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ PRESENT
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤** (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –¥–∞—Ç—ã, –æ—Å—Ç–∞—Ç–∫–∞)
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∏—Å–∞–Ω–∏—è** —É—Å–ª—É–≥ (PENDING ‚Üí IN_PROGRESS ‚Üí COMPLETED)
- ‚úÖ **–í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π** –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
- ‚úÖ **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏** –∫–ª–∏–µ–Ω—Ç–∞ (–æ–±—â–∞—è, –ø—Ä–æ—Ü–µ–Ω—Ç, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è)
- ‚úÖ **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º** (–±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ)
- ‚úÖ **–ê—É–¥–∏—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏** (–∫—Ç–æ –æ—Ç–º–µ—Ç–∏–ª, –∫–æ–≥–¥–∞ –æ—Ç–º–µ—Ç–∏–ª)
- ‚úÖ **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** —á–µ—Ä–µ–∑ React Query

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

### –ú–æ–¥–µ–ª—å: Attendance

```prisma
model Attendance {
  id                   String           @id @default(uuid())
  scheduleId           String           @map("schedule_id")
  clientId             String           @map("client_id")
  status               AttendanceStatus
  notes                String?
  subscriptionDeducted Boolean          @default(false) @map("subscription_deducted")
  createdAt            DateTime         @default(now()) @map("created_at")
  markedAt             DateTime?        @map("marked_at")
  markedBy             String?          @map("marked_by")
  subscriptionId       String?          @map("subscription_id")
  updatedAt            DateTime         @updatedAt @map("updated_at")

  client               Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  markedByUser         User?            @relation(fields: [markedBy], references: [id], onDelete: SetNull)
  schedule             Schedule         @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  subscription         Subscription?    @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@unique([clientId, scheduleId])
  @@index([clientId])
  @@index([scheduleId])
  @@index([subscriptionId])
  @@index([markedBy])
  @@index([createdAt])
  @@map("attendances")
}

enum AttendanceStatus {
  PRESENT  // –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  ABSENT   // –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  EXCUSED  // –£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞
}
```

### –ü–æ–ª—è

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | UUID | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| `scheduleId` | UUID | –°—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ (Schedule) |
| `clientId` | UUID | –°—Å—ã–ª–∫–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ (Client) |
| `status` | Enum | –°—Ç–∞—Ç—É—Å –ø–æ—Å–µ—â–µ–Ω–∏—è (PRESENT/ABSENT/EXCUSED) |
| `notes` | String? | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ |
| `subscriptionDeducted` | Boolean | –§–ª–∞–≥ —Å–ø–∏—Å–∞–Ω–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ |
| `createdAt` | DateTime | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ |
| `markedAt` | DateTime? | –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ—Ç–º–µ—Ç–∫–∏ |
| `markedBy` | UUID? | –ö—Ç–æ –æ—Ç–º–µ—Ç–∏–ª –ø–æ—Å–µ—â–µ–Ω–∏–µ (User) |
| `subscriptionId` | UUID? | –°–≤—è–∑–∞–Ω–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç |
| `updatedAt` | DateTime | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

### –°–≤—è–∑–∏

- **Client** (CASCADE): –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ —É–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ –∑–∞–ø–∏—Å–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
- **Schedule** (CASCADE): –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏—è —É–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ –∑–∞–ø–∏—Å–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
- **Subscription** (SET NULL): –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ —Å–≤—è–∑—å –æ–±–Ω—É–ª—è–µ—Ç—Å—è, –∑–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- **User** (SET NULL): –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞—É–¥–∏—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –Ω–æ —Å—Å—ã–ª–∫–∞ –æ–±–Ω—É–ª—è–µ—Ç—Å—è

### –ò–Ω–¥–µ–∫—Å—ã

```sql
CREATE INDEX idx_attendance_client_id ON attendances(client_id);
CREATE INDEX idx_attendance_schedule_id ON attendances(schedule_id);
CREATE INDEX idx_attendance_subscription_id ON attendances(subscription_id);
CREATE INDEX idx_attendance_marked_by ON attendances(marked_by);
CREATE INDEX idx_attendance_created_at ON attendances(created_at);
CREATE UNIQUE INDEX attendances_client_id_schedule_id_key ON attendances(client_id, schedule_id);
```

### –¢—Ä–∏–≥–≥–µ—Ä—ã

```sql
CREATE TRIGGER update_attendances_updated_at
BEFORE UPDATE ON attendances
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

---

## üîå Backend API

### –ë–∞–∑–æ–≤—ã–π URL
```
http://localhost:3000/api/attendance
```

### Endpoints

#### 1. –û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ
```http
POST /attendance
Authorization: Bearer <token>
Content-Type: application/json

{
  "scheduleId": "uuid",
  "clientId": "uuid",
  "status": "PRESENT",
  "notes": "–û–ø–æ–∑–¥–∞–ª –Ω–∞ 10 –º–∏–Ω—É—Ç"
}
```

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è Schedule –∏ Group
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å clientId + scheduleId)
3. –ï—Å–ª–∏ status = PRESENT:
   - –ü–æ–∏—Å–∫ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ –¥–ª—è client + group + date
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ (ACTIVE, –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –¥–∞—Ç, –µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫)
   - –°–ø–∏—Å–∞–Ω–∏–µ 1 –ø–æ—Å–µ—â–µ–Ω–∏—è (–¥–ª—è SINGLE_VISIT)
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ InvoiceItem.writeOffStatus:
     - PENDING ‚Üí IN_PROGRESS (–ø–µ—Ä–≤–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ)
     - IN_PROGRESS ‚Üí COMPLETED (–≤—Å–µ –ø–æ—Å–µ—â–µ–Ω–∏—è –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω—ã)
4. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ Attendance —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (markedBy, markedAt)

**Response 201:**
```json
{
  "id": "uuid",
  "scheduleId": "uuid",
  "clientId": "uuid",
  "status": "PRESENT",
  "notes": "–û–ø–æ–∑–¥–∞–ª –Ω–∞ 10 –º–∏–Ω—É—Ç",
  "subscriptionDeducted": true,
  "subscriptionId": "uuid",
  "markedBy": "user-uuid",
  "markedAt": "2025-11-17T10:30:00.000Z",
  "createdAt": "2025-11-17T10:30:00.000Z",
  "updatedAt": "2025-11-17T10:30:00.000Z",
  "client": {
    "id": "uuid",
    "firstName": "–ò–≤–∞–Ω",
    "lastName": "–ü–µ—Ç—Ä–æ–≤"
  },
  "schedule": {
    "id": "uuid",
    "startTime": "2025-11-17T10:00:00.000Z",
    "endTime": "2025-11-17T11:00:00.000Z",
    "group": {
      "id": "uuid",
      "name": "–í–æ–∫–∞–ª - —Å—Ä–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞"
    }
  },
  "subscription": {
    "id": "uuid",
    "remainingVisits": 7,
    "subscriptionType": {
      "name": "8 –∑–∞–Ω—è—Ç–∏–π"
    }
  },
  "markedByUser": {
    "id": "uuid",
    "firstName": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä"
  }
}
```

#### 2. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
```http
GET /attendance?scheduleId=uuid&groupId=uuid&clientId=uuid&status=PRESENT&dateFrom=2025-11-01&dateTo=2025-11-30&page=1&limit=50
Authorization: Bearer <token>
```

**Response 200:**
```json
{
  "data": [/* Attendance[] */],
  "total": 100,
  "page": 1,
  "limit": 50,
  "totalPages": 2
}
```

#### 3. –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –ø–æ –∑–∞–Ω—è—Ç–∏—é
```http
GET /attendance/by-schedule/:scheduleId
Authorization: Bearer <token>
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ AttendanceSheet –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è.

**Response 200:** `Attendance[]` (–≤—Å–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ scheduleId)

#### 4. –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–ª–∏–µ–Ω—Ç–∞
```http
GET /attendance/stats/:clientId?dateFrom=2025-11-01&dateTo=2025-11-30
Authorization: Bearer <token>
```

**Response 200:**
```json
{
  "totalAttendances": 24,
  "presentCount": 20,
  "absentCount": 2,
  "excusedCount": 2,
  "attendanceRate": 83.33,
  "lastAttendance": {
    "id": "uuid",
    "scheduleId": "uuid",
    "status": "PRESENT",
    "markedAt": "2025-11-17T10:30:00.000Z",
    "schedule": {
      "group": {
        "name": "–í–æ–∫–∞–ª - —Å—Ä–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞"
      }
    }
  }
}
```

#### 5. –ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ ID
```http
GET /attendance/:id
Authorization: Bearer <token>
```

#### 6. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Å–µ—â–µ–Ω–∏—è
```http
PATCH /attendance/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "status": "ABSENT",
  "notes": "–ë–æ–ª–µ–ª"
}
```

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞:**

| –°—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å | –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å | –î–µ–π—Å—Ç–≤–∏–µ |
|---------------|--------------|----------|
| PRESENT | ABSENT/EXCUSED | –í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–µ—â–µ–Ω–∏—è (+1 –∫ remainingVisits), –æ—Ç–∫–∞—Ç writeOffStatus |
| ABSENT/EXCUSED | PRESENT | –°–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è (-1 –æ—Ç remainingVisits), –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ writeOffStatus |
| ABSENT | EXCUSED | –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ |

**Response 200:** –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å Attendance

#### 7. –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ—Å–µ—â–µ–Ω–∏—è
```http
DELETE /attendance/:id
Authorization: Bearer <token>
```

**–†–æ–ª—å:** –¢–æ–ª—å–∫–æ ADMIN

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**
1. –ï—Å–ª–∏ –∑–∞–ø–∏—Å—å –∏–º–µ–ª–∞ status = PRESENT:
   - –í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–µ—â–µ–Ω–∏—è (+1 –∫ remainingVisits)
   - –û—Ç–∫–∞—Ç writeOffStatus (COMPLETED ‚Üí IN_PROGRESS –∏–ª–∏ IN_PROGRESS ‚Üí PENDING)
2. –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î

**Response 200:**
```json
{
  "message": "Attendance record deleted successfully"
}
```

---

## üß† –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### 1. –ü–æ–∏—Å–∫ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞

**–ú–µ—Ç–æ–¥:** `findValidSubscription(clientId, groupId, scheduleDate)`

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
```typescript
1. –ù–∞–π—Ç–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç WHERE:
   - clientId = clientId
   - groupId = groupId
   - status = 'ACTIVE'
   - scheduleDate >= startDate
   - scheduleDate <= endDate
   - (remainingVisits IS NULL OR remainingVisits > 0)

2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ:
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: SINGLE_VISIT > UNLIMITED
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: endDate ASC (–∏—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–µ—Ä–≤—ã–º–∏)

3. –í–æ–∑–≤—Ä–∞—Ç –ø–µ—Ä–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞
```

### 2. –°–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è

**–ú–µ—Ç–æ–¥:** `deductVisit(subscriptionId)`

**–£—Å–ª–æ–≤–∏—è:**
- –¢–∏–ø –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ = SINGLE_VISIT
- `remainingVisits > 0`

**–î–µ–π—Å—Ç–≤–∏—è:**
```typescript
1. subscription.remainingVisits -= 1
2. –û–±–Ω–æ–≤–∏—Ç—å Subscription –≤ –ë–î
3. –û–±–Ω–æ–≤–∏—Ç—å InvoiceItem.writeOffStatus
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–ø–∏—Å–∞–Ω–∏—è —É—Å–ª—É–≥–∏

**–ú–µ—Ç–æ–¥:** `updateInvoiceItemStatus(subscriptionId)`

**–õ–æ–≥–∏–∫–∞:**
```typescript
1. –ù–∞–π—Ç–∏ InvoiceItem WHERE:
   - Invoice.subscriptionId = subscriptionId
   - serviceType = 'SUBSCRIPTION'

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
   - –ï—Å–ª–∏ remainingVisits === null (UNLIMITED):
     - writeOffStatus = IN_PROGRESS (–ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è)
   - –ï—Å–ª–∏ remainingVisits > 0:
     - writeOffStatus = IN_PROGRESS
   - –ï—Å–ª–∏ remainingVisits === 0:
     - writeOffStatus = COMPLETED

3. –û–±–Ω–æ–≤–∏—Ç—å InvoiceItem.writeOffStatus
```

### 4. –í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–µ—â–µ–Ω–∏—è

**–ú–µ—Ç–æ–¥:** `refundVisit(attendanceId)`

**–£—Å–ª–æ–≤–∏—è:**
- –ó–∞–ø–∏—Å—å –∏–º–µ–µ—Ç subscriptionDeducted = true
- –°–≤—è–∑–∞–Ω —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–º (subscriptionId !== null)

**–î–µ–π—Å—Ç–≤–∏—è:**
```typescript
1. subscription.remainingVisits += 1
2. –û–±–Ω–æ–≤–∏—Ç—å Subscription –≤ –ë–î
3. –û—Ç–∫–∞—Ç–∏—Ç—å InvoiceItem.writeOffStatus:
   - COMPLETED ‚Üí IN_PROGRESS (–µ—Å–ª–∏ remainingVisits > 0)
   - IN_PROGRESS ‚Üí PENDING (–µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –ø–µ—Ä–≤–∞—è –æ—Ç–º–µ—Ç–∫–∞)
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### Backend

```
backend/src/attendance/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ create-attendance.dto.ts          (18 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ update-attendance.dto.ts          (13 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ attendance-filter.dto.ts          (42 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ attendance.service.ts                 (596 —Å—Ç—Ä–æ–∫)
‚îú‚îÄ‚îÄ attendance.controller.ts              (71 —Å—Ç—Ä–æ–∫)
‚îî‚îÄ‚îÄ attendance.module.ts                  (12 —Å—Ç—Ä–æ–∫)
```

**–§–∞–π–ª—ã:**
- **attendance.service.ts** - –û—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
  - `mark()` - –æ—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ —Å–ø–∏—Å–∞–Ω–∏–µ–º
  - `findAll()` - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
  - `findBySchedule()` - –≤—Å–µ –ø–æ—Å–µ—â–µ–Ω–∏—è –¥–ª—è –∑–∞–Ω—è—Ç–∏—è
  - `getClientStats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
  - `findOne()` - –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –ø–æ ID
  - `update()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º/—Å–ø–∏—Å–∞–Ω–∏–µ–º
  - `remove()` - —É–¥–∞–ª–µ–Ω–∏–µ —Å –æ—Ç–∫–∞—Ç–æ–º –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞
  - `findValidSubscription()` - –ø–æ–∏—Å–∫ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞
  - `updateInvoiceItemStatus()` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ writeOffStatus
  - `revertInvoiceItemStatus()` - –æ—Ç–∫–∞—Ç writeOffStatus

- **attendance.controller.ts** - REST API endpoints
  - `POST /attendance` - mark()
  - `GET /attendance` - findAll()
  - `GET /attendance/by-schedule/:scheduleId` - findBySchedule()
  - `GET /attendance/stats/:clientId` - getClientStats()
  - `GET /attendance/:id` - findOne()
  - `PATCH /attendance/:id` - update()
  - `DELETE /attendance/:id` - remove() (ADMIN only)

### Frontend

```
frontend/
‚îú‚îÄ‚îÄ app/(dashboard)/schedule/
‚îÇ   ‚îî‚îÄ‚îÄ attendance-sheet.tsx              (285 —Å—Ç—Ä–æ–∫)
‚îÇ
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ use-attendance.ts                 (140 —Å—Ç—Ä–æ–∫)
‚îÇ
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ attendance.ts                 (101 —Å—Ç—Ä–æ–∫)
‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ       ‚îî‚îÄ‚îÄ attendance.ts                 (113 —Å—Ç—Ä–æ–∫)
```

**–§–∞–π–ª—ã:**
- **attendance-sheet.tsx** - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
  - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (present, absent, excused, not marked)
  - –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø—ã —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞–º–∏
  - –ö–Ω–æ–ø–∫–∏ –æ—Ç–º–µ—Ç–∫–∏ (Present/Absent/Excused)
  - –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
  - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π

- **use-attendance.ts** - React Query hooks
  - `useAttendances()` - –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
  - `useAttendanceBySchedule()` - —Å–ø–∏—Å–æ–∫ –¥–ª—è –∑–∞–Ω—è—Ç–∏—è
  - `useAttendanceStats()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
  - `useAttendance()` - –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å
  - `useMarkAttendance()` - —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
  - `useUpdateAttendance()` - –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
  - `useDeleteAttendance()` - —É–¥–∞–ª–∏—Ç—å (ADMIN)

- **attendance.ts (API)** - HTTP –∫–ª–∏–µ–Ω—Ç
  - `attendanceApi.mark()` - POST /attendance
  - `attendanceApi.getAll()` - GET /attendance
  - `attendanceApi.getBySchedule()` - GET /attendance/by-schedule/:id
  - `attendanceApi.getClientStats()` - GET /attendance/stats/:id
  - `attendanceApi.getById()` - GET /attendance/:id
  - `attendanceApi.update()` - PATCH /attendance/:id
  - `attendanceApi.delete()` - DELETE /attendance/:id

- **attendance.ts (Types)** - TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
  - `Attendance` - –æ—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å
  - `AttendanceStatus` - enum
  - `AttendanceStats` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  - `CreateAttendanceDto` - DTO —Å–æ–∑–¥–∞–Ω–∏—è
  - `UpdateAttendanceDto` - DTO –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  - `AttendanceFilterDto` - DTO —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
  - `PaginatedAttendanceResponse` - –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
  - `ClientWithSubscription` - –∫–ª–∏–µ–Ω—Ç —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–º

---

## üé® Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### AttendanceSheet Component

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `frontend/app/(dashboard)/schedule/attendance-sheet.tsx`

**–ü—Ä–æ–ø—Å—ã:**
```typescript
interface AttendanceSheetProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  scheduleId: string;
  groupId: string;
  groupName: string;
  scheduleDate: Date;
}
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
1. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —à–∞–ø–∫–µ:**
   - –í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤
   - –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç (–∑–µ–ª—ë–Ω—ã–π)
   - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (–∫—Ä–∞—Å–Ω—ã–π)
   - –£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ (–∂—ë–ª—Ç—ã–π)
   - –ù–µ –æ—Ç–º–µ—á–µ–Ω—ã (—Å–µ—Ä—ã–π)

2. **–°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤:**
   - –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞
   - –°—Ç–∞—Ç—É—Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞ (–∏–∫–æ–Ω–∫–∞: ‚úÖ –≤–∞–ª–∏–¥–µ–Ω, ‚ùå –Ω–µ–≤–∞–ª–∏–¥–µ–Ω)
   - –û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–µ—â–µ–Ω–∏–π (–¥–ª—è SINGLE_VISIT)
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏ (< 3 –ø–æ—Å–µ—â–µ–Ω–∏–π)
   - –ö–Ω–æ–ø–∫–∏ –æ—Ç–º–µ—Ç–∫–∏: Present / Absent / Excused
   - –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–µ—Å–ª–∏ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω)

3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:**
   - –ó–∞–≥—Ä—É–∑–∫–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã (`useSubscriptions`)
   - –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –¥–ª—è –∑–∞–Ω—è—Ç–∏—è (`useAttendanceBySchedule`)
   - –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ clientId

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π:**
   - –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
   - –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (React Query invalidation)
   - Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ

**–ü—Ä–∏–º–µ—Ä UI:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å: –í–æ–∫–∞–ª - —Å—Ä–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞            ‚îÇ
‚îÇ 17.11.2025 10:00 - 11:00                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ ‚îÇ  12  ‚îÇ ‚îÇ  8   ‚îÇ ‚îÇ  2   ‚îÇ ‚îÇ  2   ‚îÇ           ‚îÇ
‚îÇ ‚îÇ–í—Å–µ–≥–æ ‚îÇ ‚îÇ‚úÖ    ‚îÇ ‚îÇ‚ùå    ‚îÇ ‚îÇ‚ö†Ô∏è    ‚îÇ           ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ö–ª–∏–µ–Ω—Ç—ã                                         ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤                    ‚úÖ 7 –ø–æ—Å–µ—â–µ–Ω–∏–π  ‚îÇ
‚îÇ [Present] [Absent] [Excused]                   ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ –ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞                 ‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç     ‚îÇ
‚îÇ ‚úì PRESENT                                       ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ –ê–ª–µ–∫—Å–µ–π –ò–≤–∞–Ω–æ–≤                 ‚ùå –ò—Å—Ç—ë–∫        ‚îÇ
‚îÇ –ê–±–æ–Ω–µ–º–µ–Ω—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω                        ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ –ï–ª–µ–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞                 ‚ö†Ô∏è 2 –ø–æ—Å–µ—â–µ–Ω–∏—è  ‚îÇ
‚îÇ [Present] [Absent] [Excused]   ‚ö†Ô∏è –°–∫–æ—Ä–æ –∏—Å—Ç–µ—á—ë—Ç‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

### 1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º –†–∞—Å–ø–∏—Å–∞–Ω–∏—è

**–§–∞–π–ª:** `frontend/app/(dashboard)/schedule/page.tsx`

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```typescript
// –ò–º–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
import { AttendanceSheet } from './attendance-sheet';

// –°–æ—Å—Ç–æ—è–Ω–∏–µ
const [attendanceSheetOpen, setAttendanceSheetOpen] = useState(false);
const [selectedSchedule, setSelectedSchedule] = useState<Schedule | null>(null);

// –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏
const handleMarkAttendance = (schedule: Schedule) => {
  setSelectedSchedule(schedule);
  setAttendanceSheetOpen(true);
};

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥
<AttendanceSheet
  open={attendanceSheetOpen}
  onOpenChange={setAttendanceSheetOpen}
  scheduleId={selectedSchedule?.id || ''}
  groupId={selectedSchedule?.groupId || ''}
  groupName={selectedSchedule?.group?.name || ''}
  scheduleDate={new Date(selectedSchedule?.startTime || '')}
/>
```

**–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞:**
- –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å" –≤ CalendarEventDialog
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç AttendanceSheet —Å–ø—Ä–∞–≤–∞ –æ—Ç —ç–∫—Ä–∞–Ω–∞ (Sheet component)

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º –ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤

**Backend:**
```typescript
// attendance.service.ts

async findValidSubscription(clientId: string, groupId: string, date: Date) {
  return this.prisma.subscription.findFirst({
    where: {
      clientId,
      groupId,
      status: 'ACTIVE',
      startDate: { lte: date },
      endDate: { gte: date },
      OR: [
        { remainingVisits: { gt: 0 } },
        { remainingVisits: null } // UNLIMITED
      ]
    },
    include: { subscriptionType: true },
    orderBy: [
      { subscriptionType: { type: 'asc' } }, // SINGLE_VISIT first
      { endDate: 'asc' } // Expiring first
    ]
  });
}

async deductVisit(subscription: Subscription) {
  if (subscription.subscriptionType.type === 'SINGLE_VISIT') {
    await this.prisma.subscription.update({
      where: { id: subscription.id },
      data: { remainingVisits: { decrement: 1 } }
    });
  }
}
```

**Frontend:**
```typescript
// attendance-sheet.tsx

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
const { data: subscriptions } = useSubscriptions({
  groupId: groupId,
  status: 'ACTIVE'
});

// –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞
const isSubscriptionValid = (clientId: string) => {
  const subscription = subscriptions?.data.find(s => s.clientId === clientId);
  if (!subscription) return false;

  const isActive = subscription.status === 'ACTIVE';
  const isInDateRange =
    new Date(subscription.startDate) <= scheduleDate &&
    new Date(subscription.endDate) >= scheduleDate;
  const hasVisits =
    subscription.remainingVisits === null ||
    subscription.remainingVisits > 0;

  return isActive && isInDateRange && hasVisits;
};
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º –°—á–µ—Ç–æ–≤

**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ writeOffStatus:**
```typescript
// attendance.service.ts

async updateInvoiceItemStatus(subscriptionId: string) {
  // 1. –ù–∞–π—Ç–∏ InvoiceItem
  const invoiceItem = await this.prisma.invoiceItem.findFirst({
    where: {
      invoice: { subscriptionId },
      serviceType: 'SUBSCRIPTION'
    },
    include: { invoice: { include: { subscription: true } } }
  });

  if (!invoiceItem) return;

  const subscription = invoiceItem.invoice.subscription;

  // 2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
  let newStatus: WriteOffStatus;

  if (subscription.remainingVisits === null) {
    // UNLIMITED - –≤—Å–µ–≥–¥–∞ IN_PROGRESS –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –æ—Ç–º–µ—Ç–∫–∏
    newStatus = 'IN_PROGRESS';
  } else if (subscription.remainingVisits === 0) {
    // –í—Å–µ –ø–æ—Å–µ—â–µ–Ω–∏—è –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω—ã
    newStatus = 'COMPLETED';
  } else {
    // –ï—â—ë –µ—Å—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏—è
    newStatus = 'IN_PROGRESS';
  }

  // 3. –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
  await this.prisma.invoiceItem.update({
    where: { id: invoiceItem.id },
    data: { writeOffStatus: newStatus }
  });
}
```

### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–æ–¥—É–ª–µ–º –ö–ª–∏–µ–Ω—Ç–æ–≤

**ClientHistoryCard - –≤–∫–ª–∞–¥–∫–∞ "–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å":**
```typescript
// client-history-card.tsx (—Å—Ç—Ä–æ–∫–∏ 256-270)

<TabsContent value="attendance">
  <div className="text-sm text-muted-foreground">
    –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
  </div>
</TabsContent>
```

**–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è:**
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥—Ä—É–ø–ø–∞–º –∏ –¥–∞—Ç–∞–º
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
- –ü—Ä–æ–≥—Ä–µ—Å—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è

**Backend API:**
```typescript
import { attendanceApi } from '@/lib/api/attendance';

const attendance = await attendanceApi.mark({
  scheduleId: 'schedule-uuid',
  clientId: 'client-uuid',
  status: 'PRESENT'
});

console.log(`–ü–æ—Å–µ—â–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ: ${attendance.status}`);
console.log(`–°–ø–∏—Å–∞–Ω –∞–±–æ–Ω–µ–º–µ–Ω—Ç: ${attendance.subscriptionDeducted}`);
console.log(`–û—Å—Ç–∞–ª–æ—Å—å –ø–æ—Å–µ—â–µ–Ω–∏–π: ${attendance.subscription?.remainingVisits}`);
```

**React Hook:**
```typescript
import { useMarkAttendance } from '@/hooks/use-attendance';

const markAttendance = useMarkAttendance();

const handleMarkPresent = async () => {
  try {
    await markAttendance.mutateAsync({
      scheduleId,
      clientId,
      status: 'PRESENT'
    });
    toast.success('–ü–æ—Å–µ—â–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ!');
  } catch (error) {
    toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –ø–æ—Å–µ—â–µ–Ω–∏—è');
  }
};
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –¥–ª—è –∑–∞–Ω—è—Ç–∏—è

```typescript
import { useAttendanceBySchedule } from '@/hooks/use-attendance';

const AttendanceList = ({ scheduleId }: { scheduleId: string }) => {
  const { data: attendances, isLoading } = useAttendanceBySchedule(scheduleId);

  if (isLoading) return <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>;

  return (
    <ul>
      {attendances?.map(attendance => (
        <li key={attendance.id}>
          {attendance.client.firstName} {attendance.client.lastName} - {attendance.status}
        </li>
      ))}
    </ul>
  );
};
```

### 3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞

```typescript
import { useAttendanceStats } from '@/hooks/use-attendance';

const ClientStats = ({ clientId }: { clientId: string }) => {
  const { data: stats } = useAttendanceStats(
    clientId,
    '2025-11-01',
    '2025-11-30'
  );

  return (
    <div>
      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–æ—è–±—Ä—å 2025</h3>
      <p>–í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π: {stats?.totalAttendances}</p>
      <p>–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª: {stats?.presentCount}</p>
      <p>–ü—Ä–æ—Ü–µ–Ω—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏: {stats?.attendanceRate}%</p>
    </div>
  );
};
```

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

```typescript
import { useUpdateAttendance } from '@/hooks/use-attendance';

const updateAttendance = useUpdateAttendance();

const handleChangeStatus = async (attendanceId: string) => {
  await updateAttendance.mutateAsync({
    id: attendanceId,
    data: {
      status: 'EXCUSED',
      notes: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞'
    }
  });
};
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ó–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ

**Backend:**
- [x] Prisma Schema (Attendance –º–æ–¥–µ–ª—å, enum AttendanceStatus)
- [x] Attendance –º–æ–¥—É–ª—å (Service, Controller, DTOs)
- [x] 7 API endpoints (POST, GET, GET/:id, PATCH, DELETE, by-schedule, stats)
- [x] –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ InvoiceItem.writeOffStatus
- [x] –í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏/–∏–∑–º–µ–Ω–µ–Ω–∏–∏
- [x] –ê—É–¥–∏—Ç –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (markedBy, markedAt)

**Database:**
- [x] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ subscriptionId, markedBy, markedAt, updatedAt)
- [x] –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- [x] –¢—Ä–∏–≥–≥–µ—Ä—ã auto-update –¥–ª—è updated_at
- [x] Foreign key constraints

**Frontend:**
- [x] TypeScript —Ç–∏–ø—ã (Attendance, DTOs, Stats)
- [x] API client (attendanceApi —Å 7 –º–µ—Ç–æ–¥–∞–º–∏)
- [x] React Query hooks (7 —Ö—É–∫–æ–≤)
- [x] AttendanceSheet –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (285 —Å—Ç—Ä–æ–∫)
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Schedule (–±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å)
- [x] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- [x] –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
- [x] –ú–æ–¥—É–ª—å –†–∞—Å–ø–∏—Å–∞–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ –≤ CalendarEventDialog)
- [x] –ú–æ–¥—É–ª—å –ê–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤ (—Å–ø–∏—Å–∞–Ω–∏–µ remainingVisits)
- [x] –ú–æ–¥—É–ª—å –°—á–µ—Ç–æ–≤ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ writeOffStatus)
- [x] –ú–æ–¥—É–ª—å –ö–ª–∏–µ–Ω—Ç–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞ –≤–∫–ª–∞–¥–∫–∏ "–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å")

### –û—Ç–ª–æ–∂–µ–Ω–æ –Ω–∞ –±—É–¥—É—â–µ–µ üî¥

- [ ] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –≤ ClientHistoryCard
- [ ] –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (–≥—Ä–∞—Ñ–∏–∫–∏, —Ç—Ä–µ–Ω–¥—ã)
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (Excel, PDF)
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∏–∑–∫–æ–π –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –ø–æ –±–æ–ª–µ–∑–Ω–∏
- [ ] –ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)

---

## üîß –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

### –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã

**–§–∞–π–ª:** `backend/attendance_migration.sql` (52 —Å—Ç—Ä–æ–∫–∏)

**–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:**
```sql
-- 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
ALTER TABLE attendances
ADD COLUMN IF NOT EXISTS subscription_id UUID,
ADD COLUMN IF NOT EXISTS marked_by UUID,
ADD COLUMN IF NOT EXISTS marked_at TIMESTAMP,
ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP DEFAULT NOW();

-- 2. –°–æ–∑–¥–∞–Ω–∏–µ foreign key constraints
ALTER TABLE attendances
ADD CONSTRAINT fk_attendance_subscription
  FOREIGN KEY (subscription_id)
  REFERENCES subscriptions(id)
  ON DELETE SET NULL;

ALTER TABLE attendances
ADD CONSTRAINT fk_attendance_marked_by
  FOREIGN KEY (marked_by)
  REFERENCES users(id)
  ON DELETE SET NULL;

-- 3. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
CREATE INDEX IF NOT EXISTS idx_attendance_subscription_id
  ON attendances(subscription_id);

CREATE INDEX IF NOT EXISTS idx_attendance_marked_by
  ON attendances(marked_by);

CREATE INDEX IF NOT EXISTS idx_attendance_created_at
  ON attendances(created_at);

-- 4. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –¥–ª—è auto-update
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_attendances_updated_at
BEFORE UPDATE ON attendances
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();
```

**–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:**
```bash
# –ß–µ—Ä–µ–∑ Node.js —Å–∫—Ä–∏–ø—Ç
node backend/run-attendance-migration-fixed.js

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ Prisma
npx prisma db push
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [ROADMAP.md](../ROADMAP.md) - Week 8: –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –∏ –ü–ª–∞—Ç–µ–∂–∏
- [DATABASE_SCHEMA.md](../DATABASE_SCHEMA.md) - –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î
- [–ú–æ–¥—É–ª—å 6: –ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã](./06_SUBSCRIPTIONS_MODULE.md) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞–º–∏
- [–ú–æ–¥—É–ª—å 2: –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ](./02_SCHEDULE_MODULE.md) - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
- [–ú–æ–¥—É–ª—å 6: –°—á–µ—Ç–∞](./06_INVOICES_MODULE.md) - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ writeOffStatus
- [–ú–æ–¥—É–ª—å 1: CRM](./01_CRM_MODULE.md) - –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

1. **–ò–Ω–¥–µ–∫—Å—ã:**
   - `client_id` - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É
   - `schedule_id` - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –∑–∞–Ω—è—Ç–∏—é
   - `subscription_id` - –±—ã—Å—Ç—Ä–∞—è —Å–≤—è–∑—å —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞–º–∏
   - `marked_by` - –∞—É–¥–∏—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
   - `created_at` - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ

2. **Eager loading:**
   ```typescript
   include: {
     client: true,
     schedule: { include: { group: true } },
     subscription: { include: { subscriptionType: true } },
     markedByUser: true
   }
   ```

3. **–ü–∞–≥–∏–Ω–∞—Ü–∏—è:**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: page=1, limit=50
   - –ú–∞–∫—Å–∏–º—É–º: limit=100

4. **React Query –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - `staleTime: 30s` - –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã 30 —Å–µ–∫—É–Ω–¥
   - –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
   - –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è UX

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-11-17
**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
