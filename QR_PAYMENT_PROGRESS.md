# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ QR-–∫–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã

**–î–∞—Ç–∞:** 19 –Ω–æ—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** 70% –∑–∞–≤–µ—Ä—à–µ–Ω–æ (7 –∏–∑ 10 —ç—Ç–∞–ø–æ–≤)

---

## ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —ç—Ç–∞–ø—ã

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚úÖ
**–§–∞–π–ª:** `backend/package.json`

–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø–∞–∫–µ—Ç—ã:
- `qrcode` v1.5.4 - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–æ–≤
- `@types/qrcode` - TypeScript —Ç–∏–ø—ã

```bash
npm install qrcode @types/qrcode --save-dev
```

---

### 2. –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ‚úÖ
**–§–∞–π–ª:** `backend/prisma/schema.prisma`

–°–æ–∑–¥–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ `OrganizationDetails` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:

```prisma
model OrganizationDetails {
  id              String   @id @default(uuid())

  // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  organizationName String  @map("organization_name")
  inn             String
  kpp             String

  // –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
  treasuryAccount String  @map("treasury_account")  // –ö–∞–∑–Ω–∞—á–µ–π—Å–∫–∏–π —Å—á–µ—Ç
  bankName        String  @map("bank_name")
  bic             String  // –ë–ò–ö
  correspAcc      String  @map("corresp_acc")

  // –ë—é–¥–∂–µ—Ç–Ω—ã–µ –∫–æ–¥—ã
  defaultKBK      String  @map("default_kbk")      // –ö–ë–ö (20 —Å–∏–º–≤–æ–ª–æ–≤)
  defaultOKTMO    String  @map("default_oktmo")    // –û–ö–¢–ú–û (8 –∏–ª–∏ 11 —Å–∏–º–≤–æ–ª–æ–≤)

  isPrimary       Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è:**
```bash
npx prisma db push
```

---

### 3. QR Generator Service ‚úÖ
**–§–∞–π–ª:** `backend/src/invoices/qr/qr-generator.service.ts`

–°–æ–∑–¥–∞–Ω —Å–µ—Ä–≤–∏—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–æ–≤ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö:

**–ú–µ—Ç–æ–¥—ã:**
- `generateBuffer(data, options)` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è PNG –∫–∞–∫ Buffer
- `generateDataURL(data, options)` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Data URL –¥–ª—è HTML
- `generateSVG(data, options)` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–≥–æ SVG
- `generateBoth(data, options)` - –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è Buffer –∏ Data URL

**–û–ø—Ü–∏–∏:**
- `errorCorrectionLevel` - —É—Ä–æ–≤–µ–Ω—å –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫ (L, M, Q, H)
- `width` - —à–∏—Ä–∏–Ω–∞ QR-–∫–æ–¥–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 300)
- `margin` - –æ—Ç—Å—Ç—É–ø—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4)

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
```typescript
const qrService = new QRGeneratorService();
const { buffer, dataUrl } = await qrService.generateBoth(paymentString);
```

---

### 4. Payment Data Builder ‚úÖ
**–§–∞–π–ª:** `backend/src/invoices/qr/qr-payment-data.builder.ts`

–°–æ–∑–¥–∞–Ω –∫–ª–∞—Å—Å –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ì–û–°–¢ –† 56042-2014

**–ú–µ—Ç–æ–¥—ã:**
- `buildBudgetPaymentString(data)` - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ –ì–û–°–¢
- `validate(data)` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
- `escape(value)` - —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
- `formatDocDate(date)` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≤ –î–î–ú–ú–ì–ì–ì–ì
- `formatPaymPeriod(date)` - —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –≤ –ú–ú–î–î–ì–ì–ì–ì

---

### 5. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å InvoicesService ‚úÖ
**–§–∞–π–ª:** `backend/src/invoices/invoices.service.ts`

–î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã:

```typescript
async getOrganizationDetails() {
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ –ë–î
}

async generateQRCode(invoiceId: string): Promise<{
  buffer: Buffer;
  dataUrl: string;
  paymentData: BudgetPaymentData;
}> {
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –¥–ª—è —Å—á–µ—Ç–∞
}
```

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –ø–æ –ì–û–°–¢

---

### 6. API Endpoints ‚úÖ
**–§–∞–π–ª:** `backend/src/invoices/invoices.controller.ts`

–î–æ–±–∞–≤–ª–µ–Ω—ã endpoints:

| Method | Endpoint | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| GET | `/api/invoices/:id/qr` | –°–∫–∞—á–∞—Ç—å QR-–∫–æ–¥ –∫–∞–∫ PNG |
| GET | `/api/invoices/:id/qr-data-url` | –ü–æ–ª—É—á–∏—Ç—å QR –∫–∞–∫ Data URL + –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞ |
| POST | `/api/invoices/:id/send-qr-email` | –û—Ç–ø—Ä–∞–≤–∏—Ç—å QR –Ω–∞ email (–∑–∞–≥–ª—É—à–∫–∞) |

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ `/api/invoices/:id/qr-data-url`:**
```json
{
  "dataUrl": "data:image/png;base64,...",
  "paymentData": {
    "Name": "–ì–ë–£–ö \"–ö—É–ª—å—Ç—É—Ä–Ω—ã–π —Ü–µ–Ω—Ç—Ä –ê—Ä—Ç—Å–í–ê–û\"",
    "Sum": 5000,
    ...
  }
}
```

---

### 7. Seed –¥–∞–Ω–Ω—ã—Ö ‚úÖ
**–§–∞–π–ª:** `backend/prisma/seed.ts`

–î–æ–±–∞–≤–ª–µ–Ω seed –¥–ª—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:

```typescript
const organizationDetails = await prisma.organizationDetails.upsert({
  where: { id: 'default-org' },
  update: {},
  create: {
    id: 'default-org',
    organizationName: '–ì–ë–£–ö "–ö—É–ª—å—Ç—É—Ä–Ω—ã–π —Ü–µ–Ω—Ç—Ä –ê—Ä—Ç—Å–í–ê–û"',
    inn: '7707083893',
    kpp: '770701001',
    treasuryAccount: '40302810012345678901',
    bankName: '–ì–£ –ë–∞–Ω–∫–∞ –†–æ—Å—Å–∏–∏ –ø–æ –¶–§–û',
    bic: '044525000',
    correspAcc: '30101810100000000000',
    defaultKBK: '00000000000000000130',
    defaultOKTMO: '45382000',
    isPrimary: true,
  },
});
```

**–ó–∞–ø—É—â–µ–Ω seed:**
```bash
npx ts-node prisma/seed.ts
```

---

## ‚è≥ –°–ª–µ–¥—É—é—â–∏–µ —ç—Ç–∞–ø—ã

### 8. React Email Template (–æ—Å—Ç–∞–ª–æ—Å—å)
**–§–∞–π–ª:** `backend/src/email/templates/InvoiceQREmail.tsx`

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞—Ç—å React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è email
2. –î–æ–±–∞–≤–∏—Ç—å QR-–∫–æ–¥ —á–µ—Ä–µ–∑ Data URL
3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—á–µ—Ç–µ
4. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–ø–ª–∞—Ç–µ
5. –°—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å –≤ –µ–¥–∏–Ω–æ–º —Å—Ç–∏–ª–µ ArtsVAO

---

### 9. EmailService Integration (–æ—Å—Ç–∞–ª–æ—Å—å)
**–§–∞–π–ª:** `backend/src/email/email.service.ts`

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `sendInvoiceWithQR()`
2. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å React Email —à–∞–±–ª–æ–Ω–æ–º
3. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ EmailLog
4. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å–µ–º

---

### 10. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ—Å—Ç–∞–ª–æ—Å—å)
**–ó–∞–¥–∞—á–∏:**
- –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å—á–µ—Ç
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR —á–µ—Ä–µ–∑ API
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å QR –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö –±–∞–Ω–∫–∞—Ö (–°–±–µ—Ä–±–∞–Ω–∫, –¢–∏–Ω—å–∫–æ—Ñ—Ñ, –í–¢–ë)
- Unit-—Ç–µ—Å—Ç—ã –¥–ª—è QRPaymentDataBuilder
- E2E —Ç–µ—Å—Ç—ã –¥–ª—è API endpoints

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ/–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `backend/src/invoices/qr/qr-generator.service.ts` (121 —Å—Ç—Ä–æ–∫–∞)
2. `backend/src/invoices/qr/qr-payment-data.builder.ts` (275 —Å—Ç—Ä–æ–∫)
3. `backend/src/invoices/invoices.service.ts` (+95 —Å—Ç—Ä–æ–∫)
4. `backend/src/invoices/invoices.controller.ts` (+40 —Å—Ç—Ä–æ–∫)
5. `backend/src/invoices/invoices.module.ts` (+2 —Å—Ç—Ä–æ–∫–∏)
6. `backend/prisma/schema.prisma` (–º–æ–¥–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–∞–Ω–µ–µ)
7. `backend/prisma/seed.ts` (+19 —Å—Ç—Ä–æ–∫)
8. `backend/package.json` (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ä–∞–Ω–µ–µ)

### –†–∞–∑–º–µ—Ä –∫–æ–¥–∞:
- TypeScript: ~550 —Å—Ç—Ä–æ–∫
- Prisma Schema: +25 —Å—Ç—Ä–æ–∫
- Seed: +19 —Å—Ç—Ä–æ–∫
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: ~600 —Å—Ç—Ä–æ–∫
- **–í—Å–µ–≥–æ:** ~1200 —Å—Ç—Ä–æ–∫

---

## üéØ –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏:

1. **React Email Template** - ~1.5 —á–∞—Å–∞
   - –°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç InvoiceQREmail.tsx
   - –í—Å—Ç—Ä–æ–∏—Ç—å QR-–∫–æ–¥ —á–µ—Ä–µ–∑ Data URL
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–ø–ª–∞—Ç–µ

2. **EmailService –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - ~1 —á–∞—Å
   - –ú–µ—Ç–æ–¥ sendInvoiceWithQR()
   - –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ React —à–∞–±–ª–æ–Ω–∞
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - ~2 —á–∞—Å–∞
   - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ QR –≤ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö
   - –ù–∞–ø–∏—Å–∞–Ω–∏–µ unit-—Ç–µ—Å—Ç–æ–≤

### –û—Ü–µ–Ω–∫–∞ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏:
**~4-5 —á–∞—Å–æ–≤** –¥–ª—è –ø–æ–ª–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

---

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –†–µ–∫–≤–∏–∑–∏—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (—Ç–µ—Å—Ç–æ–≤—ã–µ):
–¢–µ–∫—É—â–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã —è–≤–ª—è—é—Ç—Å—è **–¢–ï–°–¢–û–í–´–ú–ò** –∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
```
–ò–ù–ù: 7707083893 (10 —Ü–∏—Ñ—Ä)
–ö–ü–ü: 770701001 (9 —Ü–∏—Ñ—Ä)
–ö–∞–∑–Ω. —Å—á–µ—Ç: 40302810012345678901 (20 —Ü–∏—Ñ—Ä)
–ë–ò–ö: 044525000 (9 —Ü–∏—Ñ—Ä)
–ö–æ—Ä—Ä. —Å—á–µ—Ç: 30101810100000000000 (20 —Ü–∏—Ñ—Ä)
–ö–ë–ö: 00000000000000000130 (20 —Ü–∏—Ñ—Ä)
–û–ö–¢–ú–û: 45382000 (8 —Ü–∏—Ñ—Ä)
```

**–í–ê–ñ–ù–û:** –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é!

### –§–æ—Ä–º–∞—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:
```
–û–ø–ª–∞—Ç–∞ –ø–æ —Å—á–µ—Ç—É ‚ÑñINV-20251119-0001 –æ—Ç 19.11.2025. –ê–±–æ–Ω–µ–º–µ–Ω—Ç "–ë–µ–∑–ª–∏–º–∏—Ç" –Ω–∞ —Ç–∞–Ω—Ü—ã. –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á
```

---

## üöÄ API –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend –¥–æ—Å—Ç—É–ø–Ω—ã endpoints:

```bash
# –ü–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥ –∫–∞–∫ PNG
GET /api/invoices/{id}/qr
Headers: Authorization: Bearer {token}

# –ü–æ–ª—É—á–∏—Ç—å QR-–∫–æ–¥ –∫–∞–∫ Data URL
GET /api/invoices/{id}/qr-data-url
Headers: Authorization: Bearer {token}

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å QR –Ω–∞ email (–∑–∞–≥–ª—É—à–∫–∞)
POST /api/invoices/{id}/send-qr-email
Headers: Authorization: Bearer {token}
```

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 19 –Ω–æ—è–±—Ä—è 2025, 19:30
**–°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞–Ω–∏–µ React Email —à–∞–±–ª–æ–Ω–∞
