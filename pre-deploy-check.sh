#!/bin/bash

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคะปะฐะณ ะดะปั ะฟัะพะฟััะบะฐ ะฟัะพะฒะตัะพะบ ะฟะพะดะบะปััะตะฝะธั
SKIP_CONNECTION_CHECKS=false

# ะะฐััะธะฝะณ ะฐัะณัะผะตะฝัะพะฒ
while [[ $# -gt 0 ]]; do
    case $1 in
        --skip-connection-checks)
            SKIP_CONNECTION_CHECKS=true
            shift
            ;;
        -h|--help)
            echo "ะัะฟะพะปัะทะพะฒะฐะฝะธะต: $0 [ะพะฟัะธะธ]"
            echo ""
            echo "ะะฟัะธะธ:"
            echo "  --skip-connection-checks    ะัะพะฟัััะธัั ะฟัะพะฒะตัะบะธ ะฟะพะดะบะปััะตะฝะธั ะบ ะฒะฝะตัะฝะธะผ ัะตัะฒะธัะฐะผ"
            echo "  -h, --help                  ะะพะบะฐะทะฐัั ััั ัะฟัะฐะฒะบั"
            exit 0
            ;;
        *)
            echo "ะะตะธะทะฒะตััะฝะฐั ะพะฟัะธั: $1"
            echo "ะัะฟะพะปัะทัะนัะต -h ะธะปะธ --help ะดะปั ัะฟัะฐะฒะบะธ"
            exit 1
            ;;
    esac
done

echo ""
echo "================================================"
echo "  ๐ ะะะะะะะะ ะะะขะะะะะกะขะ ะ ะะะะะะฎ"
echo "================================================"
echo ""

# ะกัะตััะธะบ ะฒัะตั ะฟัะพะฒะตัะพะบ
TOTAL_CHECKS=0
PASSED_CHECKS=0
FAILED_CHECKS=0

# ะคัะฝะบัะธั ะดะปั ะทะฐะฟััะบะฐ ะฟัะพะฒะตัะบะธ
run_check() {
    local check_name=$1
    local check_script=$2

    echo ""
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}ะะฐะฟััะบ: ${check_name}${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

    ((TOTAL_CHECKS++))

    if bash "$check_script"; then
        ((PASSED_CHECKS++))
        echo -e "${GREEN}โ ${check_name} ะฟัะพะนะดะตะฝะฐ${NC}"
        return 0
    else
        ((FAILED_CHECKS++))
        echo -e "${RED}โ ${check_name} ะฟัะพะฒะฐะปะตะฝะฐ${NC}"
        return 1
    fi
}

# ะะฐััะธะฒ ะดะปั ััะฐะฝะตะฝะธั ัะตะทัะปััะฐัะพะฒ
declare -a CHECK_RESULTS

# 1. ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
if run_check "ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั" "scripts/check-env.sh"; then
    CHECK_RESULTS+=("โ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั")
else
    CHECK_RESULTS+=("โ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั")
fi

# 2. ะัะพะฒะตัะบะฐ ัะพะณะปะฐัะพะฒะฐะฝะฝะพััะธ docker-compose
if run_check "ะัะพะฒะตัะบะฐ docker-compose" "scripts/check-docker-compose.sh"; then
    CHECK_RESULTS+=("โ Docker Compose")
else
    CHECK_RESULTS+=("โ Docker Compose")
fi

# 3. ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
if run_check "ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน" "scripts/check-dependencies.sh"; then
    CHECK_RESULTS+=("โ ะะฐะฒะธัะธะผะพััะธ")
else
    CHECK_RESULTS+=("โ ะะฐะฒะธัะธะผะพััะธ")
fi

# 3.5. ะัะพะฒะตัะบะฐ SSH ะบะปััะฐ
echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}ะัะพะฒะตัะบะฐ SSH ะบะปััะฐ ะดะปั ะดะตะฟะปะพั${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

((TOTAL_CHECKS++))

SSH_KEY="$HOME/.ssh/artsvao_deploy"
if [ -f "$SSH_KEY" ]; then
    echo -e "${GREEN}โ${NC} SSH ะบะปัั ะฝะฐะนะดะตะฝ: $SSH_KEY"
    ((PASSED_CHECKS++))
    CHECK_RESULTS+=("โ SSH ะบะปัั")
else
    echo -e "${RED}โ${NC} SSH ะบะปัั ะฝะต ะฝะฐะนะดะตะฝ: $SSH_KEY"
    echo -e "${YELLOW}  ะกะพะทะดะฐะนัะต ะบะปัั ะบะพะผะฐะฝะดะฐะผะธ:${NC}"
    echo -e "${YELLOW}    ssh-keygen -t ed25519 -f ~/.ssh/artsvao_deploy -C 'artsvao-deploy'${NC}"
    echo -e "${YELLOW}    ssh-copy-id -i ~/.ssh/artsvao_deploy.pub root@109.196.102.90${NC}"
    ((FAILED_CHECKS++))
    CHECK_RESULTS+=("โ SSH ะบะปัั")
fi

# 3.6. ะัะพะฒะตัะบะฐ SSL ัะตััะธัะธะบะฐัะพะฒ
echo ""
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BLUE}ะัะพะฒะตัะบะฐ SSL ัะตััะธัะธะบะฐัะพะฒ${NC}"
echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

((TOTAL_CHECKS++))

DOMAIN="crm.artsvao.ru"
if [ -f "./certbot/conf/live/$DOMAIN/fullchain.pem" ]; then
    echo -e "${GREEN}โ${NC} ะะพะบะฐะปัะฝัะน ะฑัะบะฐะฟ SSL ัะตััะธัะธะบะฐัะพะฒ ะฝะฐะนะดะตะฝ"
    # ะัะพะฒะตัะบะฐ ััะพะบะฐ ะดะตะนััะฒะธั
    EXPIRY=$(openssl x509 -in "./certbot/conf/live/$DOMAIN/fullchain.pem" -noout -enddate 2>/dev/null | cut -d= -f2)
    if [ -n "$EXPIRY" ]; then
        echo -e "  ะกัะพะบ ะดะตะนััะฒะธั ะดะพ: ${YELLOW}$EXPIRY${NC}"
    fi
    ((PASSED_CHECKS++))
    CHECK_RESULTS+=("โ SSL ัะตััะธัะธะบะฐัั (ะปะพะบะฐะปัะฝะพ)")
else
    echo -e "${YELLOW}โ${NC} ะะพะบะฐะปัะฝัะน ะฑัะบะฐะฟ SSL ัะตััะธัะธะบะฐัะพะฒ ะฝะต ะฝะฐะนะดะตะฝ"
    echo -e "${YELLOW}  ะกะตััะธัะธะบะฐัั ะฑัะดัั ัะบะฐัะฐะฝั ั ัะตัะฒะตัะฐ ะฟัะธ ะดะตะฟะปะพะต${NC}"
    echo -e "${YELLOW}  ะะปะธ ะทะฐะฟัััะธัะต: bash scripts/backup-ssl.sh${NC}"
    ((PASSED_CHECKS++))
    CHECK_RESULTS+=("โ SSL ัะตััะธัะธะบะฐัั (ะฑัะดัั ัะบะฐัะฐะฝั)")
fi

# 4. ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั (ะตัะปะธ ะฝะต ะฟัะพะฟััะตะฝะพ)
if [ "$SKIP_CONNECTION_CHECKS" = false ]; then
    echo ""
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

    ((TOTAL_CHECKS++))

    # ะะฐะณััะถะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
    if [ -f ".env.production" ]; then
        source .env.production 2>/dev/null || true

        # ะะทะฒะปะตะบะฐะตะผ ัะพัั ะธ ะฟะพัั ะธะท DATABASE_URL
        DB_HOST_FROM_URL=$(echo "$DATABASE_URL" | grep -oP '(?<=@)[^:]+(?=:)')
        DB_PORT_FROM_URL=$(echo "$DATABASE_URL" | grep -oP '(?<=:)\d+(?=/)')

        if [ -n "$DB_HOST_FROM_URL" ] && [ -n "$DB_PORT_FROM_URL" ]; then
            echo "ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ $DB_HOST_FROM_URL:$DB_PORT_FROM_URL..."

            if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$DB_HOST_FROM_URL/$DB_PORT_FROM_URL" 2>/dev/null; then
                echo -e "${GREEN}โ${NC} ะะฐะทะฐ ะดะฐะฝะฝัั ะดะพัััะฟะฝะฐ"
                ((PASSED_CHECKS++))
                CHECK_RESULTS+=("โ ะะพะดะบะปััะตะฝะธะต ะบ ะะ")
            else
                echo -e "${YELLOW}โ${NC} ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั"
                echo -e "${YELLOW}  ะญัะพ ะผะพะถะตั ะฑััั ะฝะพัะผะฐะปัะฝะพ, ะตัะปะธ ะฑะฐะทะฐ ะฝะฐัะพะดะธััั ะทะฐ ัะฐะนัะฒะพะปะพะผ${NC}"
                ((PASSED_CHECKS++))
                CHECK_RESULTS+=("โ ะะพะดะบะปััะตะฝะธะต ะบ ะะ (ะฟัะพะฟััะตะฝะพ)")
            fi
        else
            echo -e "${YELLOW}โ${NC} ะะต ัะดะฐะปะพัั ะธะทะฒะปะตัั ัะพัั/ะฟะพัั ะธะท DATABASE_URL"
            ((PASSED_CHECKS++))
            CHECK_RESULTS+=("โ ะะพะดะบะปััะตะฝะธะต ะบ ะะ (ะฟัะพะฟััะตะฝะพ)")
        fi
    else
        echo -e "${RED}โ${NC} .env.production ะฝะต ะฝะฐะนะดะตะฝ"
        ((FAILED_CHECKS++))
        CHECK_RESULTS+=("โ ะะพะดะบะปััะตะฝะธะต ะบ ะะ")
    fi
fi

# 5. ะัะพะฒะตัะบะฐ SMTP ัะตัะฒะตัะฐ (ะตัะปะธ ะฝะต ะฟัะพะฟััะตะฝะพ)
if [ "$SKIP_CONNECTION_CHECKS" = false ]; then
    echo ""
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ SMTP ัะตัะฒะตัั${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

    ((TOTAL_CHECKS++))

    if [ -f ".env.production" ]; then
        source .env.production 2>/dev/null || true

        if [ -n "$SMTP_HOST" ] && [ -n "$SMTP_PORT" ]; then
            echo "ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ $SMTP_HOST:$SMTP_PORT..."

            if timeout 5 bash -c "cat < /dev/null > /dev/tcp/$SMTP_HOST/$SMTP_PORT" 2>/dev/null; then
                echo -e "${GREEN}โ${NC} SMTP ัะตัะฒะตั ะดะพัััะฟะตะฝ"
                ((PASSED_CHECKS++))
                CHECK_RESULTS+=("โ ะะพะดะบะปััะตะฝะธะต ะบ SMTP")
            else
                echo -e "${YELLOW}โ${NC} ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั ะบ SMTP ัะตัะฒะตัั"
                echo -e "${YELLOW}  ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ SMTP ะฒ production ะพะบััะถะตะฝะธะธ${NC}"
                ((PASSED_CHECKS++))
                CHECK_RESULTS+=("โ ะะพะดะบะปััะตะฝะธะต ะบ SMTP (ะฟัะตะดัะฟัะตะถะดะตะฝะธะต)")
            fi
        else
            echo -e "${YELLOW}โ${NC} SMTP_HOST ะธะปะธ SMTP_PORT ะฝะต ัััะฐะฝะพะฒะปะตะฝั"
            ((PASSED_CHECKS++))
            CHECK_RESULTS+=("โ ะะพะดะบะปััะตะฝะธะต ะบ SMTP (ะฟัะพะฟััะตะฝะพ)")
        fi
    fi
fi

# ะัะพะณะพะฒัะน ะพััะตั
echo ""
echo ""
echo "================================================"
echo "  ๐ ะะขะะะะะซะ ะะขะงะะข"
echo "================================================"
echo ""

for result in "${CHECK_RESULTS[@]}"; do
    if [[ $result == โ* ]]; then
        echo -e "${GREEN}${result}${NC}"
    elif [[ $result == โ* ]]; then
        echo -e "${YELLOW}${result}${NC}"
    else
        echo -e "${RED}${result}${NC}"
    fi
done

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "ะัะตะณะพ ะฟัะพะฒะตัะพะบ: ${BLUE}${TOTAL_CHECKS}${NC}"
echo -e "ะัะพะนะดะตะฝะพ: ${GREEN}${PASSED_CHECKS}${NC}"
echo -e "ะัะพะฒะฐะปะตะฝะพ: ${RED}${FAILED_CHECKS}${NC}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

if [ $FAILED_CHECKS -eq 0 ]; then
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${GREEN}โ   โ ะะกะ ะะะะะะะะ ะะะะะะะะซ ะฃะกะะะจะะ!        โ${NC}"
    echo -e "${GREEN}โ   ะัะพะตะบั ะณะพัะพะฒ ะบ ะดะตะฟะปะพั ะฒ ะพะฑะปะฐะบะพ          โ${NC}"
    echo -e "${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${RED}โ   โ ะะะะะะฃะะะะซ ะะะะขะะงะะกะะะ ะะจะะะะ!        โ${NC}"
    echo -e "${RED}โ   ะัะฟัะฐะฒััะต ะพัะธะฑะบะธ ะฟะตัะตะด ะดะตะฟะปะพะตะผ           โ${NC}"
    echo -e "${RED}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    echo "ะะปั ะฟะพะปััะตะฝะธั ะฟะพะผะพัะธ ะฟะพ ะบะพะฝะบัะตัะฝะพะน ะพัะธะฑะบะต,"
    echo "ะทะฐะฟัััะธัะต ัะพะพัะฒะตัััะฒัััะธะน ัะบัะธะฟั ะฟัะพะฒะตัะบะธ ะพัะดะตะปัะฝะพ:"
    echo "  - bash scripts/check-env.sh"
    echo "  - bash scripts/check-docker-compose.sh"
    echo "  - bash scripts/check-dependencies.sh"
    echo ""
    exit 1
fi
