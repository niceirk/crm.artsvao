1. Цель и результат

Цель:
Реализовать единый сервис уведомлений в веб-приложении, который:

отправляет уведомления клиентам через Telegram-бота и по email;

делает это через очередь, не нагружая веб-сервер;

учитывает настройки клиента по каналам и типам уведомлений;

позволяет админу и самому клиенту просматривать историю уведомлений;

поддерживает массовые рассылки с безопасными ограничениями.

Результат:
Модуль/подсистема, которая интегрирована с текущим CRM (занятия, платежи и т.п.) и готова к расширению новыми каналами.

2. Каналы и события
2.1. Каналы первой версии

Telegram (через существующего или нового бота).

Email (через текущую интеграцию с Яндекс.Почтой, с учётом её лимитов).

2.2. События, при которых отправляются уведомления (V1)

Занятие отменено

Автоматически по факту отмены.

Каналы по настройкам клиента.

Занятие перенесено

Изменилось время/аудитория.

Отправка автоматическая.

Напоминание о занятии за X времени

Конфигурируемый интервал (например, за 24 часа, потом можно расширять).

Автоматическое планирование.

Счёт/ссылка на оплату сформирован

Автоматическое уведомление при создании счёта/платежного документа.

Платёж прошёл

По СБП (по webhook/уведомлению от банка) или по ручной отметке оплаты.

Уведомление клиенту об успешной оплате.

Массовая рассылка

Инициатор: администратор (ручной запуск).

Инициатор: система (например, массовая отмена всех занятий кружка).

3. Логика выбора каналов и предпочтения клиента
3.1. Настройки уведомлений клиента

В карточке клиента должны быть настройки:

Разрешён/запрещён Telegram-канал.

Разрешён/запрещён Email-канал.

Общие предпочтения (например):

“Сервисные уведомления” (важные, системные — отмены, переноса, оплаты).

“Информационные/рассылки” (новости кружка и массовые сообщения).

3.2. Логика выбора канала

Для каждого события:

Система читает настройки клиента:

Если канал не выключен — уведомление по этому каналу создаётся.

Если выключен — по каналу не создаётся.

Один и тот же бизнес-событие может породить:

только Telegram-уведомление;

только email-уведомление;

оба (если оба разрешены).

Тип уведомления (сервисное/рассылка) должен учитываться в привязке к предпочтениям клиента.

4. Модель данных (основные сущности)
4.1. Таблица notifications

Примерная структура (логическая, без жёсткой привязки к БД):

id

recipient_id — ссылка на клиента.

channel — telegram | email (в дальнейшем — расширяемый enum).

recipient_address — конкретный адрес канала:

Telegram: chat_id / user_id бота.

Email: email клиента.

event_type — код события: lesson_cancelled, lesson_rescheduled, lesson_reminder, invoice_created, payment_success, mass_broadcast, ...

template_code — код шаблона, по которому формировалось сообщение.

payload_json — данные для подстановки в шаблон (имя, даты, суммы, ссылки…).

status — pending | processing | sent | failed | canceled.

attempts — количество попыток отправки.

last_error — текст последней ошибки (для диагностики).

external_id — идентификатор в внешней системе (message_id Telegram, id письма и т.п.).

created_at

updated_at

sent_at — фактическое время успешной отправки.

initiator — кто инициировал: system / admin:<id> (для аудита).

4.2. Таблица notification_templates

id

code — уникальный код шаблона (например LESSON_CANCELLED, PAYMENT_SUCCESS, ...).

channel — telegram | email.

name — название шаблона (понятное админу).

description — краткое описание назначения.

subject — заголовок (для email, для Telegram может быть пустым).

body — текст шаблона (HTML/текст для email, Markdown/текст для Telegram).

variables_schema (опционально) — список допустимых переменных (для подсказок в UI).

is_active

created_at, updated_at

updated_by — id пользователя, изменившего шаблон (для аудита).

4.3. Таблица/поле настроек клиента (preferences)

В карточке клиента (новая таблица или расширение существующей):

notifications_telegram_enabled (bool)

notifications_email_enabled (bool)

allow_service_notifications (bool)

allow_marketing_notifications (bool)

При необходимости — более детальные настройки позже.

5. Жизненный цикл уведомления (очередь)
5.1. Создание уведомления

В момент бизнес-события (например, отмена занятия):

Логика CRM определяет список клиентов, которых нужно уведомить.

Для каждого клиента и разрешённого канала создаётся запись в notifications со статусом pending.

Создание уведомлений должно быть быстрым и не пытаться отправлять их синхронно.

5.2. Очередь и воркер

Должен быть реализован фоновый обработчик (воркер), который:

периодически (или постоянно) читает уведомления со статусом pending;

переводит их в processing;

подставляет данные в шаблон;

отправляет сообщение через соответствующий канал (Telegram API / Email SMTP/API);

по результату:

sent + заполнить external_id и sent_at,

либо failed и заполнить last_error.

Выбор конкретного механизма очередей (Celery/RQ, свой планировщик, cron-задача и т.п.) должен быть выполнен ИИ-агентом/разработчиком на основе анализа существующей кодовой базы и инфраструктуры.
Требование: механика должна:

не блокировать основной веб-процесс;

поддерживать повторные попытки;

быть пригодной к докеризации/деплою вместе с приложением.

5.3. Повторные попытки

При временных ошибках (таймауты, 429, 5xx):

Увеличивать attempts.

Делать до N повторных попыток (значение N — конфиг приложения, например 3–5).

Между попытками — настраиваемая задержка.

При “жёстких” ошибках:

Telegram: user blocked, chat not found.

Email: mailbox unavailable, постоянные ошибки.

Можно пометить сразу как failed без повторов.

Если все попытки исчерпаны — status = failed.

5.4. Отмена уведомлений

Возможность пометить уведомления как canceled:

при отмене массовой рассылки до начала отправки/в процессе;

при изменении бизнес-логики (опционально).

6. Ограничения по скорости (rate limit)
6.1. Email (Яндекс)

В коде должна быть предусмотрена возможность настроить:

макс. число писем за единицу времени (например, X писем в минуту / час);

накопление и “дозированную” отправку.

Реальные значения лимитов берутся из документации Яндекс.Почты и задаются в конфиге (env/настройки админки).

6.2. Telegram

Реализовать ограничение скорости отправки сообщений:

Не превышать безопасные значения Telegram (настраиваемые параметры).

В случае получения ошибок, связанных с лимитом:

делать паузу;

повторять попытку в рамках ограничений по попыткам.

7. Массовые рассылки
7.1. Логика

Массовая рассылка — это набор уведомлений одного event_type по выбранной выборке клиентов.

Администратор в интерфейсе:

задаёт шаблон (или выбирает существующий);

задаёт выборку получателей (по группе, кружку, фильтрам и т.п.);

выбирает каналы (в рамках разрешённых клиентом);

запускает рассылку.

Система:

создаёт notifications для всех подходящих клиентов и разрешённых каналов;

далее работает стандартный воркер.

7.2. Защита от ошибок

Перед запуском рассылки:

отображать количество получателей и каналов;

требовать подтверждение (“Вы отправите X сообщений Y клиентам”).

Предпросмотр:

возможность показать пример текста (с подставленным примерным клиентом).

7.3. Постепенный запуск (staged rollout)

Реализовать возможность:

сперва отправить небольшой тестовый поднабор (например, первым 10 клиентам или отдельной тестовой группе);

после успешной отправки/проверки — продолжить рассылку остальным.

Механизм может быть:

две кнопки: “Отправить тест” → “Отправить всем”;

или автоматический режим, настраиваемый в админке.

8. Шаблоны и редактор
8.1. Управление шаблонами

Шаблоны должны быть редактируемыми из админки:

создание нового;

редактирование существующего;

деактивация.

Поддержка переменных:

формат подстановки (например, {{name}}, {{date}}, {{group_name}}, {{payment_link}}).

минимум — документация по доступным переменным в описании шаблона.

8.2. Разница между каналами

Для каждого события могут быть отдельные шаблоны по каналам:

Email: тема + HTML/текст, более формальный стиль.

Telegram: короткий текст, поддержка базового форматирования (Markdown/HTML в рамках API Telegram).

8.3. Визуальный редактор

Для email — визуальный редактор (WYSIWYG) с возможностью:

базового форматирования текста;

вставки ссылок.

Для Telegram — упрощённый редактор (текст + подсказки по форматированию и переменным).

9. История уведомлений и интерфейсы
9.1. Для администратора

Страница(ы) в админке:

Список уведомлений

Фильтры:

дата/диапазон;

клиент;

канал;

статус;

тип события (event_type);

инициатор (system/admin).

Столбцы:

дата/время создания;

дата/время отправки;

клиент;

канал;

статус;

краткое содержание (обрезанный текст);

значок/ссылка на просмотр полного текста;

при ошибке — значок/ссылка для просмотра last_error.

Детальный просмотр уведомления

Полный текст, отправленный клиенту.

Статус, попытки, ошибки.

Ссылка на клиента и на связанное событие (занятие, платёж и т.п., если есть).

История по клиенту

На странице клиента — вкладка/блок “Уведомления”:

список его уведомлений (фильтруемый);

возможность открыть текст.

9.2. Для клиента (личный кабинет / профиль)

Блок/страница “Уведомления”:

список последних уведомлений;

канал (иконка email/telegram);

статус (для клиента можно ограничиться фактом отправки);

текст.

Блок “Настройки уведомлений”:

переключатели каналов (телеграм/почта);

разрешить/запретить рассылки/маркетинг.

10. Права доступа и аудит
10.1. Права

Только администратор (роль, которая сейчас управляет CRM) может:

создавать/редактировать шаблоны;

запускать массовые рассылки;

просматривать полную историю уведомлений всех клиентов.

Клиент:

видит только свои уведомления и свои настройки.

10.2. Аудит

Для шаблонов:

фиксировать автора и время изменения (updated_by, updated_at).

Для массовых рассылок:

хранить инициатора (admin id) и время старта.

возможность в интерфейсе посмотреть:

кто и когда запустил рассылку;

её статус (в процессе / завершена / отменена).

11. Нефункциональные требования

Производительность:

Основные бизнес-операции (отмена занятия и т.д.) не должны зависеть по времени от отправки уведомлений.

Надёжность:

В случае временных проблем с Telegram или почтой система должна:

корректно логировать ошибки;

пытаться отправить повторно согласно конфигу;

не падать и не блокировать очередь навсегда.

Расширяемость:

Структура данных и кода должна позволять добавление новых каналов (SMS, WhatsApp и т.п.) без переписывания существующей логики.

Конфигурируемость:

Лимиты отправки, количество попыток, задержки, включение/выключение отдельных типов уведомлений — через конфиг/админку.