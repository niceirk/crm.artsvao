generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id               String               @id @default(uuid())
  email            String               @unique
  passwordHash     String?              @map("password_hash")
  role             UserRole
  firstName        String               @map("first_name")
  lastName         String               @map("last_name")
  status           UserStatus           @default(ACTIVE)
  avatarUrl        String?              @map("avatar_url")
  lastLoginAt      DateTime?            @map("last_login_at")
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")
  attendances      Attendance[]
  auditLogs        AuditLog[]
  clientNotes      ClientNote[]
  events           Event[]
  invoiceAuditLogs InvoiceAuditLog[]    @relation("InvoiceAudit")
  createdInvoices  Invoice[]            @relation("InvoiceCreator")
  passwordResets   PasswordResetToken[]
  refreshTokens    RefreshToken[]
  rentals          Rental[]
  systemSettings   SystemSettings[]
  invitations      UserInvitation[]
  messages         Message[]

  @@map("users")
}

model UserInvitation {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("user_invitations")
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model LeadSource {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  clients     Client[]

  @@map("lead_sources")
}

model BenefitCategory {
  id               String   @id @default(uuid())
  name             String   @unique
  discountPercent  Decimal  @map("discount_percent") @db.Decimal(5, 2)
  description      String?
  requiresDocument Boolean  @default(false) @map("requires_document")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  clients          Client[]

  @@map("benefit_categories")
}

model ServiceCategory {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  icon        String?
  color       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  services    Service[]

  @@map("service_categories")
}

model Service {
  id             String          @id @default(uuid())
  name           String
  description    String?
  categoryId     String          @map("category_id")
  serviceType    ServiceType     @map("service_type")
  basePrice      Decimal         @map("base_price") @db.Decimal(10, 2)
  vatRate        Decimal         @default(20.0) @map("vat_rate") @db.Decimal(5, 2)
  priceWithVat   Decimal         @map("price_with_vat") @db.Decimal(10, 2)
  unitOfMeasure  UnitOfMeasure   @map("unit_of_measure")
  writeOffTiming WriteOffTiming  @map("write_off_timing")
  groupId        String?         @map("group_id")
  roomId         String?         @map("room_id")
  isActive       Boolean         @default(true) @map("is_active")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  invoiceItems   InvoiceItem[]
  category       ServiceCategory @relation(fields: [categoryId], references: [id])
  group          Group?          @relation(fields: [groupId], references: [id])
  room           Room?           @relation(fields: [roomId], references: [id])

  @@index([categoryId])
  @@index([serviceType])
  @@index([isActive])
  @@index([groupId])
  @@index([roomId])
  @@map("services")
}

model Client {
  id                String            @id @default(uuid())
  clientType        ClientType        @default(INDIVIDUAL) @map("client_type")
  firstName         String            @map("first_name")
  lastName          String            @map("last_name")
  middleName        String?           @map("middle_name")
  companyName       String?           @map("company_name")
  inn               String?
  dateOfBirth       DateTime?         @map("date_of_birth") @db.Date
  gender            Gender?
  phone             String
  email             String?
  address           String?
  photoUrl          String?           @map("photo_url")
  notes             String?
  passportNumber    String?           @map("passport_number") @db.VarChar(20)
  birthCertificate  String?           @map("birth_certificate") @db.VarChar(50)
  snils             String?           @db.VarChar(14)
  phoneAdditional   String?           @map("phone_additional") @db.VarChar(20)
  status            ClientStatus      @default(ACTIVE)
  lastActivityAt    DateTime?         @map("last_activity_at")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  leadSourceId      String?           @map("lead_source_id")
  benefitCategoryId String?           @map("benefit_category_id")
  attendances       Attendance[]
  clientNotes       ClientNote[]
  documents         ClientDocument[]
  relations         ClientRelation[]  @relation("ClientRelations")
  relatedTo         ClientRelation[]  @relation("RelatedClientRelations")
  benefitCategory   BenefitCategory?  @relation(fields: [benefitCategoryId], references: [id])
  leadSource        LeadSource?       @relation(fields: [leadSourceId], references: [id])
  invoices          Invoice[]
  payments          Payment[]
  rentals           Rental[]
  subscriptions     Subscription[]
  telegramAccounts  TelegramAccount[]
  groupMemberships  GroupMember[]
  compensations     Compensation[]
  archivedSales     ArchivedSale[]

  @@index([phone])
  @@index([email])
  @@index([status])
  @@index([lastName])
  @@index([firstName])
  @@index([createdAt])
  @@index([leadSourceId])
  @@index([benefitCategoryId])
  @@index([status, createdAt])
  @@index([clientType])
  @@index([inn])
  @@index([snils])
  @@index([lastName, firstName])
  @@map("clients")
}

model ClientRelation {
  id              String       @id @default(uuid())
  clientId        String       @map("client_id")
  relatedClientId String       @map("related_client_id")
  relationType    RelationType @map("relation_type")
  createdAt       DateTime     @default(now()) @map("created_at")
  client          Client       @relation("ClientRelations", fields: [clientId], references: [id], onDelete: Cascade)
  relatedClient   Client       @relation("RelatedClientRelations", fields: [relatedClientId], references: [id], onDelete: Cascade)

  @@map("client_relations")
}

model ClientNote {
  id         String   @id @default(uuid())
  clientId   String   @map("client_id")
  content    String
  createdBy  String?  @map("created_by")
  authorName String?  @map("author_name")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  author     User?    @relation(fields: [createdBy], references: [id])

  @@index([clientId])
  @@index([createdBy])
  @@index([createdAt])
  @@map("client_notes")
}

model ClientDocument {
  id             String       @id @default(uuid())
  clientId       String       @map("client_id")
  documentType   DocumentType @map("document_type")
  series         String?
  number         String?
  issuedBy       String?      @map("issued_by")
  issuedAt       DateTime?    @map("issued_at") @db.Date
  expiresAt      DateTime?    @map("expires_at") @db.Date
  departmentCode String?      @map("department_code") @db.VarChar(10)
  isPrimary      Boolean      @default(false) @map("is_primary")
  citizenship    String?      @db.VarChar(50)
  fullDisplay    String?      @map("full_display")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  client         Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, documentType])
  @@index([clientId])
  @@index([documentType])
  @@index([isPrimary])
  @@map("client_documents")
}

model Room {
  id           String        @id @default(uuid())
  name         String
  number       String?
  area         Decimal?      @db.Decimal(10, 2)
  capacity     Int?
  type         RoomType
  equipment    String?
  hourlyRate   Decimal       @map("hourly_rate") @db.Decimal(10, 2)
  dailyRate    Decimal?      @map("daily_rate") @db.Decimal(10, 2)
  status       RoomStatus    @default(AVAILABLE)
  pyrusId      String?       @unique @map("pyrus_id")
  lastSyncedAt DateTime?     @map("last_synced_at")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  events       Event[]
  groups       Group[]
  invoiceItems InvoiceItem[]
  rentals      Rental[]
  reservations Reservation[]
  schedules    Schedule[]
  services     Service[]

  @@map("rooms")
}

model Teacher {
  id               String        @id @default(uuid())
  firstName        String        @map("first_name")
  lastName         String        @map("last_name")
  middleName       String?       @map("middle_name")
  phone            String
  email            String?
  specialization   String?
  salaryPercentage Decimal       @map("salary_percentage") @db.Decimal(5, 2)
  photoUrl         String?       @map("photo_url")
  status           TeacherStatus @default(ACTIVE)
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")
  groups           Group[]
  schedules        Schedule[]

  @@map("teachers")
}

model Studio {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        StudioType
  category    String?
  photoUrl    String?      @map("photo_url")
  status      StudioStatus @default(ACTIVE)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  groups      Group[]

  @@map("studios")
}

model Group {
  id                 String             @id @default(uuid())
  studioId           String             @map("studio_id")
  name               String
  teacherId          String             @map("teacher_id")
  roomId             String?            @map("room_id")
  maxParticipants    Int                @map("max_participants")
  singleSessionPrice Decimal            @map("single_session_price") @db.Decimal(10, 2)
  status             GroupStatus        @default(ACTIVE)
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  ageMin             Int?               @map("age_min")
  ageMax             Int?               @map("age_max")
  duration           Int?
  weeklySchedule     Json?              @map("weekly_schedule")
  isPaid             Boolean            @default(true) @map("is_paid")
  room               Room?              @relation(fields: [roomId], references: [id])
  studio             Studio             @relation(fields: [studioId], references: [id], onDelete: Cascade)
  teacher            Teacher            @relation(fields: [teacherId], references: [id])
  schedules          Schedule[]
  services           Service[]
  subscriptionTypes  SubscriptionType[]
  subscriptions      Subscription[]
  members            GroupMember[]
  compensations      Compensation[]

  @@map("groups")
}

model GroupMember {
  id                    String            @id @default(uuid())
  groupId               String            @map("group_id")
  clientId              String            @map("client_id")
  status                GroupMemberStatus @default(ACTIVE)
  joinedAt              DateTime          @default(now()) @map("joined_at")
  leftAt                DateTime?         @map("left_at")
  waitlistPosition      Int?              @map("waitlist_position")
  promotedFromWaitlistAt DateTime?        @map("promoted_from_waitlist_at")
  notes                 String?
  createdAt             DateTime          @default(now()) @map("created_at")
  updatedAt             DateTime          @updatedAt @map("updated_at")
  group                 Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  client                Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([groupId, clientId])
  @@index([groupId])
  @@index([clientId])
  @@index([status])
  @@index([waitlistPosition])
  @@index([groupId, status])
  @@map("group_members")
}

model Schedule {
  id             String              @id @default(uuid())
  groupId        String?             @map("group_id")
  teacherId      String              @map("teacher_id")
  roomId         String              @map("room_id")
  date           DateTime            @db.Date
  startTime      DateTime            @map("start_time") @db.Time(6)
  endTime        DateTime            @map("end_time") @db.Time(6)
  type           ScheduleType
  isRecurring    Boolean             @default(false) @map("is_recurring")
  recurrenceRule String?             @map("recurrence_rule")
  notes          String?
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  status         CalendarEventStatus @default(PLANNED)
  attendances    Attendance[]
  group          Group?              @relation(fields: [groupId], references: [id])
  room           Room                @relation(fields: [roomId], references: [id])
  teacher        Teacher             @relation(fields: [teacherId], references: [id])

  @@index([date])
  @@index([teacherId])
  @@index([roomId])
  @@index([groupId])
  @@index([date, roomId])
  @@index([groupId, date, status])
  @@map("schedules")
}

model Attendance {
  id                   String           @id @default(uuid())
  scheduleId           String           @map("schedule_id")
  clientId             String           @map("client_id")
  status               AttendanceStatus
  notes                String?
  subscriptionDeducted Boolean          @default(false) @map("subscription_deducted")
  createdAt            DateTime         @default(now()) @map("created_at")
  markedAt             DateTime?        @map("marked_at")
  markedBy             String?          @map("marked_by")
  subscriptionId       String?          @map("subscription_id")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  client               Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  markedByUser         User?            @relation(fields: [markedBy], references: [id])
  schedule             Schedule         @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  subscription         Subscription?    @relation(fields: [subscriptionId], references: [id])

  @@index([clientId])
  @@index([scheduleId])
  @@index([subscriptionId])
  @@index([markedBy])
  @@index([createdAt])
  @@index([markedBy], map: "idx_attendance_marked_by")
  @@index([subscriptionId], map: "idx_attendance_subscription_id")
  @@index([scheduleId, clientId])
  @@map("attendances")
}

model SubscriptionType {
  id            String               @id @default(uuid())
  name          String
  description   String?
  groupId       String               @map("group_id")
  type          SubscriptionTypeEnum
  price         Decimal              @db.Decimal(10, 2)
  isActive      Boolean              @default(true) @map("is_active")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")
  group         Group                @relation(fields: [groupId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@index([groupId])
  @@map("subscription_types")
}

model Subscription {
  id                 String             @id @default(uuid())
  clientId           String             @map("client_id")
  subscriptionTypeId String             @map("subscription_type_id")
  groupId            String             @map("group_id")
  validMonth         String             @map("valid_month")
  purchaseDate       DateTime           @map("purchase_date") @db.Date
  startDate          DateTime           @map("start_date") @db.Date
  endDate            DateTime           @map("end_date") @db.Date
  originalPrice      Decimal            @map("original_price") @db.Decimal(10, 2)
  paidPrice          Decimal            @map("paid_price") @db.Decimal(10, 2)
  pricePerLesson     Decimal?           @map("price_per_lesson") @db.Decimal(10, 2)
  remainingVisits    Int?               @map("remaining_visits")
  purchasedMonths    Int                @default(1) @map("purchased_months")
  status             SubscriptionStatus @default(ACTIVE)
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")
  discountAmount     Decimal            @default(0) @map("discount_amount") @db.Decimal(10, 2)
  attendances        Attendance[]
  invoices           Invoice[]
  payments           Payment[]
  client             Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  group              Group              @relation(fields: [groupId], references: [id])
  subscriptionType   SubscriptionType   @relation(fields: [subscriptionTypeId], references: [id])

  @@index([clientId])
  @@index([groupId])
  @@index([status])
  @@index([validMonth])
  @@index([startDate, endDate])
  @@index([remainingVisits])
  @@index([groupId, validMonth, status])
  @@index([clientId, groupId, validMonth])
  @@map("subscriptions")
}

model Payment {
  id             String        @id @default(uuid())
  clientId       String        @map("client_id")
  amount         Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod @map("payment_method")
  paymentType    PaymentType   @map("payment_type")
  status         PaymentStatus @default(PENDING)
  transactionId  String?       @map("transaction_id")
  subscriptionId String?       @map("subscription_id")
  rentalId       String?       @map("rental_id")
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  invoiceId      String?       @map("invoice_id")
  client         Client        @relation(fields: [clientId], references: [id])
  invoice        Invoice?      @relation(fields: [invoiceId], references: [id])
  rental         Rental?       @relation(fields: [rentalId], references: [id])
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([clientId])
  @@index([invoiceId])
  @@index([status])
  @@index([createdAt])
  @@index([paymentType])
  @@map("payments")
}

model Rental {
  id          String              @id @default(uuid())
  roomId      String              @map("room_id")
  clientName  String              @map("client_name")
  clientPhone String              @map("client_phone")
  clientEmail String?             @map("client_email")
  eventType   String              @map("event_type")
  date        DateTime            @db.Date
  startTime   DateTime            @map("start_time") @db.Time(6)
  endTime     DateTime            @map("end_time") @db.Time(6)
  totalPrice  Decimal             @map("total_price") @db.Decimal(10, 2)
  managerId   String?             @map("manager_id")
  notes       String?
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  status      CalendarEventStatus @default(PLANNED)
  clientId    String?             @map("client_id")
  invoices    Invoice[]
  payments    Payment[]
  client      Client?             @relation(fields: [clientId], references: [id])
  manager     User?               @relation(fields: [managerId], references: [id])
  room        Room                @relation(fields: [roomId], references: [id])

  @@index([date])
  @@index([roomId])
  @@index([clientId])
  @@index([managerId])
  @@index([status])
  @@map("rentals")
}

model Event {
  id                String              @id @default(uuid())
  name              String
  description       String?
  fullDescription   String?             @map("full_description")
  date              DateTime            @db.Date
  startTime         DateTime            @map("start_time") @db.Time(6)
  endTime           DateTime            @map("end_time") @db.Time(6)
  maxCapacity       Int?                @map("max_capacity")
  responsibleUserId String?             @map("responsible_user_id")
  photoUrl          String?             @map("photo_url")
  createdAt         DateTime            @default(now()) @map("created_at")
  updatedAt         DateTime            @updatedAt @map("updated_at")
  eventTypeId       String?             @map("event_type_id")
  roomId            String              @map("room_id")
  budget            Decimal?            @db.Decimal(10, 2)
  notes             String?
  participants      Int?
  status            CalendarEventStatus @default(PLANNED)
  externalId        String?             @unique @map("external_id")
  timepadLink       String?             @map("timepad_link")
  isPaid            Boolean             @default(false) @map("is_paid")
  isGovernmentTask  Boolean             @default(false) @map("is_government_task")
  eventFormat       String?             @map("event_format")
  eventType         EventType?          @relation(fields: [eventTypeId], references: [id])
  responsibleUser   User?               @relation(fields: [responsibleUserId], references: [id])
  room              Room                @relation(fields: [roomId], references: [id])

  @@index([date])
  @@index([eventTypeId])
  @@index([status])
  @@index([roomId])
  @@map("events")
}

model EventType {
  id           String    @id @default(uuid())
  name         String    @unique
  description  String?
  color        String?
  pyrusId      String?   @unique @map("pyrus_id")
  lastSyncedAt DateTime? @map("last_synced_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  events       Event[]

  @@map("event_types")
}

model Reservation {
  id         String              @id @default(uuid())
  roomId     String              @map("room_id")
  date       DateTime            @db.Date
  startTime  DateTime            @map("start_time") @db.Time(6)
  endTime    DateTime            @map("end_time") @db.Time(6)
  notes      String?
  createdAt  DateTime            @default(now()) @map("created_at")
  updatedAt  DateTime            @updatedAt @map("updated_at")
  status     CalendarEventStatus @default(PLANNED)
  reservedBy String?             @map("reserved_by")
  room       Room                @relation(fields: [roomId], references: [id])

  @@index([date])
  @@index([roomId])
  @@index([status])
  @@index([date, roomId])
  @@map("reservations")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String      @map("user_id")
  action     AuditAction
  entityType String      @map("entity_type")
  entityId   String      @map("entity_id")
  changes    Json?
  metadata   Json?
  ipAddress  String?     @map("ip_address")
  userAgent  String?     @map("user_agent")
  createdAt  DateTime    @default(now()) @map("created_at")
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemSettings {
  id                          String   @id @default("system")
  organizationName            String   @map("organization_name")
  legalName                   String?  @map("legal_name")
  address                     String?
  phone                       String
  email                       String
  website                     String?
  logo                        String?
  workingHours                Json     @map("working_hours")
  smtpHost                    String?  @map("smtp_host")
  smtpPort                    Int?     @map("smtp_port")
  smtpUser                    String?  @map("smtp_user")
  smtpPassword                String?  @map("smtp_password")
  emailFrom                   String?  @map("email_from")
  emailNotifications          Json?    @map("email_notifications")
  defaultCurrency             String   @default("RUB") @map("default_currency")
  timezone                    String   @default("Europe/Moscow")
  defaultSubscriptionValidity Int      @default(30) @map("default_subscription_validity")
  instructorPercentage        Decimal  @default(40.0) @map("instructor_percentage") @db.Decimal(5, 2)
  allowExpiredSubscriptions   Boolean  @default(false) @map("allow_expired_subscriptions")
  allowDeductAfterExpiry      Boolean  @default(false) @map("allow_deduct_after_expiry")
  updatedAt                   DateTime @updatedAt @map("updated_at")
  updatedBy                   String?  @map("updated_by")
  updatedByUser               User?    @relation(fields: [updatedBy], references: [id])

  @@map("system_settings")
}

model Invoice {
  id             String            @id @default(uuid())
  invoiceNumber  String            @unique @map("invoice_number")
  clientId       String            @map("client_id")
  subscriptionId String?           @map("subscription_id")
  rentalId       String?           @map("rental_id")
  subtotal       Decimal           @db.Decimal(10, 2)
  discountAmount Decimal           @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalAmount    Decimal           @map("total_amount") @db.Decimal(10, 2)
  status         InvoiceStatus     @default(PENDING)
  issuedAt       DateTime          @default(now()) @map("issued_at")
  dueDate        DateTime?         @map("due_date") @db.Date
  paidAt         DateTime?         @map("paid_at")
  notes          String?
  createdBy      String?           @map("created_by")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  auditLogs      InvoiceAuditLog[]
  items          InvoiceItem[]
  client         Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator        User?             @relation("InvoiceCreator", fields: [createdBy], references: [id])
  rental         Rental?           @relation(fields: [rentalId], references: [id])
  subscription   Subscription?     @relation(fields: [subscriptionId], references: [id])
  payments       Payment[]

  @@index([clientId])
  @@index([subscriptionId])
  @@index([rentalId])
  @@index([status])
  @@index([issuedAt])
  @@index([dueDate])
  @@map("invoices")
}

model InvoiceItem {
  id                 String         @id @default(uuid())
  invoiceId          String         @map("invoice_id")
  serviceId          String?        @map("service_id")
  serviceType        ServiceType    @map("service_type")
  serviceName        String         @map("service_name")
  serviceDescription String?        @map("service_description")
  roomId             String?        @map("room_id")
  quantity           Decimal        @default(1) @db.Decimal(10, 2)
  unitPrice          Decimal        @map("unit_price") @db.Decimal(10, 2)
  basePrice          Decimal        @map("base_price") @db.Decimal(10, 2)
  vatRate            Decimal        @map("vat_rate") @db.Decimal(5, 2)
  vatAmount          Decimal        @map("vat_amount") @db.Decimal(10, 2)
  discountPercent    Decimal        @default(0) @map("discount_percent") @db.Decimal(5, 2)
  discountAmount     Decimal        @default(0) @map("discount_amount") @db.Decimal(10, 2)
  totalPrice         Decimal        @map("total_price") @db.Decimal(10, 2)
  writeOffTiming     WriteOffTiming @map("write_off_timing")
  writeOffStatus     WriteOffStatus @default(PENDING) @map("write_off_status")
  remainingQuantity  Decimal?       @map("remaining_quantity") @db.Decimal(10, 2)
  isPriceAdjusted    Boolean        @default(false) @map("is_price_adjusted")
  adjustmentReason   String?        @map("adjustment_reason")
  createdAt          DateTime       @default(now()) @map("created_at")
  updatedAt          DateTime       @updatedAt @map("updated_at")
  invoice            Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  room               Room?          @relation(fields: [roomId], references: [id])
  service            Service?       @relation(fields: [serviceId], references: [id])

  @@index([invoiceId])
  @@index([serviceId])
  @@index([writeOffStatus])
  @@index([writeOffTiming])
  @@index([remainingQuantity])
  @@map("invoice_items")
}

model InvoiceAuditLog {
  id        String             @id @default(uuid())
  invoiceId String             @map("invoice_id")
  itemId    String?            @map("item_id")
  action    InvoiceAuditAction
  fieldName String             @map("field_name")
  oldValue  String?            @map("old_value")
  newValue  String?            @map("new_value")
  reason    String?
  userId    String             @map("user_id")
  createdAt DateTime           @default(now()) @map("created_at")
  invoice   Invoice            @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  user      User               @relation("InvoiceAudit", fields: [userId], references: [id])

  @@index([invoiceId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("invoice_audit_logs")
}

enum UserRole {
  ADMIN
  MANAGER
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum ClientType {
  INDIVIDUAL
  LEGAL_ENTITY
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  VIP
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum RelationType {
  PARENT
  CHILD
  SPOUSE
  SIBLING
}

enum RoomType {
  HALL
  CLASS
  STUDIO
  CONFERENCE
}

enum RoomStatus {
  AVAILABLE
  MAINTENANCE
  RETIRED
}

enum TeacherStatus {
  ACTIVE
  VACATION
  DISMISSED
}

enum StudioType {
  GROUP
  INDIVIDUAL
  BOTH
}

enum StudioStatus {
  ACTIVE
  INACTIVE
}

enum GroupStatus {
  ACTIVE
  INACTIVE
}

enum GroupMemberStatus {
  ACTIVE    // Активный участник группы
  WAITLIST  // В листе ожидания
  EXPELLED  // Отчислен из группы
}

enum ScheduleType {
  GROUP_CLASS
  INDIVIDUAL_CLASS
}

enum CalendarEventStatus {
  PLANNED
  ONGOING
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
}

enum SubscriptionTypeEnum {
  UNLIMITED
  SINGLE_VISIT
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  FROZEN
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  ONLINE
}

enum PaymentType {
  SUBSCRIPTION
  RENTAL
  SINGLE_VISIT
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum ServiceType {
  SUBSCRIPTION
  RENTAL
  SINGLE_SESSION
  INDIVIDUAL_LESSON
  OTHER
}

enum UnitOfMeasure {
  MONTH
  HOUR
  SESSION
  DAY
  PIECE
}

enum WriteOffTiming {
  ON_SALE
  ON_USE
}

enum WriteOffStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

enum InvoiceAuditAction {
  CREATED
  UPDATED
  PRICE_ADJUSTED
  STATUS_CHANGED
  ITEM_ADDED
  ITEM_REMOVED
  CANCELLED
}

enum DocumentType {
  PASSPORT
  BIRTH_CERTIFICATE
  DRIVERS_LICENSE
  SNILS
  FOREIGN_PASSPORT
  INN
  MEDICAL_CERTIFICATE
  MSE_CERTIFICATE
  OTHER
}

enum EmailLogStatus {
  SENT
  FAILED
  QUEUED
}

// ============================================
// Telegram Integration Enums
// ============================================

enum TelegramState {
  NEW_USER // Новый пользователь, первое сообщение
  WAITING_FOR_PHONE // Ожидание номера телефона
  CHOOSING_FROM_MULTIPLE // Выбор из нескольких найденных клиентов
  IDENTIFIED // Пользователь привязан к клиенту (client_id заполнен)
  GUEST // Отказался от идентификации, общение без привязки
  BOUND_MANUALLY // Привязка выполнена менеджером вручную
}

enum MessageSource {
  TELEGRAM
  WEB // Для будущего расширения
  WHATSAPP // Для будущего расширения
}

enum ConversationStatus {
  OPEN
  CLOSED
}

enum MessageDirection {
  INBOUND // От клиента к CRM
  OUTBOUND // От CRM к клиенту
}

enum MessageSenderType {
  CLIENT // Клиент
  MANAGER // Менеджер
  SYSTEM // Системное уведомление
}

enum MessageCategory {
  PAYMENT // Уведомление о платеже
  SCHEDULE // Уведомление о занятии
  REMINDER // Напоминание
  SUBSCRIPTION // Уведомление об абонементе
  CHAT // Обычное сообщение в чате
}

model EmailLog {
  id           String         @id @default(uuid())
  recipient    String
  subject      String
  templateType String         @map("template_type")
  status       EmailLogStatus
  error        String?
  sentAt       DateTime?      @map("sent_at")
  createdAt    DateTime       @default(now()) @map("created_at")

  @@index([recipient])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

model OrganizationDetails {
  id String @id @default(uuid())

  // Основные данные организации
  organizationName String  @map("organization_name")
  shortName        String? @map("short_name") // Сокращенное наименование для QR-кодов
  inn              String
  kpp              String

  // Банковские реквизиты
  treasuryAccount String @map("treasury_account") // Казначейский счет / ЕКС
  bankName        String @map("bank_name")
  bic             String // БИК
  correspAcc      String @map("corresp_acc") // Корреспондентский счет

  // Бюджетные коды (для государственных учреждений)
  defaultKBK   String @map("default_kbk") // КБК по умолчанию (20 символов)
  defaultOKTMO String @map("default_oktmo") // ОКТМО (8 или 11 символов)

  isPrimary Boolean  @default(true) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isPrimary])
  @@map("organization_details")
}

// ============================================
// Telegram Integration Models
// ============================================

model TelegramAccount {
  id                     String         @id @default(uuid())
  clientId               String?        @map("client_id")
  telegramUserId         BigInt         @unique @map("telegram_user_id")
  chatId                 BigInt         @map("chat_id")
  username               String?
  firstName              String         @map("first_name")
  lastName               String?        @map("last_name")
  photoUrl               String?        @map("photo_url")
  isNotificationsEnabled Boolean        @default(true) @map("is_notifications_enabled")
  state                  TelegramState  @default(NEW_USER)
  createdAt              DateTime       @default(now()) @map("created_at")
  updatedAt              DateTime       @updatedAt @map("updated_at")
  client                 Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  conversations          Conversation[]

  @@index([clientId])
  @@index([telegramUserId])
  @@index([state])
  @@map("telegram_accounts")
}

model Conversation {
  id               String             @id @default(uuid())
  channelAccountId String             @unique @map("channel_account_id")
  source           MessageSource      @default(TELEGRAM)
  status           ConversationStatus @default(OPEN)
  lastMessageAt    DateTime?          @map("last_message_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  telegramAccount  TelegramAccount    @relation(fields: [channelAccountId], references: [id], onDelete: Cascade)
  messages         Message[]

  @@index([status])
  @@index([lastMessageAt])
  @@map("conversations")
}

model Message {
  id              String            @id @default(uuid())
  conversationId  String            @map("conversation_id")
  direction       MessageDirection
  senderType      MessageSenderType @map("sender_type")
  senderId        String?           @map("sender_id")
  text            String?
  payload         Json?
  category        MessageCategory?
  isReadByClient  Boolean           @default(false) @map("is_read_by_client")
  isReadByManager Boolean           @default(false) @map("is_read_by_manager")
  createdAt       DateTime          @default(now()) @map("created_at")
  conversation    Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User?             @relation(fields: [senderId], references: [id], onDelete: SetNull)

  @@index([conversationId])
  @@index([direction])
  @@index([senderType])
  @@index([senderId])
  @@index([category])
  @@index([createdAt])
  @@index([text])
  @@map("messages")
}

model NotificationTemplate {
  id           String   @id @default(uuid())
  eventType    String   @map("event_type")
  templateText String   @map("template_text")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([eventType])
  @@index([isActive])
  @@map("notification_templates")
}

// ============================================
// Compensation Model (Компенсации за пропуски)
// ============================================

model Compensation {
  id                 String   @id @default(uuid())
  clientId           String   @map("client_id")
  groupId            String   @map("group_id")
  month              String   // Формат: "2025-11"
  excusedCount       Int      @map("excused_count")
  calculatedAmount   Decimal  @map("calculated_amount") @db.Decimal(10, 2)
  adjustedAmount     Decimal? @map("adjusted_amount") @db.Decimal(10, 2)
  notes              String?
  appliedToInvoiceId String?  @map("applied_to_invoice_id")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  group   Group   @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([clientId, groupId, month])
  @@index([clientId])
  @@index([groupId])
  @@index([month])
  @@index([appliedToInvoiceId])
  @@map("compensations")
}

// ============================================
// Archived Sales (Import from 1C)
// ============================================

model ArchivedSale {
  id             String   @id @default(uuid())
  clientId       String   @map("client_id")
  saleNumber     String   @map("sale_number")
  saleDate       DateTime @map("sale_date")
  sellerName     String?  @map("seller_name")
  totalAmount    Decimal  @map("total_amount") @db.Decimal(10, 2)
  paidAmount     Decimal  @default(0) @map("paid_amount") @db.Decimal(10, 2)
  sourceDocument String   @map("source_document")
  importedAt     DateTime @default(now()) @map("imported_at")

  client   Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items    ArchivedSaleItem[]
  payments ArchivedPayment[]

  @@unique([saleNumber, saleDate])
  @@index([clientId])
  @@index([saleDate])
  @@index([saleNumber])
  @@map("archived_sales")
}

model ArchivedSaleItem {
  id             String  @id @default(uuid())
  archivedSaleId String  @map("archived_sale_id")
  itemName       String  @map("item_name")
  quantity       Decimal @db.Decimal(10, 2)
  unitPrice      Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice     Decimal @map("total_price") @db.Decimal(10, 2)

  archivedSale ArchivedSale @relation(fields: [archivedSaleId], references: [id], onDelete: Cascade)

  @@index([archivedSaleId])
  @@map("archived_sale_items")
}

model ArchivedPayment {
  id             String   @id @default(uuid())
  archivedSaleId String   @map("archived_sale_id")
  paymentMethod  String   @map("payment_method")
  amount         Decimal  @db.Decimal(10, 2)
  paymentDate    DateTime @map("payment_date")
  sourceDocument String   @map("source_document")
  importedAt     DateTime @default(now()) @map("imported_at")

  archivedSale ArchivedSale @relation(fields: [archivedSaleId], references: [id], onDelete: Cascade)

  @@index([archivedSaleId])
  @@index([paymentDate])
  @@index([archivedSaleId, paymentMethod])
  @@map("archived_payments")
}
