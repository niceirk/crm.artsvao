# Документация: Авторизация, Разграничение доступа и Административная панель

> **Версия документа:** 1.0
> **Дата создания:** 2025-11-14
> **Проект:** Система управления культурным центром

---

## Содержание

1. [Авторизация и Аутентификация](#1-авторизация-и-аутентификация)
   - [1.1 Механизм входа](#11-механизм-входа)
   - [1.2 JWT токены](#12-jwt-токены)
   - [1.3 Восстановление пароля](#13-восстановление-пароля)
   - [1.4 Безопасность](#14-безопасность)
2. [Разграничение доступа](#2-разграничение-доступа)
   - [2.1 Роли пользователей](#21-роли-пользователей)
   - [2.2 Матрица прав доступа](#22-матрица-прав-доступа)
   - [2.3 Статусы пользователей](#23-статусы-пользователей)
   - [2.4 Система аудита](#24-система-аудита)
3. [Административная панель](#3-административная-панель)
   - [3.1 Управление пользователями](#31-управление-пользователями)
   - [3.2 Системные настройки](#32-системные-настройки)
   - [3.3 Управление справочниками](#33-управление-справочниками)
   - [3.4 Логи и мониторинг](#34-логи-и-мониторинг)
4. [Технические детали реализации](#4-технические-детали-реализации)

---

## 1. Авторизация и Аутентификация

### 1.1 Механизм входа

**Метод аутентификации:** Email + Пароль (классический подход)

#### Flow диаграмма входа в систему

```
┌─────────┐                  ┌─────────┐                  ┌──────────┐
│ Клиент  │                  │ Backend │                  │ Database │
└────┬────┘                  └────┬────┘                  └────┬─────┘
     │                            │                            │
     │  POST /auth/login          │                            │
     │  { email, password }       │                            │
     ├───────────────────────────>│                            │
     │                            │                            │
     │                            │  SELECT * FROM users       │
     │                            │  WHERE email = ?           │
     │                            ├───────────────────────────>│
     │                            │                            │
     │                            │<───────────────────────────┤
     │                            │  User data                 │
     │                            │                            │
     │                            │  bcrypt.compare()          │
     │                            │  (проверка пароля)         │
     │                            │                            │
     │                            │  Генерация:                │
     │                            │  - Access Token (15 мин)   │
     │                            │  - Refresh Token (30 дней) │
     │                            │                            │
     │<───────────────────────────┤                            │
     │  { accessToken,            │                            │
     │    refreshToken,           │                            │
     │    user: {...} }           │                            │
     │                            │                            │
```

#### API Endpoint: Вход

**POST** `/api/auth/login`

**Request Body:**
```json
{
  "email": "admin@culturalcenter.ru",
  "password": "secure_password"
}
```

**Response Success (200):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "uuid",
    "email": "admin@culturalcenter.ru",
    "firstName": "Иван",
    "lastName": "Петров",
    "role": "ADMIN",
    "status": "ACTIVE"
  }
}
```

**Response Errors:**
- `400 Bad Request` - невалидные данные
- `401 Unauthorized` - неверный email или пароль
- `403 Forbidden` - пользователь заблокирован (status = BLOCKED)

---

### 1.2 JWT токены

**Стратегия:** Access Token + Refresh Token

#### Параметры токенов

| Токен | Срок жизни | Назначение | Хранение (Frontend) |
|-------|-----------|-----------|---------------------|
| **Access Token** | 15 минут | Доступ к защищенным API endpoints | Memory (Zustand store) |
| **Refresh Token** | 30 дней | Обновление Access Token | HttpOnly Cookie или LocalStorage |

#### Структура Access Token

```json
{
  "sub": "user-uuid",
  "email": "admin@culturalcenter.ru",
  "role": "ADMIN",
  "status": "ACTIVE",
  "iat": 1699999999,
  "exp": 1700000899
}
```

#### Flow обновления токенов

```
┌─────────┐                  ┌─────────┐                  ┌──────────┐
│ Клиент  │                  │ Backend │                  │ Database │
└────┬────┘                  └────┬────┘                  └────┬─────┘
     │                            │                            │
     │  POST /auth/refresh        │                            │
     │  { refreshToken }          │                            │
     ├───────────────────────────>│                            │
     │                            │                            │
     │                            │  Verify Refresh Token      │
     │                            │  (подпись + срок действия) │
     │                            │                            │
     │                            │  SELECT user WHERE id = ?  │
     │                            ├───────────────────────────>│
     │                            │<───────────────────────────┤
     │                            │                            │
     │                            │  Проверка status = ACTIVE  │
     │                            │                            │
     │                            │  Генерация нового:         │
     │                            │  - Access Token (15 мин)   │
     │                            │  - Refresh Token (30 дней) │
     │                            │                            │
     │<───────────────────────────┤                            │
     │  { accessToken,            │                            │
     │    refreshToken }          │                            │
     │                            │                            │
```

#### API Endpoint: Обновление токена

**POST** `/api/auth/refresh`

**Request Body:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response Success (200):**
```json
{
  "accessToken": "new_access_token...",
  "refreshToken": "new_refresh_token..."
}
```

#### API Endpoint: Выход

**POST** `/api/auth/logout`

**Headers:**
```
Authorization: Bearer <access_token>
```

**Request Body:**
```json
{
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Response Success (200):**
```json
{
  "message": "Logged out successfully"
}
```

**Действия:**
- Инвалидация refresh token (добавление в blacklist или удаление из БД)
- Клиент удаляет токены из хранилища

---

### 1.3 Восстановление пароля

**Методы восстановления:**
1. **Email с ссылкой сброса** (основной)
2. **Обращение к администратору** (резервный)

#### 1.3.1 Восстановление через Email

**Flow диаграмма:**

```
┌─────────┐              ┌─────────┐              ┌──────────┐              ┌───────┐
│ Клиент  │              │ Backend │              │ Database │              │ Email │
└────┬────┘              └────┬────┘              └────┬─────┘              └───┬───┘
     │                        │                        │                        │
     │ POST /auth/forgot-password                      │                        │
     │ { email }              │                        │                        │
     ├───────────────────────>│                        │                        │
     │                        │  SELECT user           │                        │
     │                        │  WHERE email = ?       │                        │
     │                        ├───────────────────────>│                        │
     │                        │<───────────────────────┤                        │
     │                        │                        │                        │
     │                        │  Генерация токена      │                        │
     │                        │  сброса (UUID)         │                        │
     │                        │                        │                        │
     │                        │  INSERT password_reset_tokens                   │
     │                        │  { token, userId, expiresAt }                   │
     │                        ├───────────────────────>│                        │
     │                        │                        │                        │
     │                        │  Отправка email        │                        │
     │                        │  со ссылкой            │                        │
     │                        ├────────────────────────┼───────────────────────>│
     │                        │                        │                        │
     │<───────────────────────┤                        │                        │
     │ { message: "Email sent" }                       │                        │
     │                        │                        │                        │
     │                        │                        │                        │
     │  Пользователь переходит по ссылке:              │                        │
     │  /reset-password?token=xxx                      │                        │
     │                        │                        │                        │
     │ POST /auth/reset-password                       │                        │
     │ { token, newPassword } │                        │                        │
     ├───────────────────────>│                        │                        │
     │                        │  Проверка токена       │                        │
     │                        ├───────────────────────>│                        │
     │                        │<───────────────────────┤                        │
     │                        │                        │                        │
     │                        │  bcrypt.hash(newPassword)                       │
     │                        │                        │                        │
     │                        │  UPDATE users          │                        │
     │                        │  SET passwordHash = ?  │                        │
     │                        ├───────────────────────>│                        │
     │                        │                        │                        │
     │                        │  DELETE password_reset_tokens                   │
     │                        ├───────────────────────>│                        │
     │                        │                        │                        │
     │<───────────────────────┤                        │                        │
     │ { message: "Password reset successful" }        │                        │
```

#### API Endpoint: Запрос сброса пароля

**POST** `/api/auth/forgot-password`

**Request Body:**
```json
{
  "email": "user@culturalcenter.ru"
}
```

**Response Success (200):**
```json
{
  "message": "Если указанный email существует, на него отправлена ссылка для сброса пароля"
}
```

**Примечание:** По соображениям безопасности всегда возвращается успешный ответ, даже если email не найден.

**Email шаблон:**
```
Тема: Восстановление пароля - Культурный центр

Здравствуйте!

Вы запросили сброс пароля для вашей учетной записи.

Перейдите по ссылке для создания нового пароля:
https://culturalcenter.ru/reset-password?token=<reset_token>

Ссылка действительна в течение 1 часа.

Если вы не запрашивали сброс пароля, просто проигнорируйте это письмо.

---
С уважением,
Команда Культурного центра
```

#### API Endpoint: Установка нового пароля

**POST** `/api/auth/reset-password`

**Request Body:**
```json
{
  "token": "reset-token-uuid",
  "newPassword": "new_secure_password"
}
```

**Response Success (200):**
```json
{
  "message": "Пароль успешно изменен"
}
```

**Response Errors:**
- `400 Bad Request` - невалидный токен или пароль
- `410 Gone` - токен истек

#### 1.3.2 Восстановление через администратора

**Процесс:**

1. Пользователь обращается к администратору (лично, по телефону, email)
2. Администратор входит в админ-панель
3. Находит пользователя в разделе "Управление пользователями"
4. Нажимает кнопку "Сбросить пароль"
5. Система генерирует новую ссылку-приглашение (invite link)
6. Администратор передает ссылку пользователю
7. Пользователь переходит по ссылке и устанавливает новый пароль

---

### 1.4 Безопасность

#### 1.4.1 Хеширование паролей

- **Алгоритм:** bcrypt
- **Salt rounds:** 10
- **Минимальная длина пароля:** 8 символов
- **Требования к паролю:**
  - Минимум 1 заглавная буква (опционально, рекомендуется)
  - Минимум 1 цифра (опционально, рекомендуется)

**Пример (NestJS):**
```typescript
import * as bcrypt from 'bcrypt';

const SALT_ROUNDS = 10;

async function hashPassword(password: string): Promise<string> {
  return bcrypt.hash(password, SALT_ROUNDS);
}

async function comparePasswords(password: string, hash: string): Promise<boolean> {
  return bcrypt.compare(password, hash);
}
```

#### 1.4.2 Время жизни токенов

| Токен | Срок жизни | Обоснование |
|-------|-----------|-------------|
| Access Token | 15 минут | Минимизация риска при компрометации |
| Refresh Token | 30 дней | Удобство использования без частого re-login |
| Password Reset Token | 1 час | Баланс безопасности и удобства |
| Invitation Token | 7 дней | Достаточно времени для активации аккаунта |

#### 1.4.3 Rate Limiting

**Защита от брут-форс атак:**

| Endpoint | Лимит | Окно времени |
|----------|-------|--------------|
| `POST /auth/login` | 5 попыток | 15 минут |
| `POST /auth/forgot-password` | 3 запроса | 1 час |
| `POST /auth/reset-password` | 5 попыток | 15 минут |
| `POST /auth/refresh` | 10 запросов | 1 минута |

**Реализация (NestJS + @nestjs/throttler):**
```typescript
@UseGuards(ThrottlerGuard)
@Throttle(5, 900) // 5 запросов за 900 секунд (15 минут)
@Post('login')
async login(@Body() loginDto: LoginDto) {
  // ...
}
```

#### 1.4.4 HTTPS и Secure Cookies

- **Обязательное использование HTTPS** в production
- Refresh Token хранится в **HttpOnly Cookie** с флагами:
  - `httpOnly: true` - защита от XSS
  - `secure: true` - только через HTTPS
  - `sameSite: 'strict'` - защита от CSRF

```typescript
res.cookie('refreshToken', token, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 30 * 24 * 60 * 60 * 1000, // 30 дней
});
```

#### 1.4.5 Input Validation

Использование **class-validator** + **Zod** для валидации входных данных:

```typescript
// Backend (NestJS)
import { IsEmail, MinLength } from 'class-validator';

export class LoginDto {
  @IsEmail({}, { message: 'Некорректный email' })
  email: string;

  @MinLength(8, { message: 'Минимальная длина пароля - 8 символов' })
  password: string;
}
```

```typescript
// Frontend (React + Zod)
import { z } from 'zod';

const loginSchema = z.object({
  email: z.string().email('Некорректный email'),
  password: z.string().min(8, 'Минимальная длина пароля - 8 символов'),
});
```

---

## 2. Разграничение доступа

### 2.1 Роли пользователей

В системе существует **2 роли**:

#### ADMIN (Администратор)

**Описание:** Полный доступ ко всем функциям системы, включая управление пользователями, настройками, финансовыми данными.

**Количество:** 1-3 пользователя

**Типичные представители:**
- Директор культурного центра
- Главный администратор
- IT-специалист

#### MANAGER (Менеджер/Регистратор)

**Описание:** Ограниченный доступ для работы с клиентами, расписанием, продажей абонементов. Нет доступа к финансовым отчетам, зарплатам, настройкам системы.

**Количество:** 5-15 пользователей

**Типичные представители:**
- Администратор на ресепшн
- Регистратор
- Менеджер по работе с клиентами

---

### 2.2 Матрица прав доступа

#### 2.2.1 Общая матрица по модулям

| Модуль | ADMIN | MANAGER |
|--------|-------|---------|
| **CRM (Клиенты)** | ✅ Полный доступ | ✅ Просмотр, создание, редактирование клиентов |
| **Расписание и бронирование** | ✅ Полный доступ | ✅ Просмотр, создание событий, бронирование |
| **Студии и группы** | ✅ Полный доступ | ✅ Просмотр, создание/редактирование событий |
| **Абонементы и продажи** | ✅ Полный доступ | ✅ Продажа абонементов, списание занятий |
| **Расчет зарплаты** | ✅ Полный доступ | ❌ Нет доступа |
| **Справочники** | ✅ Полный доступ (CRUD) | ❌ Только просмотр |
| **Отчеты и аналитика** | ✅ Все отчеты | ⚠️ Только базовые отчеты (без финансов) |
| **Управление пользователями** | ✅ Полный доступ | ❌ Нет доступа |
| **Системные настройки** | ✅ Полный доступ | ❌ Нет доступа |
| **Импорт/Экспорт** | ✅ Полный доступ | ⚠️ Только импорт клиентов |
| **Логи и аудит** | ✅ Полный доступ | ❌ Нет доступа |

#### 2.2.2 Детальная матрица прав (CRUD)

**Легенда:**
- ✅ - полный доступ
- 👁️ - только просмотр
- ❌ - нет доступа

| Сущность | Операция | ADMIN | MANAGER |
|----------|----------|-------|---------|
| **Clients (Клиенты)** | | | |
| | Create | ✅ | ✅ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ✅ |
| | Delete | ✅ | ❌ |
| **Staff (Сотрудники)** | | | |
| | Create | ✅ | ❌ |
| | Read | ✅ | 👁️ (только список) |
| | Update | ✅ | ❌ |
| | Delete | ✅ | ❌ |
| **Studios (Студии)** | | | |
| | Create | ✅ | ❌ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ❌ |
| | Delete | ✅ | ❌ |
| **Groups (Группы)** | | | |
| | Create | ✅ | ❌ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ❌ |
| | Delete | ✅ | ❌ |
| **Events (События)** | | | |
| | Create | ✅ | ✅ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ✅ |
| | Delete | ✅ | ✅ |
| **Subscriptions (Абонементы)** | | | |
| | Create (продажа) | ✅ | ✅ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ⚠️ (только списание) |
| | Delete | ✅ | ❌ |
| **Rooms (Помещения)** | | | |
| | Create | ✅ | ❌ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ❌ |
| | Delete | ✅ | ❌ |
| **Rentals (Аренда залов)** | | | |
| | Create | ✅ | ✅ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ✅ |
| | Delete | ✅ | ❌ |
| **Attendance (Посещаемость)** | | | |
| | Create (отметка) | ✅ | ✅ |
| | Read | ✅ | ✅ |
| | Update | ✅ | ✅ |
| | Delete | ✅ | ❌ |
| **Salaries (Зарплаты)** | | | |
| | Calculate | ✅ | ❌ |
| | Read | ✅ | ❌ |
| | Update | ✅ | ❌ |
| | Delete | ✅ | ❌ |
| **Directories (Справочники)** | | | |
| | Create | ✅ | ❌ |
| | Read | ✅ | 👁️ |
| | Update | ✅ | ❌ |
| | Delete | ✅ | ❌ |
| **Users (Пользователи системы)** | | | |
| | Create | ✅ | ❌ |
| | Read | ✅ | ❌ |
| | Update | ✅ | ❌ |
| | Delete/Block | ✅ | ❌ |
| **System Settings** | | | |
| | Read | ✅ | ❌ |
| | Update | ✅ | ❌ |
| **Audit Logs** | | | |
| | Read | ✅ | ❌ |

#### 2.2.3 Матрица доступа к отчетам

| Отчет | ADMIN | MANAGER |
|-------|-------|---------|
| Клиенты по источникам привлечения | ✅ | ✅ |
| Активные клиенты за период | ✅ | ✅ |
| Новые клиенты за период | ✅ | ✅ |
| Загрузка помещений | ✅ | 👁️ |
| Посещаемость по студиям | ✅ | ✅ |
| Посещаемость по группам | ✅ | ✅ |
| **Финансовые отчеты:** | | |
| Продажи абонементов | ✅ | ❌ |
| Доходы по студиям | ✅ | ❌ |
| Расходы (зарплаты) | ✅ | ❌ |
| Рентабельность студий | ✅ | ❌ |
| Аренда помещений (доходы) | ✅ | ❌ |
| Общий финансовый отчет | ✅ | ❌ |
| **Аналитика:** | | |
| Сравнение периодов | ✅ | 👁️ (без финансов) |
| Прогнозы доходов | ✅ | ❌ |

---

### 2.3 Статусы пользователей

В системе используется простая схема статусов:

```prisma
enum UserStatus {
  ACTIVE   // Активный пользователь, может войти в систему
  BLOCKED  // Заблокированный, вход запрещен
}
```

#### ACTIVE (Активный)

- Пользователь может войти в систему
- Может выполнять все действия в рамках своей роли
- По умолчанию при создании нового пользователя

#### BLOCKED (Заблокирован)

- Пользователь **не может** войти в систему
- При попытке входа получает ошибку `403 Forbidden`
- Все refresh токены этого пользователя инвалидируются
- Используется при увольнении сотрудника или временном отключении доступа

**Кто может блокировать:** Только ADMIN

**Действия при блокировке:**
1. Изменение статуса: `status = BLOCKED`
2. Инвалидация всех активных сессий (refresh tokens)
3. Запись в audit log

---

### 2.4 Система аудита

**Требование:** Полный аудит всех действий пользователей (создание, изменение, удаление записей).

#### 2.4.1 Структура audit log

Все изменения данных логируются в таблицу `AuditLog`:

```prisma
model AuditLog {
  id          String    @id @default(uuid())
  userId      String    // Кто выполнил действие
  user        User      @relation(fields: [userId], references: [id])

  action      AuditAction  // CREATE, UPDATE, DELETE
  entityType  String       // Тип сущности: "Client", "Staff", "Subscription", etc.
  entityId    String       // ID измененной записи

  changes     Json?        // Детали изменений (для UPDATE)
  metadata    Json?        // Дополнительная информация

  ipAddress   String?      // IP адрес пользователя
  userAgent   String?      // User-Agent браузера

  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}
```

#### 2.4.2 Что логируется

**Все операции CREATE, UPDATE, DELETE для следующих сущностей:**

- Clients (клиенты)
- Staff (сотрудники)
- Studios (студии)
- Groups (группы)
- Events (события в расписании)
- Subscriptions (абонементы)
- Attendance (посещаемость)
- Rentals (аренда помещений)
- Salaries (зарплаты)
- Directories (справочники)
- Users (пользователи системы)
- SystemSettings (системные настройки)

#### 2.4.3 Формат записи

**Пример лога при CREATE:**

```json
{
  "id": "uuid-1",
  "userId": "admin-uuid",
  "action": "CREATE",
  "entityType": "Client",
  "entityId": "client-uuid-123",
  "changes": null,
  "metadata": {
    "entityName": "Иванов Иван Иванович",
    "module": "CRM"
  },
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "createdAt": "2025-11-14T10:30:00Z"
}
```

**Пример лога при UPDATE:**

```json
{
  "id": "uuid-2",
  "userId": "manager-uuid",
  "action": "UPDATE",
  "entityType": "Client",
  "entityId": "client-uuid-123",
  "changes": {
    "before": {
      "phone": "+7 (999) 123-45-67",
      "email": "old@example.com"
    },
    "after": {
      "phone": "+7 (999) 111-22-33",
      "email": "new@example.com"
    }
  },
  "metadata": {
    "entityName": "Иванов Иван Иванович"
  },
  "ipAddress": "192.168.1.101",
  "userAgent": "Mozilla/5.0...",
  "createdAt": "2025-11-14T11:00:00Z"
}
```

**Пример лога при DELETE:**

```json
{
  "id": "uuid-3",
  "userId": "admin-uuid",
  "action": "DELETE",
  "entityType": "Subscription",
  "entityId": "subscription-uuid-456",
  "changes": {
    "deleted": {
      "clientName": "Петров Петр",
      "subscriptionType": "Йога - 12 занятий",
      "remainingVisits": 5
    }
  },
  "metadata": {
    "reason": "Возврат средств по запросу клиента"
  },
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0...",
  "createdAt": "2025-11-14T12:00:00Z"
}
```

#### 2.4.4 Реализация (Prisma Middleware)

```typescript
// src/common/middleware/audit.middleware.ts
import { Prisma } from '@prisma/client';

export function createAuditMiddleware(userId: string, ipAddress: string, userAgent: string) {
  return async (params: Prisma.MiddlewareParams, next: Function) => {
    const result = await next(params);

    // Список моделей для аудита
    const auditedModels = [
      'Client', 'Staff', 'Studio', 'Group', 'Event',
      'Subscription', 'Attendance', 'Rental', 'Salary',
      'User', 'SystemSettings'
    ];

    if (auditedModels.includes(params.model)) {
      if (params.action === 'create') {
        await logAudit({
          userId,
          action: 'CREATE',
          entityType: params.model,
          entityId: result.id,
          ipAddress,
          userAgent,
        });
      } else if (params.action === 'update') {
        await logAudit({
          userId,
          action: 'UPDATE',
          entityType: params.model,
          entityId: params.args.where.id,
          changes: {
            before: await getBeforeState(params),
            after: params.args.data,
          },
          ipAddress,
          userAgent,
        });
      } else if (params.action === 'delete') {
        await logAudit({
          userId,
          action: 'DELETE',
          entityType: params.model,
          entityId: params.args.where.id,
          changes: {
            deleted: await getBeforeState(params),
          },
          ipAddress,
          userAgent,
        });
      }
    }

    return result;
  };
}
```

---

## 3. Административная панель

### 3.1 Управление пользователями

#### 3.1.1 UI/UX Спецификация

**URL:** `/admin/users`

**Layout:**

```
┌─────────────────────────────────────────────────────────────────┐
│  Культурный центр - Управление пользователями                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [+ Пригласить пользователя]                    [🔍 Поиск...]  │
│                                                                 │
│  Фильтры:  [Все роли ▾]  [Все статусы ▾]                       │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│ Таблица пользователей:                                          │
│                                                                 │
│ ┌───────┬──────────────┬─────────────────┬────────┬─────────┬──┐│
│ │ Аватар│ Имя          │ Email           │ Роль   │ Статус  │  ││
│ ├───────┼──────────────┼─────────────────┼────────┼─────────┼──┤│
│ │  👤   │ Иван Петров  │ ivan@cc.ru      │ ADMIN  │ 🟢      │…││
│ │  👤   │ Мария Сидоров│ maria@cc.ru     │ MANAGER│ 🟢      │…││
│ │  👤   │ Олег Иванов  │ oleg@cc.ru      │ MANAGER│ 🔴      │…││
│ └───────┴──────────────┴─────────────────┴────────┴─────────┴──┘│
│                                                                 │
│                                    Страница 1 из 2  [< 1 2 >]  │
└─────────────────────────────────────────────────────────────────┘
```

**Компоненты:**

1. **Шапка с кнопкой "Пригласить пользователя"**
   - Primary button
   - Открывает модальное окно создания приглашения

2. **Поле поиска**
   - Placeholder: "Поиск по имени, фамилии или email..."
   - Real-time search (debounce 300ms)
   - Поиск по полям: `firstName`, `lastName`, `email`

3. **Фильтры**
   - Dropdown "Роль": Все | Admin | Manager
   - Dropdown "Статус": Все | Активные | Заблокированные

4. **Таблица пользователей**

Колонки:
- **Аватар** - иконка или инициалы
- **Имя и Фамилия** - кликабельно (открывает профиль)
- **Email**
- **Роль** - Badge: `ADMIN` (красный), `MANAGER` (синий)
- **Статус** - Badge: `Активен` (зеленый), `Заблокирован` (красный)
- **Дата создания** - формат: `14.11.2024`
- **Действия** - Dropdown меню (три точки)

**Действия в Dropdown:**
- Просмотреть профиль
- Редактировать
- Сбросить пароль (генерация новой invite ссылки)
- Заблокировать / Разблокировать
- Удалить (с подтверждением)

5. **Пагинация**
   - 20 записей на страницу
   - Pagination controls внизу

#### 3.1.2 Создание пользователя (Invite Link Flow)

**Шаг 1: Модальное окно "Пригласить пользователя"**

```
┌─────────────────────────────────────────────────┐
│  Пригласить нового пользователя            [X]  │
├─────────────────────────────────────────────────┤
│                                                 │
│  Имя *                                          │
│  [________________________]                     │
│                                                 │
│  Фамилия *                                      │
│  [________________________]                     │
│                                                 │
│  Email *                                        │
│  [________________________]                     │
│                                                 │
│  Роль *                                         │
│  [Администратор    ▾]                           │
│                                                 │
│                                                 │
│             [Отмена]  [Создать приглашение]     │
│                                                 │
└─────────────────────────────────────────────────┘
```

**Валидация:**
- Все поля обязательны
- Email должен быть уникальным
- Email должен быть валидным

**Действие при нажатии "Создать приглашение":**

1. Backend создает запись в таблице `User`:
   ```typescript
   {
     email: "newuser@cc.ru",
     firstName: "Иван",
     lastName: "Новиков",
     role: "MANAGER",
     status: "BLOCKED", // Статус BLOCKED до активации!
     passwordHash: null, // Пароль пока не установлен
   }
   ```

2. Backend создает запись в таблице `UserInvitation`:
   ```typescript
   {
     token: "uuid-invitation-token",
     userId: "new-user-id",
     expiresAt: now() + 7 days,
   }
   ```

3. Backend генерирует ссылку:
   ```
   https://culturalcenter.ru/accept-invitation?token=<invitation_token>
   ```

4. Backend отправляет email с приглашением:

**Email шаблон:**
```
Тема: Приглашение в систему управления Культурным центром

Здравствуйте, Иван!

Вы приглашены в систему управления Культурным центром в роли Менеджера.

Для завершения регистрации перейдите по ссылке и установите пароль:
https://culturalcenter.ru/accept-invitation?token=<invitation_token>

Ссылка действительна в течение 7 дней.

После установки пароля вы сможете войти в систему используя ваш email:
newuser@cc.ru

---
С уважением,
Команда Культурного центра
```

5. Frontend показывает success message:

```
┌─────────────────────────────────────────────────┐
│  ✅ Приглашение отправлено                      │
├─────────────────────────────────────────────────┤
│                                                 │
│  Приглашение успешно отправлено на адрес:       │
│  newuser@cc.ru                                  │
│                                                 │
│  Пользователь получит ссылку для установки      │
│  пароля и активации аккаунта.                   │
│                                                 │
│  Ссылка действительна 7 дней.                   │
│                                                 │
│  Пригласительная ссылка (для ручной передачи):  │
│  [https://culturalcenter.ru/accept-inv....]     │
│  [📋 Скопировать]                               │
│                                                 │
│                                    [Закрыть]    │
└─────────────────────────────────────────────────┘
```

**Шаг 2: Пользователь переходит по ссылке**

**URL:** `/accept-invitation?token=<token>`

**Страница активации:**

```
┌─────────────────────────────────────────────────┐
│         Культурный центр                        │
│                                                 │
│  🎉 Добро пожаловать!                           │
│                                                 │
│  Вы приглашены в систему управления             │
│  Культурным центром.                            │
│                                                 │
│  Ваш email: newuser@cc.ru                       │
│  Ваша роль: Менеджер                            │
│                                                 │
├─────────────────────────────────────────────────┤
│                                                 │
│  Установите пароль для завершения регистрации:  │
│                                                 │
│  Новый пароль *                                 │
│  [________________________]  [👁]               │
│  Минимум 8 символов                             │
│                                                 │
│  Подтвердите пароль *                           │
│  [________________________]  [👁]               │
│                                                 │
│                                                 │
│               [Активировать аккаунт]            │
│                                                 │
└─────────────────────────────────────────────────┘
```

**Действие при нажатии "Активировать аккаунт":**

1. Backend проверяет токен
2. Backend обновляет пользователя:
   ```typescript
   {
     passwordHash: bcrypt.hash(password),
     status: "ACTIVE", // Активируем пользователя!
   }
   ```
3. Backend удаляет invitation token
4. Backend автоматически выполняет login (генерирует JWT токены)
5. Redirect на главную страницу системы

#### 3.1.3 Модальное окно редактирования пользователя

```
┌─────────────────────────────────────────────────┐
│  Редактировать пользователя                [X]  │
├─────────────────────────────────────────────────┤
│                                                 │
│  Имя *                                          │
│  [Иван___________________]                      │
│                                                 │
│  Фамилия *                                      │
│  [Петров_________________]                      │
│                                                 │
│  Email *                                        │
│  [ivan@cc.ru_____________]                      │
│                                                 │
│  Роль *                                         │
│  [Администратор    ▾]                           │
│                                                 │
│  Статус *                                       │
│  ⚪ Активен   ⚪ Заблокирован                    │
│                                                 │
│                                                 │
│                  [Отмена]  [Сохранить]          │
│                                                 │
└─────────────────────────────────────────────────┘
```

#### 3.1.4 Страница профиля пользователя

**URL:** `/admin/users/:id`

```
┌─────────────────────────────────────────────────────────────────┐
│  ← Назад к списку                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  👤  Иван Петров                                                │
│      ivan@cc.ru                                                 │
│      🟢 Активен  |  👑 Администратор                            │
│                                                                 │
│      [Редактировать]  [Сбросить пароль]  [Заблокировать]       │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Информация                                                     │
├─────────────────────────────────────────────────────────────────┤
│  Имя:                    Иван                                   │
│  Фамилия:                Петров                                 │
│  Email:                  ivan@cc.ru                             │
│  Роль:                   Администратор                          │
│  Статус:                 Активен                                │
│  Дата создания:          14.11.2024, 10:30                      │
│  Последний вход:         15.11.2024, 09:15                      │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  История действий (последние 50)                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📝 15.11.2024, 10:45                                           │
│  Обновил клиента: Иванов Иван Иванович                          │
│  Изменено: телефон, email                                       │
│                                                                 │
│  ➕ 15.11.2024, 09:30                                           │
│  Создал новое событие: Йога для начинающих                      │
│                                                                 │
│  💰 14.11.2024, 18:00                                           │
│  Продал абонемент: Танцы - 8 занятий                            │
│  Клиент: Петрова Мария                                          │
│                                                                 │
│  ...                                                            │
│                                                                 │
│                                       [Показать еще]            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Секции:**
1. **Шапка профиля** - имя, email, статус, роль, кнопки действий
2. **Информация** - основные данные пользователя
3. **История действий** - последние записи из AuditLog для этого пользователя

---

### 3.2 Системные настройки

#### 3.2.1 UI/UX Спецификация

**URL:** `/admin/settings`

**Layout с вкладками:**

```
┌─────────────────────────────────────────────────────────────────┐
│  Системные настройки                                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [Общие]  [Email]  [Бизнес-параметры]                           │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  СОДЕРЖИМОЕ АКТИВНОЙ ВКЛАДКИ                                    │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                                                 │
│                                      [Сохранить изменения]      │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 Вкладка "Общие данные центра"

```
┌─────────────────────────────────────────────────────────────────┐
│  Основная информация                                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Название организации *                                         │
│  [Культурный центр "Искусство"]                                 │
│                                                                 │
│  Юридическое название                                           │
│  [ООО "Культурный центр Искусство"]                             │
│                                                                 │
│  Адрес                                                          │
│  [г. Москва, ул. Пушкина, д. 10]                                │
│                                                                 │
│  Телефон *                                                      │
│  [+7 (495) 123-45-67]                                           │
│                                                                 │
│  Email для связи *                                              │
│  [info@culturalcenter.ru]                                       │
│                                                                 │
│  Сайт                                                           │
│  [https://culturalcenter.ru]                                    │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Рабочие часы                                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Пн-Пт:  [09:00] - [21:00]                                      │
│  Сб:     [10:00] - [18:00]                                      │
│  Вс:     [Выходной]                                             │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Логотип                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [📷 Загрузить логотип]                                         │
│  Рекомендуемый размер: 200x200px, формат: PNG, JPG             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Модель в БД:**

```prisma
model SystemSettings {
  id                String   @id @default("system") // Singleton

  // Общая информация
  organizationName  String
  legalName         String?
  address           String?
  phone             String
  email             String
  website           String?
  logo              String?  // URL или path к логотипу

  // Рабочие часы (JSON)
  workingHours      Json
  // Пример:
  // {
  //   "monday": { "open": "09:00", "close": "21:00" },
  //   "tuesday": { "open": "09:00", "close": "21:00" },
  //   ...
  //   "sunday": { "closed": true }
  // }

  // Email настройки
  smtpHost          String?
  smtpPort          Int?
  smtpUser          String?
  smtpPassword      String?  // Зашифровано!
  emailFrom         String?

  // Бизнес-параметры
  defaultCurrency   String   @default("RUB")
  timezone          String   @default("Europe/Moscow")

  // Параметры абонементов
  defaultSubscriptionValidity Int @default(30) // дней

  // Зарплаты
  instructorPercentage Float @default(40.0) // % от стоимости занятия

  updatedAt         DateTime @updatedAt
  updatedBy         String?  // ID администратора
  updatedByUser     User?    @relation(fields: [updatedBy], references: [id])
}
```

#### 3.2.3 Вкладка "Настройки Email"

```
┌─────────────────────────────────────────────────────────────────┐
│  SMTP Сервер                                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  SMTP Host *                                                    │
│  [smtp.gmail.com]                                               │
│                                                                 │
│  SMTP Port *                                                    │
│  [587]                                                          │
│                                                                 │
│  SMTP Пользователь *                                            │
│  [noreply@culturalcenter.ru]                                    │
│                                                                 │
│  SMTP Пароль *                                                  │
│  [••••••••••••••••]  [Изменить]                                 │
│                                                                 │
│  Отправитель (From) *                                           │
│  [Культурный центр <noreply@culturalcenter.ru>]                 │
│                                                                 │
│                                    [Отправить тестовое письмо]  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Автоматические уведомления                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ☑ Отправлять подтверждение при продаже абонемента             │
│  ☑ Уведомлять о приближении окончания абонемента (за 3 дня)    │
│  ☑ Напоминания о предстоящих занятиях (за 1 день)              │
│  ☐ Поздравления с днем рождения                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Безопасность:**
- SMTP пароль хранится в зашифрованном виде
- При редактировании показывается `••••••`, реальный пароль не отображается
- Опция "Отправить тестовое письмо" отправляет email на адрес текущего пользователя для проверки настроек

#### 3.2.4 Вкладка "Бизнес-параметры"

```
┌─────────────────────────────────────────────────────────────────┐
│  Абонементы                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Срок действия абонемента по умолчанию (дней)                   │
│  [30]                                                           │
│  Применяется при создании нового типа абонемента                │
│                                                                 │
│  Разрешить продажу просроченных абонементов                     │
│  ⚪ Да   ⚫ Нет                                                  │
│                                                                 │
│  Разрешить списание занятий после истечения срока               │
│  ⚪ Да   ⚫ Нет                                                  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Расчет зарплаты преподавателей                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Процент преподавателя от стоимости занятия (%)                 │
│  [40]                                                           │
│  По умолчанию применяется для всех преподавателей               │
│  (можно переопределить индивидуально)                           │
│                                                                 │
│  Учитывать только фактическую посещаемость                      │
│  ⚫ Да   ⚪ Нет                                                  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Общие параметры                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Валюта                                                         │
│  [RUB (₽) ▾]                                                    │
│                                                                 │
│  Часовой пояс                                                   │
│  [Europe/Moscow (UTC+3) ▾]                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3.3 Управление справочниками

**URL:** `/admin/directories`

Справочники - это reference data (классификаторы), используемые во всей системе.

#### 3.3.1 Список справочников

```
┌─────────────────────────────────────────────────────────────────┐
│  Управление справочниками                                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📁 Типы абонементов                           [Редактировать]  │
│     12 записей                                                  │
│                                                                 │
│  📁 Виды занятий (Activity Types)              [Редактировать]  │
│     8 записей                                                   │
│                                                                 │
│  📁 Помещения (Rooms)                          [Редактировать]  │
│     15 записей                                                  │
│                                                                 │
│  📁 Источники привлечения клиентов             [Редактировать]  │
│     6 записей                                                   │
│                                                                 │
│  📁 Типы клиентов (Client Types)               [Редактировать]  │
│     4 записи                                                    │
│                                                                 │
│  📁 Специализации преподавателей               [Редактировать]  │
│     10 записей                                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.3.2 Пример: Редактирование справочника "Типы абонементов"

**URL:** `/admin/directories/subscription-types`

```
┌─────────────────────────────────────────────────────────────────┐
│  ← Назад к справочникам                                         │
├─────────────────────────────────────────────────────────────────┤
│  Типы абонементов                                               │
│                                                                 │
│  [+ Добавить тип]                              [🔍 Поиск...]   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────┬─────────┬─────────┬─────┬──┐ │
│  │ Название                      │ Цена    │ Визитов │ Срок│  │ │
│  ├───────────────────────────────┼─────────┼─────────┼─────┼──┤ │
│  │ Йога - 4 занятия              │ 2000 ₽  │ 4       │ 30  │…││ │
│  │ Йога - 8 занятий              │ 3500 ₽  │ 8       │ 60  │…││ │
│  │ Йога - 12 занятий             │ 4800 ₽  │ 12      │ 90  │…││ │
│  │ Танцы - 8 занятий             │ 4000 ₽  │ 8       │ 30  │…││ │
│  │ Танцы - 16 занятий            │ 7000 ₽  │ 16      │ 60  │…││ │
│  │ Детский - 4 занятия           │ 1500 ₽  │ 4       │ 30  │…││ │
│  │ Детский - 8 занятий           │ 2800 ₽  │ 8       │ 30  │…││ │
│  │ Разовое посещение             │ 600 ₽   │ 1       │ 1   │…││ │
│  │ Безлимит 1 месяц              │ 8000 ₽  │ ∞       │ 30  │…││ │
│  │ Персональная тренировка       │ 2500 ₽  │ 1       │ 14  │…││ │
│  └───────────────────────────────┴─────────┴─────────┴─────┴──┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Модальное окно добавления/редактирования:**

```
┌─────────────────────────────────────────────────┐
│  Добавить тип абонемента                   [X]  │
├─────────────────────────────────────────────────┤
│                                                 │
│  Название *                                     │
│  [Йога - 4 занятия]                             │
│                                                 │
│  Цена (₽) *                                     │
│  [2000]                                         │
│                                                 │
│  Количество посещений *                         │
│  [4]                                            │
│  ☑ Безлимит                                     │
│                                                 │
│  Срок действия (дней) *                         │
│  [30]                                           │
│                                                 │
│  Описание                                       │
│  [Абонемент на 4 занятия йогой...]              │
│                                                 │
│  Статус                                         │
│  ⚫ Активен   ⚪ Архивный                        │
│                                                 │
│                                                 │
│                 [Отмена]  [Сохранить]           │
│                                                 │
└─────────────────────────────────────────────────┘
```

**Примечание:** Архивные справочники не показываются при создании новых записей, но остаются в старых данных для истории.

---

### 3.4 Логи и мониторинг

#### 3.4.1 UI/UX Спецификация

**URL:** `/admin/audit-logs`

```
┌─────────────────────────────────────────────────────────────────┐
│  Журнал действий пользователей                                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Фильтры:                                                       │
│                                                                 │
│  [Все пользователи ▾]  [Все действия ▾]  [Все модули ▾]        │
│                                                                 │
│  Период: [01.11.2024] - [15.11.2024]                            │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Результаты (247 записей):                                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📝 15.11.2024, 14:32  |  Иван Петров (ADMIN)                   │
│  UPDATE → Client: Иванова Мария Петровна                        │
│  Изменено: телефон, email                                       │
│  [Подробнее]                                                    │
│                                                                 │
│  ➕ 15.11.2024, 14:15  |  Ольга Сидорова (MANAGER)              │
│  CREATE → Subscription: Йога - 8 занятий                        │
│  Клиент: Петров Иван                                            │
│  [Подробнее]                                                    │
│                                                                 │
│  ❌ 15.11.2024, 13:45  |  Иван Петров (ADMIN)                   │
│  DELETE → Event: Танцы для начинающих                           │
│  Дата события: 20.11.2024                                       │
│  [Подробнее]                                                    │
│                                                                 │
│  📝 15.11.2024, 12:00  |  Мария Иванова (MANAGER)               │
│  UPDATE → Attendance: отметка посещения                         │
│  Событие: Йога для начинающих                                   │
│  [Подробнее]                                                    │
│                                                                 │
│  ...                                                            │
│                                                                 │
│                                    Страница 1 из 13  [< 1 2 >] │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Компоненты:**

1. **Фильтры:**
   - **Пользователь** - Dropdown со списком всех пользователей + поиск
   - **Действие** - Dropdown: Все | Создание | Обновление | Удаление
   - **Модуль** - Dropdown: Все | CRM | Расписание | Абонементы | Зарплаты | и т.д.
   - **Период** - Date range picker

2. **Список логов:**
   - Иконка действия: ➕ CREATE, 📝 UPDATE, ❌ DELETE
   - Дата и время
   - Пользователь (имя + роль)
   - Действие → Сущность: название
   - Краткое описание изменений
   - Кнопка "Подробнее"

3. **Пагинация:**
   - 20 записей на страницу

#### 3.4.2 Модальное окно "Подробности изменения"

**При клике на "Подробнее" для UPDATE:**

```
┌─────────────────────────────────────────────────────────────────┐
│  Детали изменения                                          [X]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Действие:           UPDATE                                     │
│  Пользователь:       Иван Петров (ADMIN)                       │
│  Дата и время:       15.11.2024, 14:32:15                       │
│  IP адрес:           192.168.1.100                              │
│                                                                 │
│  Сущность:           Client                                     │
│  ID:                 client-uuid-123                            │
│  Название:           Иванова Мария Петровна                     │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Изменения:                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Поле: phone                                                    │
│  Было:   +7 (999) 123-45-67                                     │
│  Стало:  +7 (999) 111-22-33                                     │
│                                                                 │
│  Поле: email                                                    │
│  Было:   old@example.com                                        │
│  Стало:  maria.ivanova@example.com                              │
│                                                                 │
│                                                                 │
│                                               [Закрыть]         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**При клике на "Подробнее" для CREATE:**

```
┌─────────────────────────────────────────────────────────────────┐
│  Детали создания записи                                    [X]  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Действие:           CREATE                                     │
│  Пользователь:       Ольга Сидорова (MANAGER)                   │
│  Дата и время:       15.11.2024, 14:15:00                       │
│  IP адрес:           192.168.1.105                              │
│                                                                 │
│  Сущность:           Subscription                               │
│  ID:                 subscription-uuid-456                      │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│  Созданные данные:                                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Клиент:             Петров Иван Сергеевич                      │
│  Тип абонемента:     Йога - 8 занятий                           │
│  Цена:               3500 ₽                                     │
│  Количество визитов: 8                                          │
│  Срок действия:      01.11.2024 - 30.12.2024                    │
│  Метод оплаты:       Наличные                                   │
│                                                                 │
│                                               [Закрыть]         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. Технические детали реализации

### 4.1 Backend (NestJS)

#### 4.1.1 Структура модулей

```
src/
├── auth/
│   ├── auth.module.ts
│   ├── auth.controller.ts
│   ├── auth.service.ts
│   ├── strategies/
│   │   ├── jwt.strategy.ts
│   │   └── jwt-refresh.strategy.ts
│   ├── guards/
│   │   ├── jwt-auth.guard.ts
│   │   └── roles.guard.ts
│   ├── decorators/
│   │   ├── roles.decorator.ts
│   │   └── current-user.decorator.ts
│   └── dto/
│       ├── login.dto.ts
│       ├── refresh-token.dto.ts
│       ├── forgot-password.dto.ts
│       └── reset-password.dto.ts
│
├── users/
│   ├── users.module.ts
│   ├── users.controller.ts
│   ├── users.service.ts
│   └── dto/
│       ├── create-user.dto.ts
│       ├── update-user.dto.ts
│       └── invite-user.dto.ts
│
├── audit/
│   ├── audit.module.ts
│   ├── audit.service.ts
│   ├── audit.controller.ts
│   └── middleware/
│       └── audit.middleware.ts
│
├── settings/
│   ├── settings.module.ts
│   ├── settings.controller.ts
│   └── settings.service.ts
│
└── common/
    ├── guards/
    │   └── throttle.guard.ts
    └── filters/
        └── http-exception.filter.ts
```

#### 4.1.2 Guards и Decorators

**JwtAuthGuard:**

```typescript
// src/auth/guards/jwt-auth.guard.ts
import { Injectable, ExecutionContext } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  canActivate(context: ExecutionContext) {
    return super.canActivate(context);
  }
}
```

**RolesGuard:**

```typescript
// src/auth/guards/roles.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { UserRole } from '@prisma/client';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredRoles = this.reflector.getAllAndOverride<UserRole[]>('roles', [
      context.getHandler(),
      context.getClass(),
    ]);

    if (!requiredRoles) {
      return true;
    }

    const { user } = context.switchToHttp().getRequest();
    return requiredRoles.some((role) => user.role === role);
  }
}
```

**Roles Decorator:**

```typescript
// src/auth/decorators/roles.decorator.ts
import { SetMetadata } from '@nestjs/common';
import { UserRole } from '@prisma/client';

export const Roles = (...roles: UserRole[]) => SetMetadata('roles', roles);
```

**Использование:**

```typescript
// src/users/users.controller.ts
import { Controller, Get, Post, UseGuards } from '@nestjs/common';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { RolesGuard } from '../auth/guards/roles.guard';
import { Roles } from '../auth/decorators/roles.decorator';
import { UserRole } from '@prisma/client';

@Controller('users')
@UseGuards(JwtAuthGuard, RolesGuard)
export class UsersController {

  @Get()
  @Roles(UserRole.ADMIN)
  async findAll() {
    // Только ADMIN может получить список пользователей
  }

  @Post()
  @Roles(UserRole.ADMIN)
  async create() {
    // Только ADMIN может создать пользователя
  }
}
```

#### 4.1.3 Примеры API endpoints с правами доступа

```typescript
// Клиенты - доступ ADMIN и MANAGER
@Get('clients')
@Roles(UserRole.ADMIN, UserRole.MANAGER)
async getClients() { }

@Post('clients')
@Roles(UserRole.ADMIN, UserRole.MANAGER)
async createClient() { }

@Delete('clients/:id')
@Roles(UserRole.ADMIN) // Только ADMIN может удалять
async deleteClient() { }

// Зарплаты - только ADMIN
@Get('salaries')
@Roles(UserRole.ADMIN)
async getSalaries() { }

// Справочники - чтение для всех, изменение только ADMIN
@Get('directories/:type')
@Roles(UserRole.ADMIN, UserRole.MANAGER)
async getDirectory() { }

@Post('directories/:type')
@Roles(UserRole.ADMIN)
async createDirectoryItem() { }

// Логи - только ADMIN
@Get('audit-logs')
@Roles(UserRole.ADMIN)
async getAuditLogs() { }
```

---

### 4.2 Frontend (Next.js + React)

#### 4.2.1 Структура компонентов

```
src/
├── app/
│   ├── (auth)/
│   │   ├── login/
│   │   │   └── page.tsx
│   │   ├── forgot-password/
│   │   │   └── page.tsx
│   │   ├── reset-password/
│   │   │   └── page.tsx
│   │   └── accept-invitation/
│   │       └── page.tsx
│   │
│   └── (dashboard)/
│       ├── admin/
│       │   ├── users/
│       │   │   ├── page.tsx
│       │   │   └── [id]/
│       │   │       └── page.tsx
│       │   ├── settings/
│       │   │   └── page.tsx
│       │   ├── directories/
│       │   │   ├── page.tsx
│       │   │   └── [type]/
│       │   │       └── page.tsx
│       │   └── audit-logs/
│       │       └── page.tsx
│       │
│       └── ...other modules
│
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx
│   │   ├── ForgotPasswordForm.tsx
│   │   └── ResetPasswordForm.tsx
│   │
│   ├── admin/
│   │   ├── users/
│   │   │   ├── UsersTable.tsx
│   │   │   ├── UserRow.tsx
│   │   │   ├── InviteUserModal.tsx
│   │   │   ├── EditUserModal.tsx
│   │   │   └── UserProfilePage.tsx
│   │   │
│   │   ├── settings/
│   │   │   ├── GeneralSettings.tsx
│   │   │   ├── EmailSettings.tsx
│   │   │   └── BusinessSettings.tsx
│   │   │
│   │   └── audit/
│   │       ├── AuditLogsTable.tsx
│   │       └── AuditLogDetailModal.tsx
│   │
│   └── ui/ (shadcn/ui components)
│       ├── button.tsx
│       ├── input.tsx
│       ├── table.tsx
│       ├── modal.tsx
│       └── ...
│
├── lib/
│   ├── api/
│   │   ├── auth.ts
│   │   ├── users.ts
│   │   ├── settings.ts
│   │   └── audit.ts
│   │
│   ├── hooks/
│   │   ├── useAuth.ts
│   │   ├── useUsers.ts
│   │   └── usePermissions.ts
│   │
│   └── utils/
│       ├── auth.ts
│       └── permissions.ts
│
└── store/
    └── authStore.ts (Zustand)
```

#### 4.2.2 Защита маршрутов (Route Protection)

```typescript
// src/middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { verifyToken } from '@/lib/auth';

export async function middleware(request: NextRequest) {
  const token = request.cookies.get('accessToken')?.value;

  // Публичные маршруты
  const publicPaths = ['/login', '/forgot-password', '/reset-password', '/accept-invitation'];
  const isPublicPath = publicPaths.some(path => request.nextUrl.pathname.startsWith(path));

  if (isPublicPath) {
    return NextResponse.next();
  }

  // Проверка токена
  if (!token) {
    return NextResponse.redirect(new URL('/login', request.url));
  }

  try {
    const user = await verifyToken(token);

    // Проверка доступа к admin маршрутам
    if (request.nextUrl.pathname.startsWith('/admin') && user.role !== 'ADMIN') {
      return NextResponse.redirect(new URL('/dashboard', request.url));
    }

    return NextResponse.next();
  } catch (error) {
    return NextResponse.redirect(new URL('/login', request.url));
  }
}

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

#### 4.2.3 Хук проверки прав доступа

```typescript
// src/lib/hooks/usePermissions.ts
import { useAuthStore } from '@/store/authStore';
import { UserRole } from '@/types';

export function usePermissions() {
  const user = useAuthStore((state) => state.user);

  const hasRole = (roles: UserRole | UserRole[]) => {
    if (!user) return false;
    const allowedRoles = Array.isArray(roles) ? roles : [roles];
    return allowedRoles.includes(user.role);
  };

  const canCreate = (entity: string) => {
    // Логика проверки по матрице прав доступа
    if (entity === 'User') return user?.role === 'ADMIN';
    if (entity === 'Client') return hasRole(['ADMIN', 'MANAGER']);
    // ... и т.д.
  };

  const canUpdate = (entity: string) => {
    // Аналогично
  };

  const canDelete = (entity: string) => {
    // Аналогично
  };

  return {
    user,
    hasRole,
    canCreate,
    canUpdate,
    canDelete,
    isAdmin: user?.role === 'ADMIN',
    isManager: user?.role === 'MANAGER',
  };
}
```

**Использование:**

```typescript
// src/components/admin/users/UsersTable.tsx
import { usePermissions } from '@/lib/hooks/usePermissions';

export function UsersTable() {
  const { isAdmin } = usePermissions();

  if (!isAdmin) {
    return <div>У вас нет доступа к этому разделу</div>;
  }

  return (
    <div>
      <Button onClick={handleInviteUser}>Пригласить пользователя</Button>
      {/* ... */}
    </div>
  );
}
```

---

## Заключение

Этот документ содержит полную спецификацию системы авторизации, разграничения доступа и административной панели для проекта "Система управления культурным центром".

**Ключевые решения:**
- ✅ Классическая авторизация Email + Пароль
- ✅ JWT токены (Access + Refresh)
- ✅ Две роли: ADMIN и MANAGER с четкой матрицей прав
- ✅ Полный аудит всех действий
- ✅ Invite Link flow для создания пользователей
- ✅ Административная панель с управлением пользователями, настройками, справочниками и логами

**Следующие шаги реализации:**
1. Создание Prisma схемы для новых таблиц (UserInvitation, AuditLog, SystemSettings)
2. Реализация auth модуля в NestJS
3. Реализация admin панели во Frontend
4. Написание тестов
5. Деплой на production

---

**Контакты для вопросов:**
- Проектная документация: `/mnt/d/artsvao/`
- Основной README: `README.md`
- Схема БД: `DATABASE_SCHEMA.md`
