# –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–µ–ø–ª–æ—è

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è Pyrus –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:

## 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω docker-compose.prod.yml

### –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ:
- **–î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ `env_file`** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ `.env.production`
- **–£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** –∏–∑ —Å–µ–∫—Ü–∏–∏ `environment`

### –ë—ã–ª–æ:
```yaml
backend:
  environment:
    DATABASE_URL: ${DATABASE_URL}
    PYRUS_LOGIN: ${PYRUS_LOGIN}
    PYRUS_SECURITY_KEY: ${PYRUS_SECURITY_KEY}
    # ... –º–Ω–æ–≥–æ –¥—Ä—É–≥–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
```

**–ü—Ä–æ–±–ª–µ–º–∞**: Docker Compose –∏—Å–∫–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º—ã, –∞ –Ω–µ –≤ —Ñ–∞–π–ª–µ `.env.production`

### –°—Ç–∞–ª–æ:
```yaml
backend:
  env_file:
    - .env.production
  environment:
    NODE_ENV: production
    PORT: 3000
```

**–†–µ—à–µ–Ω–∏–µ**: –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ `.env.production`

## 2. –£–ª—É—á—à–µ–Ω —Å–∫—Ä–∏–ø—Ç check-docker-compose.sh

### –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è env_file:
```bash
if grep -q "env_file:" docker-compose.prod.yml; then
    echo -e "${GREEN}‚úì${NC} –î–∏—Ä–µ–∫—Ç–∏–≤–∞ env_file –Ω–∞–π–¥–µ–Ω–∞"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
    ENV_FILES=$(grep -A 5 "env_file:" docker-compose.prod.yml | ...)

    while IFS= read -r env_file; do
        if [ -f "$env_file" ]; then
            echo -e "${GREEN}‚úì${NC} –§–∞–π–ª $env_file —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        else
            echo -e "${RED}‚úó${NC} –§–∞–π–ª $env_file –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            ((ERRORS++))
        fi
    done <<< "$ENV_FILES"
fi
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã `env_file` –≤ docker-compose.prod.yml
- ‚úÖ –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ `env_file`
- ‚úÖ –ù–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ —Å–µ–∫—Ü–∏–∏ `environment` –≤ `.env.production`

## 3. –£–ª—É—á—à–µ–Ω —Å–∫—Ä–∏–ø—Ç deploy.sh

### –î–æ–±–∞–≤–ª–µ–Ω –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –≤—ã–≤–æ–¥:
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   üìã STEP 0: PRE-DEPLOYMENT CHECKS        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –¥–µ–ø–ª–æ—é:
  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ docker-compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
  ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
```

### –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:
```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   ‚ùå –ü–†–û–í–ï–†–ö–ò –ù–ï –ü–†–û–ô–î–ï–ù–´!                ‚ïë
‚ïë   –î–µ–ø–ª–æ–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω                        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üí° –ß—Ç–æ –¥–µ–ª–∞—Ç—å:
  1. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤—ã—à–µ
  2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–Ω–æ–≤–æ: bash pre-deploy-check.sh
  3. –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π —Å–Ω–æ–≤–∞: bash deploy.sh
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫:
- –§–ª–∞–≥ `--skip-checks` —Ç–µ–ø–µ—Ä—å –≤—ã–≤–æ–¥–∏—Ç —è—Ä–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º –¥–µ–ø–ª–æ—è
- –ë–æ–ª–µ–µ —è–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ä–∏—Å–∫–∞—Ö

## 4. –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `TROUBLESHOOTING_PYRUS.md` —Å:
- –î–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã
- –ü—Ä–∏—á–∏–Ω–∞–º–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è
- –ü–æ—à–∞–≥–æ–≤—ã–º —Ä–µ—à–µ–Ω–∏–µ–º
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—é

## –ö–∞–∫ —ç—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
1. ‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å –≤ `.env.production`, –Ω–æ –Ω–µ –ø–æ–ø–∞–¥–∞—Ç—å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
2. ‚ùå –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ –≤—ã—è–≤–ª—è–ª —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É
3. ‚ùå –î–µ–ø–ª–æ–π –ø—Ä–æ—Ö–æ–¥–∏–ª "—É—Å–ø–µ—à–Ω–æ", –Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–ª–æ

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
1. ‚úÖ `env_file` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ `.env.production`
2. ‚úÖ –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª `.env.production` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
3. ‚úÖ –î–µ–ø–ª–æ–π –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –î–û –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
4. ‚úÖ –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

## Workflow –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–ª–æ–∫–∞–ª—å–Ω–æ):
```bash
# 1. –î–æ–±–∞–≤—å—Ç–µ –≤ .env.production.example —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
PYRUS_LOGIN=your-email@example.com  # Email –¥–ª—è –≤—Ö–æ–¥–∞ –≤ Pyrus

# 2. –î–æ–±–∞–≤—å—Ç–µ –≤ .env (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
PYRUS_LOGIN=real-value@example.com

# 3. –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è, –æ–±–Ω–æ–≤–∏—Ç–µ scripts/check-env.sh
check_var "PYRUS_LOGIN" ".env.production" false  # false = –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É
bash pre-deploy-check.sh

# –ï—Å–ª–∏ –≤—Å–µ –û–ö, –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp .env.production root@server:/root/artsvao/
```

### 3. –î–µ–ø–ª–æ–π:
```bash
# –°–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
bash deploy.sh

# –ò–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø!)
bash deploy.sh --skip-checks
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ:

```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh root@109.196.102.90

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
cd /root/artsvao
docker compose -f docker-compose.prod.yml exec backend printenv | grep PYRUS

# –î–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å—Å—è:
# PYRUS_LOGIN=nikita@artsvao.ru
# PYRUS_SECURITY_KEY=...
# PYRUS_FORM_ID=1022196
```

## –ß–µ–∫–ª–∏—Å—Ç –¥–ª—è –±—É–¥—É—â–∏—Ö –¥–µ–ø–ª–æ–µ–≤

–ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–ø–ª–æ–µ–º:

- [ ] –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –≤ git
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ `.env.production.example`
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.env.production` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ó–∞–ø—É—â–µ–Ω `bash pre-deploy-check.sh` –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–º–µ–µ—Ç backup (–µ—Å–ª–∏ –µ—Å—Ç—å –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
- [ ] –ó–∞–ø—É—â–µ–Ω `bash deploy.sh` (–ë–ï–ó --skip-checks)

## –§–∞–π–ª—ã, –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏

- `docker-compose.prod.yml` - –î–æ–±–∞–≤–ª–µ–Ω env_file, —É–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- `scripts/check-docker-compose.sh` - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ env_file
- `deploy.sh` - –£–ª—É—á—à–µ–Ω –≤—ã–≤–æ–¥ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- `.env.production` (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ) - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ PYRUS
- `TROUBLESHOOTING_PYRUS.md` - –ù–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `DEPLOY_IMPROVEMENTS.md` - –≠—Ç–æ—Ç —Ñ–∞–π–ª

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Docker Compose Environment Variables](https://docs.docker.com/compose/environment-variables/)
- [12 Factor App - Config](https://12factor.net/config)
- [Best Practices for Environment Variables](https://blog.bitsrc.io/best-practices-for-using-environment-variables-in-nodejs-and-docker-3b5b0c5ec0ab)
